<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftCommander — Builder (Deterministic v2)</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:16px; background:#0b1020; color:#e7ecff; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input,button{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:#e7ecff; font-weight:700; }
    button{ cursor:pointer; }
    .card{ margin-top:12px; border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:12px; background:rgba(255,255,255,.04); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre-wrap; }
    .ok{ color:#22c55e; } .warn{ color:#f59e0b; } .bad{ color:#ef4444; }
    small{ color: rgba(231,236,255,.65); }
  </style>
</head>
<body>
  <h1>Builder — Deterministic v2</h1>
  <div class="row">
    <label>Week (Sunday ISO): <input id="week" value="" /></label>
    <label>Watchdog ms: <input id="wd" value="45000" size="6" /></label>
    <button id="btnBuild">Build (compute)</button>
    <button id="btnTest">Determinism Test ×5</button>
    <button id="btnSave" disabled>Save to Store</button>
  </div>
  <div class="row" style="margin-top:6px;">
    <label>Store Base: <input id="store" value="https://schedule-cors-910cpr.brian-9ac.workers.dev" size="30" /></label>
    <label>Token (localStorage sc_token): <input id="token" value="" size="18" /></label>
    <small>Token optional for GET; required to SAVE.</small>
  </div>

  <div class="card">
    <div id="status"><span class="warn">Idle.</span></div>
  </div>

  <div class="card">
    <h3>Hashes</h3>
    <div class="mono" id="hashes">—</div>
  </div>

  <div class="card">
    <h3>Log</h3>
    <div class="mono" id="log">—</div>
  </div>

<script type="module">
function asArray(x){
  if (Array.isArray(x)) return x;
  if (x == null) return [];
  if (typeof x === "object"){
    if (Array.isArray(x.items)) return x.items;
    if (Array.isArray(x.payload)) return x.payload;
    if (Array.isArray(x.availability)) return x.availability;
  }
  return [];
}
import { buildPlannedSchedule, startOfWeekSundayUTC, isoDateUTC } from "./js/sc_resolver_v2.js?cb=1770514542";

const LS_TOKEN = "sc_token";

function $(id){ return document.getElementById(id); }
function setStatus(html){ $("status").innerHTML = html; }
function setLog(text){ $("log").textContent = text; }
function setHashes(text){ $("hashes").textContent = text; }

function todayWeekSunday(){
  const now = new Date();
  const utc = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
  const ws = startOfWeekSundayUTC(utc);
  return isoDateUTC(ws);
}

$("week").value = todayWeekSunday();
$("token").value = localStorage.getItem(LS_TOKEN) || "";

$("token").addEventListener("input", ()=>{
  localStorage.setItem(LS_TOKEN, $("token").value || "");
});

async function storeGet(kind){
  const base = $("store").value.trim();
  const url = new URL(base);
  url.searchParams.set("kind", kind);
  const token = localStorage.getItem(LS_TOKEN) || "";
  if (token) url.searchParams.set("token", token);
  const resp = await fetch(url.toString(), { cache:"no-store" });
  const text = await resp.text();
  let j=null; try{ j=JSON.parse(text);}catch(e){}
  if(!resp.ok) throw new Error(`GET ${kind} failed (${resp.status})`);
  return (j && typeof j==="object" && j.payload!==undefined) ? j.payload : (j ?? text);
}

async function storePut(kind, payload){
  const base = $("store").value.trim();
  const url = new URL(base);
  url.searchParams.set("kind", kind);
  const token = localStorage.getItem(LS_TOKEN) || "";
  if (!token) throw new Error("No token set. Provide token to save.");
  url.searchParams.set("token", token);
  const resp = await fetch(url.toString(), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ kind:"schedule", payload: payload })
  });
  if(!resp.ok) throw new Error(`PUT ${kind} failed (${resp.status})`);
  return await resp.json().catch(()=>({ok:true}));
}

function wallboardCompatibilityCheck(schedule){
  // schedule[dateIso][shift] where shift is AM/PM
  const dateKeys = Object.keys(schedule||{}).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  for (const d of dateKeys){
    const day = schedule[d];
    if (!day || typeof day !== "object") return `Day ${d} is not an object`;
    for (const sh of ["AM","PM"]){
      const slot = day[sh];
      if (slot == null) return `Missing ${d}.${sh}`;
      if (Array.isArray(slot)){
        if (slot.some(x=>x==null)) return `Null in ${d}.${sh} array`;
      } else if (typeof slot === "object") {
        for (const k of ["attendant","operator","third"]){
          if (!(k in slot)) return `Missing key ${d}.${sh}.${k}`;
          if (slot[k] == null) return `Null at ${d}.${sh}.${k}`;
        }
      } else {
        return `Invalid slot type at ${d}.${sh}`;
      }
    }
  }
  return null;
}

let lastResult = null;

async function loadInputs(){
  const [org, members, schedule, availability, units, seatTypes] = await Promise.all([
    storeGet("org_settings").catch(()=>({})),
    storeGet("members").catch(()=>([])),
    storeGet("schedule").catch(()=>({})),
    storeGet("availability").catch(()=>([])),
    storeGet("units").catch(()=>([])),
    storeGet("seat_types").catch(()=>([]))
  ]);
  return { org, members, schedule, availability, units, seatTypes };
}

async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

$("btnBuild").addEventListener("click", async ()=>{
  try{
    setStatus(`<span class="warn">Loading inputs…</span>`);
    const week = $("week").value.trim();
    const wd = Number($("wd").value)||45000;

    const { members, availability, units, seatTypes } = await loadInputs();

    setStatus(`<span class="warn">Computing schedule…</span>`);
    const res = buildPlannedSchedule({ weekStartISO: week, units, seatTypes, members, availability, watchdogMs: wd });

    const compatErr = wallboardCompatibilityCheck(res.wallboard || res.schedule);
    if (compatErr){
      $("btnSave").disabled = true;
      lastResult = null;
      setStatus(`<span class="bad">Compatibility FAIL:</span> ${compatErr}`);
      setLog(res.logs.map(l=>`[${l.type}] ${l.msg}`).join("\n"));
      return;
    }

    lastResult = res;
    $("btnSave").disabled = false;
    setStatus(`<span class="ok">OK:</span> computed ${Object.keys(res.schedule||{}).length} day(s) • partial=${res.partial}`);
    setLog(res.logs.map(l=>`[${l.type}] ${l.msg}`).join("\n"));
    setHashes("—");
  }catch(e){
    $("btnSave").disabled = true;
    lastResult = null;
    setStatus(`<span class="bad">Error:</span> ${e.message||String(e)}`);
  }
});

$("btnTest").addEventListener("click", async ()=>{
  try{
    setStatus(`<span class="warn">Running determinism test ×5…</span>`);
    const week = $("week").value.trim();
    const wd = Number($("wd").value)||45000;
    const { members, availability, units, seatTypes } = await loadInputs();

    const hashes = [];
    for (let i=0;i<5;i++){
      const res = buildPlannedSchedule({ weekStartISO: week, units, seatTypes, members, availability, watchdogMs: wd });
      const compatErr = wallboardCompatibilityCheck(res.wallboard || res.schedule);
      if (compatErr) throw new Error(`Compat failed on run ${i+1}: ${compatErr}`);
      const h = await sha256(JSON.stringify(res.schedule));
      hashes.push(h);
    }
    const uniq = Array.from(new Set(hashes));
    const pass = uniq.length === 1;
    setHashes(hashes.map((h,i)=>`${i+1}. ${h}`).join("\n") + `\n\nRESULT: ${pass?"PASS":"FAIL"}`);
    setStatus(pass ? `<span class="ok">Determinism PASS</span>` : `<span class="bad">Determinism FAIL</span>`);
  }catch(e){
    setStatus(`<span class="bad">Error:</span> ${e.message||String(e)}`);
  }
});

$("btnSave").addEventListener("click", async ()=>{
  try{
    if (!lastResult) throw new Error("Nothing to save. Build first.");
    setStatus(`<span class="warn">Saving schedule…</span>`);
    // Store expects payload wrapper sometimes; we’ll save { schedule, meta } like your wallboard reads
    const payload = {
      schedule: (lastResult.wallboard || lastResult.schedule),
      scheduleA: lastResult.schedule,
      meta: {
        health_v1: { days: {} },
        resolver_v2: { partial:lastResult.partial, reason:lastResult.reason || null, saved_at: new Date().toISOString() }
      }
    };
    await storePut("schedule", payload);
    setStatus(`<span class="ok">Saved to store.</span>`);
  }catch(e){
    setStatus(`<span class="bad">Save error:</span> ${e.message||String(e)}`);
  }
});
</script>
</body>
</html>







