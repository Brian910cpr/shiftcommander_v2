<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ShiftCommander — Member</title>
  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1428;
      --card:#0c1a34;
      --card2:#0b1730;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --text:#e9f1ff;
      --muted:rgba(233,241,255,.72);
      --muted2:rgba(233,241,255,.50);
      --green:#26d07c;
      --blue:#5c8dff;
      --red:#ff5d5d;
      --clear:rgba(233,241,255,.26);
      --shadow:0 16px 50px rgba(0,0,0,.35);
      --r:16px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1100px 700px at 35% -20%, #163a86 0%, rgba(22,58,134,0) 55%),
                  radial-gradient(900px 600px at 90% 0%, #2a0e6e 0%, rgba(42,14,110,0) 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Header */
    .top{
      position:sticky;
      top:0;
      z-index:20;
      background: linear-gradient(180deg, rgba(5,8,16,.92), rgba(5,8,16,.55));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topInner{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      margin-right:auto;
      white-space:nowrap;
    }
    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width: 320px;
    }
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 9px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 8px 26px rgba(0,0,0,.18);
    }
    .pill label{font-size:12px; color:var(--muted2)}
    select, input[type="date"]{
      background: transparent;
      color: var(--text);
      border: 0;
      outline: 0;
      font-size: 14px;
    }
    option{color:#000}
    .btn{
      cursor:pointer;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 700;
      box-shadow: 0 8px 26px rgba(0,0,0,.18);
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22)}
    .btn.secondary{font-weight:700; opacity:.95}

    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--clear);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 0 3px rgba(38,208,124,.16) }
    .dot.warn{ background: #f4c542; box-shadow: 0 0 0 3px rgba(244,197,66,.16) }

    /* Layout */
    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 14px 18px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .headline{
      display:flex;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .headline h2{
      margin:0;
      font-size: 16px;
      line-height:1.25;
      letter-spacing:.2px;
    }
    .headline .sub{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .headline .right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .statusPill{
      display:flex;
      align-items:center;
      gap:10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 8px 10px;
      min-height: 36px;
    }
    .statusPill .tiny{
      font-size:12px;
      color: var(--muted);
      max-width: 0; /* hide by default, keep tooltip */
      overflow:hidden;
      white-space:nowrap;
    }
    .statusPill.hasText .tiny{ max-width: 420px } /* use for debug if you ever want */
    .gridWrap{
      margin-top: 14px;
      overflow-x:auto;
      border-radius: var(--r);
    }

    /* Calendar grid */
    .cal{
      min-width: 980px; /* prevents off-screen clipping; scrolls instead */
      display:grid;
      grid-template-columns: 170px repeat(7, minmax(110px, 1fr));
      gap:10px;
      padding: 10px;
      background: rgba(0,0,0,.10);
      border: 1px solid var(--line);
      border-radius: var(--r);
    }
    .wkLabel{
      padding: 12px;
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.035);
      display:flex;
      flex-direction:column;
      gap:8px;
      justify-content:center;
      min-height: 92px;
    }
    .wkTag{
      display:inline-flex;
      width:fit-content;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.3px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .wkRange{
      font-size: 12px;
      color: var(--muted);
    }
    .wkRange b{color:var(--text)}
    .hdrCell{
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-weight: 900;
      letter-spacing:.3px;
      text-transform:uppercase;
      font-size: 12px;
      color: var(--text);
      text-align:center;
    }

    .dayCard{
      border-radius: var(--r2);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dayTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .dayNum{
      font-size: 26px;
      font-weight: 950;
      line-height:1;
      letter-spacing:.2px;
    }
    .dayMini{
      font-size: 11px;
      color: var(--muted2);
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .shiftRow{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .shiftBtn{
      border-radius: 12px;
      padding: 10px 8px;
      border: 2px dashed rgba(233,241,255,.22);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .shiftBtn:active{ transform: translateY(1px) }
    .shiftBtn.locked{ cursor: not-allowed; opacity:.55 }
    .shiftKey{ font-weight: 950; letter-spacing:.3px; font-size: 12px; }
    .shiftState{ font-size: 10px; color: var(--muted2); margin-top: 3px; letter-spacing:.2px; text-transform:uppercase; }
    .shiftBtn[data-state="preferred"]{ border-style: solid; border-color: rgba(38,208,124,.90) }
    .shiftBtn[data-state="available"]{ border-style: solid; border-color: rgba(92,141,255,.95) }
    .shiftBtn[data-state="nosched"]{ border-style: solid; border-color: rgba(255,93,93,.95) }
    .shiftBtn[data-state="clear"]{ border-style: dashed; border-color: rgba(233,241,255,.22) }

    .shiftBtn[data-state="worked"]{
      border-style: solid;
      border-color: rgba(233,241,255,.30);
      background: rgba(255,255,255,.03);
    }
    .shiftBtn[data-state="worked"] .shiftState{ color: rgba(233,241,255,.75) }

    /* Legend */
    .legend{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .legItem{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor: help;
      user-select:none;
      white-space:nowrap;
    }
    .swatch{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(233,241,255,.26);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .swatch.pref{ background: var(--green); box-shadow: 0 0 0 3px rgba(38,208,124,.16) }
    .swatch.av{ background: var(--blue); box-shadow: 0 0 0 3px rgba(92,141,255,.16) }
    .swatch.no{ background: var(--red); box-shadow: 0 0 0 3px rgba(255,93,93,.16) }
    .swatch.cl{ background: rgba(233,241,255,.26) }

    /* Modal (Repeat/Tools) */
    dialog{
      border:none;
      padding:0;
      border-radius: 18px;
      background: #0b1730;
      color: var(--text);
      width: min(720px, calc(100vw - 24px));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
    }
    dialog::backdrop{ background: rgba(0,0,0,.55) }
    .modalHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalHead h3{ margin:0; font-size: 15px }
    .modalBody{ padding: 14px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .row > *{ flex: 0 0 auto }
    .note{ font-size: 12px; color: var(--muted); line-height: 1.35 }
    .danger{ border-color: rgba(255,93,93,.55) }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(10,16,30,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 10px 12px;
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:999;
    }
    .toast.show{ opacity:1 }

    @media (max-width: 860px){
      .controls{ min-width: unset; width:100% }
      .cal{ min-width: 900px }
      .wkLabel{ min-height: 86px }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="topInner">
      <div class="brand">ShiftCommander — Member</div>

      <div class="controls">
        <div class="pill" title="Organization">
          <label>Org:</label>
          <span id="orgName" style="font-weight:900"></span>
        </div>

        <div class="pill" title="Select yourself">
          <label>Member:</label>
          <select id="memberSel"></select>
        </div>

        <button class="btn secondary" id="btnPrev">◀</button>
        <button class="btn secondary" id="btnThis">This Week</button>
        <button class="btn secondary" id="btnNext">▶</button>

        <div class="pill" title="Jump to a week start">
          <label>Week start:</label>
          <input id="weekPick" type="date"/>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="headline">
        <div>
          <h2>Set your availability</h2>
          <div class="sub">Tap AM/PM to cycle: Preferred → Available → Do not schedule → Clear.</div>
        </div>

        <div class="right">
          <div class="statusPill" id="savepill" title="Drive status">
            <span class="dot warn" id="driveDot"></span>
            <span class="tiny" id="driveTip">Checking…</span>
          </div>
          <button class="btn" id="btnTools">Repeat / Tools</button>
        </div>
      </div>

      <div class="gridWrap">
        <div class="cal" id="cal"></div>
      </div>

      <div class="legend" aria-label="Availability legend">
        <span class="legItem" title="Preferred — You WANT this shift.">
          <span class="swatch pref"></span> Preferred
        </span>
        <span class="legItem" title="Available — You CAN work this shift and will be considered if not filled by someone who PREFERS it (then weighted fairly).">
          <span class="swatch av"></span> Available
        </span>
        <span class="legItem" title="Do not schedule — You will not be considered for this shift.">
          <span class="swatch no"></span> Do not schedule
        </span>
        <span class="legItem" title="Clear / unset — No preference stated. You may still be considered only if no one prefers or is available (and fairness allows it).">
          <span class="swatch cl"></span> Clear
        </span>
      </div>
    </div>
  </div>

  <dialog id="toolsDlg">
    <div class="modalHead">
      <h3>Repeat / Tools</h3>
      <div style="margin-left:auto"></div>
      <button class="btn secondary" id="btnCloseDlg">Close</button>
    </div>
    <div class="modalBody">
      <div class="note">
        Most people repeat week-to-week. Use these to copy patterns forward, or set repeating rules later.
        (This stays quiet until you need it.)
      </div>
      <div style="height:12px"></div>

      <div class="row">
        <button class="btn" id="copyThisWeek">Copy <b>this</b> week → next week</button>
        <button class="btn" id="copyToAll">Copy <b>this</b> week → all shown weeks</button>
        <button class="btn danger" id="clearThisWeek">Clear <b>this</b> week</button>
      </div>

      <div style="height:10px"></div>
      <div class="note">
        Heads up: if you already hand-picked a specific future date, copying will <b>not overwrite</b> that date (it skips locked/manual dates).
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   Config
========================= */
const ORG_SETTINGS_URL = "/data/org_settings.json";
const MEMBERS_URL      = "/data/members.json";

/* Google Apps Script JSON store (you already deployed this) */
const STORE_URL = "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec";

/* lead window + display window */
const LEAD_DAYS = 21;          // suppress supervisor-style “Needs…” until 3 weeks out (member page still allows edits)
const WEEKS_SHOWN = 5;         // editing week + 4 upcoming

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);

function todayISO(){
  const t = new Date();
  return new Date(t.getFullYear(), t.getMonth(), t.getDate()).toISOString().slice(0,10);
}
function addDaysISO(dateISO, days){
  const d = new Date(dateISO + "T00:00:00");
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function weekStartISO(anyDateISO){
  // week starts Thu (ADR’s planning cadence)
  const d = new Date(anyDateISO + "T00:00:00");
  const dow = d.getDay(); // 0 Sun..6 Sat
  const THU = 4;
  const delta = (dow - THU + 7) % 7;
  d.setDate(d.getDate() - delta);
  return d.toISOString().slice(0,10);
}
function fmtMD(dateISO){
  // no year anywhere
  const d = new Date(dateISO + "T00:00:00");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return mm + "/" + dd;
}
function dayName(dateISO){
  // Thu, Fri, ...
  return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(dateISO+"T00:00:00").getDay()];
}
function isPast(dateISO){
  return dateISO < todayISO();
}
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"), 1600);
}

/* =========================
   Local + Remote State
========================= */
function lsKey(memberId){ return "sc_member_" + memberId; }
function lsMetaKey(memberId){ return "sc_member_meta_" + memberId; } // {dirty:boolean,lastPushISO,lastError:string}

function getLocal(memberId){
  try{ return JSON.parse(localStorage.getItem(lsKey(memberId)) || "{}"); }catch(e){ return {}; }
}
function setLocal(memberId, obj){
  localStorage.setItem(lsKey(memberId), JSON.stringify(obj));
}
function getMeta(memberId){
  try{ return JSON.parse(localStorage.getItem(lsMetaKey(memberId)) || "{}"); }catch(e){ return {}; }
}
function setMeta(memberId, meta){
  localStorage.setItem(lsMetaKey(memberId), JSON.stringify(meta));
}

async function storeGet(kind, memberId){
  const url = new URL(STORE_URL);
  url.searchParams.set("kind", kind);
  if(memberId) url.searchParams.set("memberId", memberId);
  // token is enforced server-side; for member page we rely on the script property token
  // (If you later require client token, we’ll add it to org_settings.json and read it here.)
  const r = await fetch(url.toString(), { method:"GET", cache:"no-store" });
  if(!r.ok) throw new Error("store GET " + r.status);
  return await r.json();
}

async function storePut(kind, memberId, payload){
  const body = { kind, memberId, payload };
  const r = await fetch(STORE_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body),
  });
  if(!r.ok) throw new Error("store POST " + r.status);
  return await r.json();
}

/* auto-sync: if we had edits while “offline”, push when online resumes */
async function trySync(memberId){
  const meta = getMeta(memberId);
  if(!meta.dirty) return true;

  try{
    const payload = getLocal(memberId);
    await storePut("member", memberId, payload);
    meta.dirty = false;
    meta.lastError = "";
    meta.lastPushISO = new Date().toISOString();
    setMeta(memberId, meta);
    setDriveStatus(true, meta);
    return true;
  }catch(e){
    meta.lastError = String(e.message || e);
    setMeta(memberId, meta);
    setDriveStatus(false, meta);
    return false;
  }
}

/* Drive status UI: only colors (green/yellow). Full meaning via hover tooltip. */
function setDriveStatus(ok, meta){
  const dot = $("driveDot");
  const tip = $("driveTip");
  const online = navigator.onLine !== false;

  dot.classList.remove("ok","warn");
  dot.classList.add(ok ? "ok" : "warn");

  // keep it SHORT (no wrapping). Details only in title/tooltip.
  let short = ok ? "Saved" : "Local";
  if(!online) short = "Offline";

  tip.textContent = short;

  // Full tooltip meaning:
  const parts = [];
  if(ok) parts.push("Saved to Drive.");
  else parts.push("Saved on this device. Will sync when online.");
  if(meta && meta.lastPushISO) parts.push("Last push: " + new Date(meta.lastPushISO).toLocaleString());
  if(!ok && meta && meta.lastError) parts.push("Reason: " + meta.lastError);
  if(!online) parts.push("No internet connection detected.");
  $("savepill").title = parts.join(" ");
}

/* =========================
   History (optional)
   Files live at /data/history/YYYY-MM.normalized.json (if present).
========================= */
const historyCache = new Map(); // "YYYY-MM" -> normalized month json

async function loadHistoryMonth(yyyyMM){
  if(historyCache.has(yyyyMM)) return historyCache.get(yyyyMM);
  try{
    const r = await fetch(`/data/history/${yyyyMM}.normalized.json`, { cache:"no-store" });
    if(!r.ok) throw new Error("history " + r.status);
    const j = await r.json();
    historyCache.set(yyyyMM, j);
    return j;
  }catch(e){
    historyCache.set(yyyyMM, null);
    return null;
  }
}
function memberWorked(historyMonth, dateISO, half, memberId){
  if(!historyMonth || !historyMonth.days || !historyMonth.days[dateISO]) return false;
  const d = historyMonth.days[dateISO];
  const obj = d[half];
  if(!obj) return false;
  // check any seat member_id match
  for(const k of Object.keys(obj)){
    const v = obj[k];
    if(v && typeof v === "object" && v.member_id && String(v.member_id) === String(memberId)){
      return true;
    }
  }
  return false;
}

/* =========================
   Availability Model
========================= */
const cycle = ["preferred","available","nosched","clear"];
const stateLabelTiny = {
  preferred:"Preferred",
  available:"Available",
  nosched:"Do not schedule",
  clear:"Clear",
  worked:"Worked"
};

function getStateFor(memberState, dateISO, half){
  return (memberState?.[dateISO]?.[half]) || "clear";
}
function setStateFor(memberState, dateISO, half, val){
  if(!memberState[dateISO]) memberState[dateISO] = {};
  memberState[dateISO][half] = val;
}

/* “manual lock” dates to prevent copy-overwrite:
   if user touched a specific date, we mark it locked in meta.locks[dateISO]=true */
function getLocks(memberId){
  const meta = getMeta(memberId);
  return meta.locks || {};
}
function setLocked(memberId, dateISO){
  const meta = getMeta(memberId);
  meta.locks = meta.locks || {};
  meta.locks[dateISO] = true;
  setMeta(memberId, meta);
}

/* =========================
   Render
========================= */
let orgSettings = null;
let members = [];
let memberId = null;
let editWeekStart = weekStartISO(todayISO());
let memberState = {}; // availability map
let locks = {}; // dateISO -> true
let suppressEditPast = true;

function weekRangeLabel(startISO){
  const end = addDaysISO(startISO, 6);
  return `${fmtMD(startISO)} – ${fmtMD(end)}`;
}

function weekTag(startISO){
  const t = todayISO();
  const end = addDaysISO(startISO, 6);
  if(end < t) return "Past";
  if(startISO <= t && t <= end) return "Editing";
  return "Upcoming";
}

function buildHeaderRow(container){
  // blank corner
  const corner = document.createElement("div");
  corner.className = "hdrCell";
  corner.style.opacity = ".85";
  corner.textContent = "Week";
  container.appendChild(corner);

  // day headers based on editWeekStart
  for(let i=0;i<7;i++){
    const dateISO = addDaysISO(editWeekStart, i);
    const h = document.createElement("div");
    h.className = "hdrCell";
    h.textContent = dayName(dateISO);
    container.appendChild(h);
  }
}

function buildWeekRow(container, startISO, idx){
  const tag = weekTag(startISO);

  const label = document.createElement("div");
  label.className = "wkLabel";
  const t = document.createElement("div");
  t.className = "wkTag";
  t.innerHTML = `<span class="dot ${tag==="Editing" ? "ok" : "warn"}"></span>${tag}`;
  const r = document.createElement("div");
  r.className = "wkRange";
  r.innerHTML = `<b>${weekRangeLabel(startISO)}</b>`;
  label.appendChild(t);
  label.appendChild(r);
  container.appendChild(label);

  for(let i=0;i<7;i++){
    const dateISO = addDaysISO(startISO, i);
    const day = document.createElement("div");
    day.className = "dayCard";

    const top = document.createElement("div");
    top.className = "dayTop";
    const num = document.createElement("div");
    num.className = "dayNum";
    num.textContent = String(new Date(dateISO+"T00:00:00").getDate());
    const mini = document.createElement("div");
    mini.className = "dayMini";
    mini.textContent = fmtMD(dateISO);
    top.appendChild(num);
    top.appendChild(mini);

    const row = document.createElement("div");
    row.className = "shiftRow";

    const isLockedPast = isPast(dateISO) && suppressEditPast;
    const isManualLocked = !!locks[dateISO];
    const editable = !isLockedPast;

    // optional history “worked” badge for past
    const monthKey = dateISO.slice(0,7);
    const hist = historyCache.get(monthKey) || null;

    for(const half of ["AM","PM"]){
      const btn = document.createElement("div");
      btn.className = "shiftBtn";
      btn.dataset.date = dateISO;
      btn.dataset.half = half;

      let state = getStateFor(memberState, dateISO, half);

      if(isPast(dateISO)){
        // If history says you worked, show that (read-only visual)
        if(hist && memberWorked(hist, dateISO, half, memberId)) state = "worked";
      }

      btn.dataset.state = state;
      btn.title = `${dayName(dateISO)} ${fmtMD(dateISO)} ${half} — ${stateLabelTiny[state] || state}`;

      if(!editable || state==="worked"){
        btn.classList.add("locked");
      }

      const key = document.createElement("div");
      key.className = "shiftKey";
      key.textContent = half;

      const st = document.createElement("div");
      st.className = "shiftState";
      // TINY labels only
      st.textContent = state==="clear" ? "" : (state==="nosched" ? "NO" : (state==="preferred" ? "PREF" : (state==="available" ? "AVL" : state.toUpperCase())));
      btn.appendChild(key);
      btn.appendChild(st);

      btn.addEventListener("click", async ()=>{
        if(!editable) return;
        if(btn.dataset.state === "worked") return;

        const cur = btn.dataset.state || "clear";
        const nxt = cycle[(cycle.indexOf(cur)+1) % cycle.length];
        btn.dataset.state = nxt;
        btn.title = `${dayName(dateISO)} ${fmtMD(dateISO)} ${half} — ${stateLabelTiny[nxt]}`;
        st.textContent = nxt==="clear" ? "" : (nxt==="nosched" ? "NO" : (nxt==="preferred" ? "PREF" : "AVL"));

        setStateFor(memberState, dateISO, half, nxt);
        setLocal(memberId, memberState);
        setLocked(memberId, dateISO);

        const meta = getMeta(memberId);
        meta.dirty = true;
        setMeta(memberId, meta);
        setDriveStatus(false, meta);

        // try push in background (doesn't block UI)
        const ok = await trySync(memberId);
        if(ok) toast("Saved");
      });

      row.appendChild(btn);
    }

    // subtle lock indicator if manual date exists (visual only)
    if(isManualLocked){
      day.style.borderColor = "rgba(233,241,255,.18)";
    }

    day.appendChild(top);
    day.appendChild(row);
    container.appendChild(day);
  }
}

async function render(){
  const cal = $("cal");
  cal.innerHTML = "";
  buildHeaderRow(cal);

  // preload history months for weeks shown (best-effort)
  const months = new Set();
  for(let w=0; w<WEEKS_SHOWN; w++){
    const ws = addDaysISO(editWeekStart, w*7);
    for(let i=0;i<7;i++) months.add(addDaysISO(ws,i).slice(0,7));
  }
  await Promise.all([...months].map(loadHistoryMonth));

  // stitch loaded history into cache (loadHistoryMonth stored null on failure)
  for(const m of months){
    if(!historyCache.has(m)){
      // loadHistoryMonth stores to cache, but in case it didn't:
      historyCache.set(m, null);
    }
  }

  for(let w=0; w<WEEKS_SHOWN; w++){
    buildWeekRow(cal, addDaysISO(editWeekStart, w*7), w);
  }
}

/* =========================
   Repeat / Tools
========================= */
function copyWeekPattern(srcWeekStartISO, dstWeekStartISO){
  // copies availability from src week -> dst week, but SKIPS manual locked dates
  for(let i=0;i<7;i++){
    const srcDay = addDaysISO(srcWeekStartISO, i);
    const dstDay = addDaysISO(dstWeekStartISO, i);
    if(locks[dstDay]) continue; // don't overwrite hand-picked dates
    for(const half of ["AM","PM"]){
      const v = getStateFor(memberState, srcDay, half);
      setStateFor(memberState, dstDay, half, v);
    }
  }
}
async function persistAfterBulkEdit(){
  setLocal(memberId, memberState);
  const meta = getMeta(memberId);
  meta.dirty = true;
  setMeta(memberId, meta);
  setDriveStatus(false, meta);
  await render();
  const ok = await trySync(memberId);
  if(ok) toast("Saved");
}
$("btnTools").addEventListener("click", ()=> $("toolsDlg").showModal());
$("btnCloseDlg").addEventListener("click", ()=> $("toolsDlg").close());

$("copyThisWeek").addEventListener("click", async ()=>{
  copyWeekPattern(editWeekStart, addDaysISO(editWeekStart, 7));
  await persistAfterBulkEdit();
  $("toolsDlg").close();
});
$("copyToAll").addEventListener("click", async ()=>{
  for(let w=1; w<WEEKS_SHOWN; w++){
    copyWeekPattern(editWeekStart, addDaysISO(editWeekStart, w*7));
  }
  await persistAfterBulkEdit();
  $("toolsDlg").close();
});
$("clearThisWeek").addEventListener("click", async ()=>{
  for(let i=0;i<7;i++){
    const day = addDaysISO(editWeekStart, i);
    if(locks[day]) continue; // skip manual locked dates (respect their intent)
    for(const half of ["AM","PM"]){
      setStateFor(memberState, day, half, "clear");
    }
  }
  await persistAfterBulkEdit();
  $("toolsDlg").close();
});

/* =========================
   Boot
========================= */
async function loadRequired(){
  const [orgR, memR] = await Promise.all([
    fetch(ORG_SETTINGS_URL, {cache:"no-store"}),
    fetch(MEMBERS_URL, {cache:"no-store"})
  ]);
  if(!orgR.ok) throw new Error("Fetch failed " + orgR.status + ": " + ORG_SETTINGS_URL);
  if(!memR.ok) throw new Error("Fetch failed " + memR.status + ": " + MEMBERS_URL);
  orgSettings = await orgR.json();
  members = await memR.json();

  $("orgName").textContent = orgSettings?.org_name || "Org";
  // member dropdown
  const sel = $("memberSel");
  sel.innerHTML = "";
  for(const m of members){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.last || ""}, ${m.first || ""} #${m.id}`;
    sel.appendChild(opt);
  }
  memberId = String(members?.[0]?.id || "");
  sel.value = memberId;
}

async function loadMember(){
  locks = getLocks(memberId);

  // start with local
  memberState = getLocal(memberId) || {};
  let meta = getMeta(memberId);

  // show “ok” if last push exists and not dirty
  const optimisticOk = !!meta.lastPushISO && !meta.dirty && (navigator.onLine !== false);
  setDriveStatus(optimisticOk, meta);

  // pull remote if available, but do NOT clobber local if local is dirty
  try{
    const remote = await storeGet("member", memberId);
    if(remote && remote.payload){
      if(!meta.dirty){
        memberState = remote.payload;
        setLocal(memberId, memberState);
      }
      meta.lastError = "";
      setMeta(memberId, meta);
      setDriveStatus(!meta.dirty, meta);
    }
  }catch(e){
    meta.lastError = String(e.message || e);
    setMeta(memberId, meta);
    setDriveStatus(false, meta);
  }

  // if we had dirty edits, try sync once on load
  await trySync(memberId);

  await render();
}

function setEditWeekStart(newStartISO){
  editWeekStart = weekStartISO(newStartISO);
  $("weekPick").value = editWeekStart;
  render();
}

$("memberSel").addEventListener("change", async (e)=>{
  memberId = String(e.target.value);
  await loadMember();
});

$("btnPrev").addEventListener("click", ()=>{
  setEditWeekStart(addDaysISO(editWeekStart, -7));
});
$("btnNext").addEventListener("click", ()=>{
  setEditWeekStart(addDaysISO(editWeekStart, 7));
});
$("btnThis").addEventListener("click", ()=>{
  setEditWeekStart(todayISO());
});
$("weekPick").addEventListener("change", (e)=>{
  if(e.target.value) setEditWeekStart(e.target.value);
});

// Online/offline events: if we come back online, push dirty edits automatically
window.addEventListener("online", ()=> { if(memberId) trySync(memberId); });
window.addEventListener("offline", ()=> { if(memberId){ const m=getMeta(memberId); setDriveStatus(false,m);} });

(async function boot(){
  try{
    await loadRequired();
    setEditWeekStart(todayISO());
    await loadMember();
  }catch(e){
    alert("Member page failed to load required data:\n\n" + (e.message || e));
    console.error(e);
  }
})();
</script>
</body>
</html>
