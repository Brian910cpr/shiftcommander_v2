<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShiftCommander â€” Member</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;margin:16px;}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button{font:inherit;padding:6px 8px}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px}
th{background:#f6f6f6;text-align:left}
.tag{font-size:11px;padding:2px 6px;border:1px solid #ccc;border-radius:999px}
.lock{background:#fff3cd;border-color:#ffe69c}
.small{font-size:12px;color:#666}
</style></head>
<body>
<h2>Member</h2>

<div class="row">
  <label>Store URL <input id="store" size="80" placeholder="https://script.google.com/macros/s/DEPLOY/exec"></label>
  <label>Token <input id="token" size="30" placeholder="TOKEN"></label>
  <label>Member <select id="memberSel"></select></label>
  <button id="saveCfg">Save</button>
</div>

<div class="row">
  <button id="loadUpcoming">Load Upcoming</button>
  <span class="small">Shows locked + published schedule (if available)</span>
</div>

<table id="upcoming">
  <thead><tr><th>Date</th><th>Shift</th><th>Unit</th><th>Seat</th><th>Status</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const LS_CFG="sc_cfg_v2";
function loadCfg(){
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  store.value = cfg.store || "";
  token.value = cfg.token || "";
}
function saveCfg(){
  localStorage.setItem(LS_CFG, JSON.stringify({store:store.value.trim(), token:token.value.trim()}));
}
saveCfgBtn.onclick = ()=>saveCfg();

function base(){
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  return (store.value.trim() || cfg.store || "").replace(/\/+$/,'');
}
function tok(){
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  return (token.value.trim() || cfg.token || "");
}
async function apiGet(kind, params={}){
  const u = new URL(base());
  u.searchParams.set("kind", kind);
  u.searchParams.set("token", tok());
  for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
  const r = await fetch(u.toString(), {cache:"no-store"});
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j || j.ok===false) throw new Error((j&&j.error)?j.error:`GET ${kind} failed`);
  return j.payload;
}

const store = document.getElementById("store");
const token = document.getElementById("token");
const memberSel = document.getElementById("memberSel");
const saveCfgBtn = document.getElementById("saveCfg");

let MEMBERS=[];
async function loadMembers(){
  const doc = await apiGet("members");
  MEMBERS = Array.isArray(doc.members) ? doc.members : (Array.isArray(doc)?doc:[]);
  memberSel.innerHTML = MEMBERS.map(m=>{
    const id=m.member_id;
    const n=((m.first_name||"")+" "+(m.last_name||"")).trim();
    return `<option value="${id}">${n} (${id})</option>`;
  }).join("");
}

function nextSunday(d){
  const x=new Date(d); x.setHours(0,0,0,0);
  const add=(7-x.getDay())%7; x.setDate(x.getDate()+add);
  return x;
}
function iso(d){ return d.toISOString().slice(0,10); }

async function loadUpcoming(){
  const mid = memberSel.value;
  const start = nextSunday(new Date());
  const weeks = 8;
  const rows = [];

  // locks (always available via API)
  for (let i=0;i<weeks;i++){
    const wk = new Date(start); wk.setDate(start.getDate() + i*7);
    const weekISO = iso(wk);
    const locksDoc = await apiGet("locks", {week:weekISO}).catch(()=>({locks:[]}));
    for (const lk of (locksDoc.locks||[])){
      if (lk.member_id !== mid) continue;
      rows.push({date:lk.date, shift:lk.shift, unit:lk.unit, seat:lk.seat, status:"locked"});
    }
  }

  // published schedule (optional if you serve it; ignore errors)
  try{
    const sched = await apiGet("schedule");
    const items = sched.items || sched.assignments || sched.rows || [];
    for (const a of items){
      if ((a.member_id||a.memberId) !== mid) continue;
      rows.push({date:a.date, shift:(a.shift||a.slot||""), unit:a.unit, seat:a.seat, status:"published"});
    }
  }catch(_e){}

  rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shift||"").localeCompare(b.shift||""));
  const tb = document.querySelector("#upcoming tbody");
  tb.innerHTML = rows.map(r=>`<tr>
    <td>${r.date||""}</td>
    <td>${r.shift||""}</td>
    <td>${r.unit||""}</td>
    <td>${r.seat||""}</td>
    <td>${r.status==="locked" ? '<span class="tag lock">locked</span>' : '<span class="tag">published</span>'}</td>
  </tr>`).join("");
}

document.getElementById("loadUpcoming").onclick = loadUpcoming;

loadCfg();
loadMembers();
</script>
</body></html>