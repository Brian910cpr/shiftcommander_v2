<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftCommander — Member</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e8eefc; --muted:#a7b3d6;
      --p:#7aa2ff; --good:#19c37d; --warn:#f7b955; --bad:#ff5c5c; --gray:#6b7aa7;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
      --bd: rgba(37,50,84,.9);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 15% 10%, #12224c 0%, var(--bg) 55%);
      color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.72);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(37,50,84,.75);}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .top{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    select,input,button{
      border-radius:12px;border:1px solid var(--bd);
      background:rgba(16,26,48,.9);color:var(--text);
      padding:10px 12px;outline:none;
    }
    button{cursor:pointer}
    button.primary{border-color:rgba(122,162,255,.8);box-shadow:0 0 0 1px rgba(122,162,255,.12) inset;}
    .pill{padding:8px 10px;border-radius:999px;background:rgba(22,32,71,.65);
      border:1px solid rgba(37,50,84,.85);color:var(--muted);font-size:12px;}
    .card{
      margin-top:14px;
      background:linear-gradient(180deg, rgba(16,26,48,.92), rgba(10,16,32,.92));
      border:1px solid rgba(37,50,84,.9);border-radius:var(--radius);box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px;border-bottom:1px solid rgba(37,50,84,.7);display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;background:rgba(15,23,48,.55)}
    .card .hd .k{font-weight:800}
    .card .hd .s{color:var(--muted);font-size:12px}
    .grid{
      display:grid;
      grid-template-columns: 140px repeat(7, 1fr);
      gap:10px;
      padding:14px;
    }
    .cellH{
      color:var(--muted);font-size:12px;padding:8px 10px;border-radius:12px;
      border:1px solid rgba(37,50,84,.6);background:rgba(16,26,48,.35);
    }
    .shiftLbl{
      display:flex;flex-direction:column;gap:6px;
      padding:10px;border-radius:14px;border:1px solid rgba(37,50,84,.75);
      background:rgba(16,26,48,.45);
    }
    .shiftLbl .d{font-weight:800}
    .shiftLbl .t{color:var(--muted);font-size:12px}
    .pick{
      border-radius:14px;border:1px solid rgba(37,50,84,.85);
      background:rgba(16,26,48,.55);
      padding:10px;min-height:64px;
      display:flex;flex-direction:column;justify-content:center;gap:6px;
      cursor:pointer; user-select:none;
      transition: transform .05s ease, border-color .1s ease;
    }
    .pick:active{transform:scale(.99)}
    .pick .state{font-weight:900;font-size:13px}
    .pick .hint{color:var(--muted);font-size:11px}
    .st-none{border-style:dashed;opacity:.85}
    .st-preferred{border-color: rgba(25,195,125,.65); box-shadow: 0 0 0 1px rgba(25,195,125,.10) inset}
    .st-available{border-color: rgba(122,162,255,.6); box-shadow: 0 0 0 1px rgba(122,162,255,.08) inset}
    .st-nosched{border-color: rgba(255,92,92,.65); box-shadow: 0 0 0 1px rgba(255,92,92,.10) inset}
    .legend{display:flex;gap:10px;flex-wrap:wrap;padding:0 14px 14px}
    .tag{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(37,50,84,.85);background:rgba(22,32,71,.55);font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--good)} .dot.b{background:var(--p)} .dot.r{background:var(--bad)} .dot.x{background:var(--gray)}
    @media (max-width:980px){
      .grid{grid-template-columns: 110px repeat(7, 1fr)}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>ShiftCommander — Member</h1>
        <div class="sub" id="status">Loading…</div>
      </div>
      <div class="row">
        <span class="pill" id="orgpill">Org: …</span>
        <select id="memberSel"></select>
        <button class="primary" id="btnToday">This Week</button>
        <button id="btnPrev">◀</button>
        <button id="btnNext">▶</button>
        <input type="date" id="weekStart" />
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="hd">
      <div>
        <div class="k">Set your availability</div>
        <div class="s">Tap any AM/PM block to cycle: Preferred → Available → Do not schedule → Clear.</div>
      </div>
      <div class="pill" id="savepill">Not saved yet…</div>
    </div>
    <div id="grid" class="grid"></div>
    <div class="legend">
      <div class="tag"><span class="dot g"></span> Preferred</div>
      <div class="tag"><span class="dot b"></span> Available</div>
      <div class="tag"><span class="dot r"></span> Do not schedule</div>
      <div class="tag"><span class="dot x"></span> Clear / unset</div>
    </div>
  </div>
</div>

<script>
/* ===================== Drive Store (Apps Script) ===================== */
const STORE = {
  url: "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec",
  token: "BC3BD023C58CB9B909CCDC6C8D4EDCE3EFFD1EC2BC2571F8A0D2B0F6974E6741"
};
async function storeGet(params){
  const u = new URL(STORE.url);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, String(v)));
  u.searchParams.set("token", STORE.token);
  const r = await fetch(u.toString(), { cache: "no-store" });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store GET failed");
  return j.payload;
}
async function storePost(body){
  const r = await fetch(STORE.url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ ...body, token: STORE.token })
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store POST failed");
  return j;
}
function debounce(fn, ms=600){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ===================== Local data paths ===================== */
const PATHS = {
  org: "./data/org_settings.json",
  members: "./data/members.json"
};

function $(id){return document.getElementById(id);}
function fmtISO(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function parseISO(s){const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d);}
function addDays(d,n){const x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x;}
function startOfWeekThursday(anyDate){
  const target=4; // Thu
  const d=new Date(anyDate.getFullYear(), anyDate.getMonth(), anyDate.getDate());
  const dow=d.getDay();
  const delta=(dow-target+7)%7;
  return addDays(d,-delta);
}

let ORG=null, MEMBERS=null;
let CURRENT_WEEK_START = startOfWeekThursday(new Date());
let memberId = null;

// Member store model:
// { member_id:"123", selections: { "YYYY-MM-DD": { "AM":"preferred|available|nosched|null", "PM":... } }, updatedAt:"..." }
let memberStore = { selections:{} };

async function fetchJSON(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(`Fetch failed ${r.status}: ${url}`);
  return await r.json();
}

function setStatus(msg){ $("status").textContent = msg; }
function setSave(msg){ $("savepill").textContent = msg; }

const pushMember = debounce(async ()=>{
  if(!memberId) return;
  try{
    memberStore.member_id = String(memberId);
    memberStore.updatedAt = new Date().toISOString();
    localStorage.setItem("sc_member_"+memberId, JSON.stringify(memberStore));
  }catch{}
  try{
    await storePost({ kind:"member", memberId:String(memberId), payload: memberStore });
    setSave("Saved to Drive");
  }catch(e){
    console.warn("Drive save failed:", e);
    setSave("Saved locally (Drive unavailable)");
  }
}, 650);

function getState(dateISO, shift){
  const day = memberStore.selections?.[dateISO];
  if(!day) return null;
  return day[shift] ?? null;
}
function setState(dateISO, shift, value){
  memberStore.selections = memberStore.selections || {};
  memberStore.selections[dateISO] = memberStore.selections[dateISO] || { AM:null, PM:null };
  memberStore.selections[dateISO][shift] = value;
  pushMember();
}

function cycleState(cur){
  // Preferred → Available → NoSched → Clear
  if(cur === "preferred") return "available";
  if(cur === "available") return "nosched";
  if(cur === "nosched") return null;
  return "preferred";
}

function stateLabel(s){
  if(s==="preferred") return "Preferred";
  if(s==="available") return "Available";
  if(s==="nosched") return "Do not schedule";
  return "Unset";
}
function stateClass(s){
  if(s==="preferred") return "st-preferred";
  if(s==="available") return "st-available";
  if(s==="nosched") return "st-nosched";
  return "st-none";
}

function render(){
  $("weekStart").value = fmtISO(CURRENT_WEEK_START);
  const grid = $("grid");
  grid.innerHTML = "";

  const dowNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  // Header row
  grid.appendChild(cellH(""));
  for(let i=0;i<7;i++){
    const d=addDays(CURRENT_WEEK_START,i);
    grid.appendChild(cellH(`${dowNames[d.getDay()]}<br><span style="color:var(--muted)">${fmtISO(d)}</span>`));
  }

  // AM row
  grid.appendChild(shiftLbl("AM"));
  for(let i=0;i<7;i++){
    const d=addDays(CURRENT_WEEK_START,i);
    const ds=fmtISO(d);
    grid.appendChild(pickCell(ds,"AM"));
  }

  // PM row
  grid.appendChild(shiftLbl("PM"));
  for(let i=0;i<7;i++){
    const d=addDays(CURRENT_WEEK_START,i);
    const ds=fmtISO(d);
    grid.appendChild(pickCell(ds,"PM"));
  }
}

function cellH(html){
  const div=document.createElement("div");
  div.className="cellH";
  div.innerHTML=html;
  return div;
}
function shiftLbl(label){
  const div=document.createElement("div");
  div.className="shiftLbl";
  div.innerHTML = `<div class="d">${label}</div><div class="t">tap to set</div>`;
  return div;
}
function pickCell(dateISO, shift){
  const cur = getState(dateISO, shift);
  const div=document.createElement("div");
  div.className = `pick ${stateClass(cur)}`;
  div.innerHTML = `<div class="state">${stateLabel(cur)}</div><div class="hint">${dateISO} ${shift}</div>`;
  div.addEventListener("click", ()=>{
    const next = cycleState(getState(dateISO,shift));
    setState(dateISO, shift, next);
    render();
    setSave("Saving…");
  });
  return div;
}

async function loadMember(id){
  memberId = String(id);
  setSave("Loading…");

  // Drive first
  try{
    const remote = await storeGet({ kind:"member", memberId });
    if(remote && typeof remote === "object"){
      memberStore = remote;
      try{ localStorage.setItem("sc_member_"+memberId, JSON.stringify(memberStore)); }catch{}
      setSave("Loaded from Drive");
      render();
      return;
    }
  }catch(e){
    console.warn("Drive load failed:", e);
  }

  // local fallback
  try{
    const ls = JSON.parse(localStorage.getItem("sc_member_"+memberId) || "null");
    if(ls && typeof ls === "object"){
      memberStore = ls;
      setSave("Loaded locally (Drive unavailable)");
      render();
      return;
    }
  }catch{}

  memberStore = { selections:{} };
  setSave("New (nothing saved yet)");
  render();
}

async function boot(){
  try{
    setStatus("Loading org + members…");
    ORG = await fetchJSON(PATHS.org);
    MEMBERS = await fetchJSON(PATHS.members);
    $("orgpill").textContent = `Org: ${ORG?.org?.name || "Unknown"}`;

    const sel = $("memberSel");
    sel.innerHTML = "";
    (MEMBERS?.members || [])
      .filter(m => m.active !== false)
      .sort((a,b)=> (a.last_name||"").localeCompare(b.last_name||""))
      .forEach(m=>{
        const opt=document.createElement("option");
        opt.value = String(m.member_id);
        opt.textContent = `${m.last_name}, ${m.first_name} #${m.member_id}`;
        sel.appendChild(opt);
      });

    sel.addEventListener("change", ()=>loadMember(sel.value));

    $("btnToday").addEventListener("click", ()=>{
      CURRENT_WEEK_START = startOfWeekThursday(new Date());
      render();
    });
    $("btnPrev").addEventListener("click", ()=>{
      CURRENT_WEEK_START = addDays(CURRENT_WEEK_START, -7);
      render();
    });
    $("btnNext").addEventListener("click", ()=>{
      CURRENT_WEEK_START = addDays(CURRENT_WEEK_START, +7);
      render();
    });
    $("weekStart").addEventListener("change", (e)=>{
      CURRENT_WEEK_START = startOfWeekThursday(parseISO(e.target.value));
      render();
    });

    setStatus("Ready.");
    CURRENT_WEEK_START = startOfWeekThursday(new Date());
    render();

    // default to first member
    if(sel.options.length){
      await loadMember(sel.value);
    }

  }catch(err){
    console.error(err);
    setStatus("ERROR: " + err.message);
    alert("Member page failed to load:\n\n" + err.message);
  }
}

boot();
</script>
</body>
</html>
