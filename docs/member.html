<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander — Member Availability</title>

<style>
:root{
  --bg:#0b1020;
  --card:#111a33;
  --line:rgba(255,255,255,.12);
  --text:#eaf1ff;
  --muted:rgba(234,241,255,.55);

  --pref:#2bd27e;
  --avail:#5c8dff;
  --no:#ff5d5d;

  /* visible neutral (NOT transparent) */
  --clear: rgba(255,255,255,.18);
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}

/* Header */
header{
  position:sticky;top:0;z-index:10;
  background:linear-gradient(180deg,#050814,#050814cc);
  border-bottom:1px solid var(--line);
  padding:10px 14px;
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}

header .pill{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:13px;
  white-space:nowrap;
  flex-shrink:0;
}

header select{
  min-width:220px;
  font-size:14px;
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:6px 8px;
}

/* Mode pill */
#modePill{
  cursor:pointer;
  user-select:none;
}
#modePill b{color:rgba(234,241,255,.92)}

/* Drive save pill */
.savePill{
  display:flex; align-items:center; gap:10px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  border-radius:999px;
  padding:6px 10px;
  min-height:34px;
  cursor: default;
  margin-left:auto;
  max-width: 160px;
}
.savePill .tiny{
  font-size:12px;
  color: rgba(234,241,255,.70);
  min-width:0;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  line-height:1;
}

.dot{
  width:10px; height:10px; border-radius:999px;
  background: rgba(233,241,255,.26);
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.dot.ok{
  background:#2bd27e;
  box-shadow: 0 0 0 3px rgba(43,210,126,.16);
}
.dot.warn{
  background:#f4c542;
  box-shadow: 0 0 0 3px rgba(244,197,66,.16);
}

main{ padding:12px; }

/* Bulk panel (drawer) */
.bulkPanel{
  margin: 0 0 12px;
  background: rgba(255,255,255,.045);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 10px 10px 12px;
}
.bulkRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bulkTitle{font-weight:900;font-size:13px}
.bulkHint{color:var(--muted);font-size:12px}

.bulkGrid{
  margin-top:8px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-end;
}
.bulkField{display:flex;flex-direction:column;gap:4px}
.bulkField span{font-size:11px;color:var(--muted)}
.bulkField select, .bulkField input{
  background: rgba(255,255,255,.04);
  color: var(--text);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 10px;
  padding: 6px 8px;
  min-width: 160px;
}

.bulkBtns{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
.bbtn{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 7px 10px;
  border-radius: 10px;
  font-weight: 900;
  font-size: 12px;
  cursor: pointer;
}
.bbtn:hover{border-color:rgba(255,255,255,.25)}
.bbtn.primary{background: rgba(92,141,255,.18); border-color: rgba(92,141,255,.35)}
.bbtn.danger{background: rgba(255,93,93,.16); border-color: rgba(255,93,93,.30)}

.bulkNote{
  margin-top:8px;
  font-size:11px;
  color: rgba(234,241,255,.60);
  line-height:1.25;
}

/* MONTH LAYOUT */
.monthRow{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:12px;
  margin-bottom:12px;
}

.month{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px;
}

.month h3{
  margin:2px 0 6px;
  font-size:14px;
  font-weight:900;
  text-align:center;
}

.dow{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  font-size:10px;
  color:var(--muted);
  text-align:center;
  margin-bottom:4px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  align-content:start;
}

/* DAY CELLS — HARD LOCKED, NUMBER BESIDE PILLS */
.day{
  height:30px;
  border:1px solid var(--line);
  border-radius:10px;
  padding:3px 4px;
  display:flex;
  flex-direction:row;
  align-items:center;
  gap:6px;
}
.day.blank{border:none;background:none}
.day.past{opacity:.35;pointer-events:none}

/* day number */
.dayNum{
  width:16px;
  text-align:right;
  font-size:11px;
  font-weight:900;
  line-height:1;
  cursor:pointer;
}

/* pill stack */
.bars{
  margin-top:0;
  display:flex;
  flex-direction:column;
  gap:3px;
  align-items:flex-start;
}

/* pills: thicker + half-length */
.bar{
  position:relative;
  width:34px;
  height:10px;
  border-radius:999px;
  cursor:pointer;

  background: var(--clear);
  border: 1px solid rgba(255,255,255,.25);

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:9px;
  font-weight:900;
  line-height:1;
  letter-spacing:0.2px;
  color: rgba(255,255,255,.80);
  user-select:none;
}
.bar::after{ content: attr(data-label); }

/* Explicit states */
.bar.pref{ background:var(--pref); border-color:var(--pref); }
.bar.avail{ background:var(--avail); border-color:var(--avail); }
.bar.no{ background:var(--no); border-color:var(--no); }

/* Text on colored fills */
.bar.pref, .bar.avail, .bar.no{ color: rgba(0,0,0,.70); }

/* Clear is quieter but visible */
.bar:not(.pref):not(.avail):not(.no){ opacity:.75; }
</style>
</head>

<body>

<header>
  <div class="pill">Availability</div>

  <div class="pill">
    Member:
    <!-- IMPORTANT: option values should be stable member IDs -->
    <select id="member">
      <option value="203">Lynnsey Benson</option>
      <option value="brian">Brian Ennis</option>
    </select>
  </div>

  <div class="pill" id="modePill" title="Toggle Bulk Push tools">
    Mode: <b id="modeLabel">Fine-Tune</b>
  </div>

  <div class="savePill" id="savepill" title="Checking…">
    <span class="dot warn" id="driveDot"></span>
    <span class="tiny" id="driveTip">Checking…</span>
  </div>
</header>

<main>
  <!-- Bulk drawer -->
  <div id="bulkPanel" class="bulkPanel" style="display:none;">
    <div class="bulkRow">
      <div class="bulkTitle">Quick Set (Bulk)</div>
      <div class="bulkHint">Stamp a baseline fast, then fine-tune on the calendar below.</div>
    </div>

    <div class="bulkGrid">
      <label class="bulkField">
        <span>Pattern</span>
        <select id="bulkPattern">
          <option value="week1">1-Week Pattern (repeat)</option>
          <option value="week2">2-Week Alternating</option>
        </select>
      </label>

      <label class="bulkField">
        <span>From</span>
        <input id="bulkFrom" type="date">
      </label>

      <label class="bulkField">
        <span>To</span>
        <input id="bulkTo" type="date">
      </label>

      <div class="bulkBtns">
        <button id="btnCopyFwd" class="bbtn" type="button">Copy this week → Next</button>
        <button id="btnApplyRange" class="bbtn primary" type="button">Apply to Range</button>
        <button id="btnClearRange" class="bbtn danger" type="button">Clear Range</button>
      </div>
    </div>

    <div class="bulkNote" id="bulkNote">
      Bulk uses your <b>current week (Thu→Wed)</b> as the template.
      Click the day-number to set a full-day (AM+PM) state quickly, then stamp it.
    </div>
  </div>

  <!-- Calendar -->
  <div id="months"></div>
</main>

<script>
/* ===================== DRIVE STORE CONFIG (PUT IT HERE) ===================== */
const STORE = {
  url: "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec",
  token: "BC3BD023C58CB9B909CCDC6C8D4EDCE3EFFD1EC2BC2571F8A0D2B0F6974E6741"
};

/* ===================== CALENDAR CONFIG ===================== */
const MONTHS_AHEAD = 6;
const STATES = ["clear","pref","avail","no"];
const today = new Date();

/* In-memory state: dateISO -> { am, pm } */
const state = {}; // { "YYYY-MM-DD": {am, pm} }

/* Helpers */
function iso(d){ return d.toISOString().slice(0,10); }
function parseISO(s){ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function addDays(d,n){ const x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
function cycle(s){ return STATES[(STATES.indexOf(s)+1)%STATES.length]; }
function isPast(isoDate){ return isoDate < iso(new Date()); }
function getActiveMemberId(){
  const sel = document.getElementById("member");
  return sel ? String(sel.value || "").trim() : "default";
}

/* Week anchor: Thursday-start week (Thu→Wed) */
function startOfWeekThursday(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dow = x.getDay(); // 0 Sun .. 6 Sat
  const target = 4; // Thu
  const delta = (dow - target + 7) % 7;
  return addDays(x, -delta);
}

/* ===================== STORE HELPERS (same style as wallboard) ===================== */
async function storeGet(params){
  const u = new URL(STORE.url);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, String(v)));
  u.searchParams.set("token", STORE.token);
  const r = await fetch(u.toString(), { cache:"no-store" });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store GET failed");
  return j.payload;
}

async function storePut(body){
  const r = await fetch(STORE.url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ token: STORE.token, ...body })
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store PUT failed");
  return j.payload;
}

/* ===================== SAVE PILL ===================== */
function setDrivePill({state, label, tooltip}){
  const dot = document.getElementById("driveDot");
  const tip = document.getElementById("driveTip");
  const pill = document.getElementById("savepill");
  if(!dot || !tip || !pill) return;

  dot.classList.remove("ok","warn");
  dot.classList.add(state === "ok" ? "ok" : "warn");

  tip.textContent = label;
  pill.title = tooltip || label;
}

/* ===================== AVAILABILITY PERSISTENCE (Local + Drive) ===================== */
const AV_KIND = "member_availability";
const LS_PREFIX = "sc:avail:";
const LS_META_PREFIX = "sc:availmeta:";

function nowISO(){ return new Date().toISOString(); }
function lsKey(memberId){ return LS_PREFIX + memberId; }
function lsMetaKey(memberId){ return LS_META_PREFIX + memberId; }

function getLocalPayload(memberId){
  try{
    const raw = localStorage.getItem(lsKey(memberId));
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function setLocalPayload(memberId, payload){
  localStorage.setItem(lsKey(memberId), JSON.stringify(payload));
}
function getMeta(memberId){
  try{
    const raw = localStorage.getItem(lsMetaKey(memberId));
    return raw ? JSON.parse(raw) : { dirty:false, lastPushISO:null, lastError:null };
  }catch(e){
    return { dirty:false, lastPushISO:null, lastError:null };
  }
}
function setMeta(memberId, meta){
  localStorage.setItem(lsMetaKey(memberId), JSON.stringify(meta));
}

function applyPayloadToState(payload){
  if(!payload || !payload.days) return;
  for(const [dateISO, v] of Object.entries(payload.days)){
    state[dateISO] ||= { am:"clear", pm:"clear" };
    if(v && typeof v === "object"){
      if(v.am) state[dateISO].am = v.am;
      if(v.pm) state[dateISO].pm = v.pm;
    }
  }
}

let syncTimer = null;

function markDirty(memberId){
  const meta = getMeta(memberId);
  meta.dirty = true;
  meta.lastError = null;
  setMeta(memberId, meta);

  setDrivePill({
    state:"warn",
    label:"Saving…",
    tooltip:"Changes saved locally. Syncing to Drive…"
  });
}

function scheduleSync(memberId){
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(()=> trySync(memberId), 650);
}

async function trySync(memberId){
  const meta = getMeta(memberId);
  if(!meta.dirty) return;

  // Always keep local current
  const payload = { updated_at: nowISO(), days: state };
  setLocalPayload(memberId, payload);

  if(!navigator.onLine){
    setDrivePill({
      state:"warn",
      label:"Saved locally",
      tooltip:"Offline. Saved on this device and will sync when back online."
    });
    return;
  }

  try{
    await storePut({ kind: AV_KIND, member_id: memberId, payload });

    meta.dirty = false;
    meta.lastPushISO = nowISO();
    meta.lastError = null;
    setMeta(memberId, meta);

    setDrivePill({
      state:"ok",
      label:"Saved",
      tooltip:`Synced to Drive.\nLast sync: ${meta.lastPushISO}`
    });
  }catch(err){
    meta.lastError = String(err.message || err);
    setMeta(memberId, meta);
    setDrivePill({
      state:"warn",
      label:"Saved locally",
      tooltip:`Drive sync failed.\n${meta.lastError}\nStill saved locally.`
    });
  }
}

function onAvailabilityChanged(){
  const memberId = getActiveMemberId();
  markDirty(memberId);
  scheduleSync(memberId);
}

async function loadAvailability(memberId){
  // local first
  const local = getLocalPayload(memberId);
  if(local){
    applyPayloadToState(local);
    setDrivePill({ state:"warn", label:"Loaded", tooltip:"Loaded locally. Checking Drive…" });
  }else{
    setDrivePill({ state:"warn", label:"Checking…", tooltip:"Checking Drive for saved availability…" });
  }

  // drive
  try{
    const remote = await storeGet({ kind: AV_KIND, member_id: memberId });
    if(remote){
      applyPayloadToState(remote);
      setLocalPayload(memberId, remote);
      const meta = getMeta(memberId);
      meta.dirty = false;
      meta.lastPushISO = nowISO();
      meta.lastError = null;
      setMeta(memberId, meta);

      setDrivePill({ state:"ok", label:"Saved", tooltip:"Loaded from Drive and ready." });
    }else{
      setDrivePill({ state:"ok", label:"Saved", tooltip:"No Drive record yet — starting fresh." });
    }
  }catch(err){
    setDrivePill({
      state:"warn",
      label:"Local only",
      tooltip:`Couldn’t reach Drive.\n${err.message || err}\nWorking locally.`
    });
  }
}
window.addEventListener("online", ()=> trySync(getActiveMemberId()));

/* ===================== UI BUILD ===================== */
function build(){
  const wrap = document.getElementById("months");
  wrap.innerHTML="";

  let row;
  for(let i=0;i<MONTHS_AHEAD;i++){
    if(i%2===0){
      row=document.createElement("div");
      row.className="monthRow";
      wrap.appendChild(row);
    }
    row.appendChild(buildMonth(i));
  }
}

function buildMonth(offset){
  const d = new Date(today.getFullYear(), today.getMonth()+offset, 1);
  const m = d.getMonth(), y = d.getFullYear();

  const month = document.createElement("div");
  month.className="month";

  month.innerHTML = `
    <h3>${d.toLocaleString(undefined,{month:"long",year:"numeric"})}</h3>
    <div class="dow">${["S","M","T","W","T","F","S"].map(x=>`<div>${x}</div>`).join("")}</div>
    <div class="grid"></div>
  `;

  const grid = month.querySelector(".grid");
  const start = new Date(y,m,1).getDay();
  const days  = new Date(y,m+1,0).getDate();

  for(let i=0;i<start;i++) grid.appendChild(blank());

  for(let day=1; day<=days; day++){
    const dateISO = iso(new Date(y,m,day));
    grid.appendChild(dayCell(dateISO, day));
  }
  return month;
}

function blank(){
  const d=document.createElement("div");
  d.className="day blank";
  return d;
}

function dayCell(dateISO, day){
  state[dateISO] ||= { am:"clear", pm:"clear" };

  const d=document.createElement("div");
  d.className="day";
  if(isPast(dateISO)) d.classList.add("past");

  const num=document.createElement("div");
  num.className="dayNum";
  num.textContent=day;

  // Clicking the number sets BOTH AM and PM (your “24” shortcut)
  num.onclick=()=>{
    const next = cycle(state[dateISO].am);
    state[dateISO].am = next;
    state[dateISO].pm = next;
    render();
    onAvailabilityChanged();
  };

  const bars=document.createElement("div");
  bars.className="bars";

  const am=bar(()=>{
    state[dateISO].am = cycle(state[dateISO].am);
    render();
    onAvailabilityChanged();
  },"AM");

  const pm=bar(()=>{
    state[dateISO].pm = cycle(state[dateISO].pm);
    render();
    onAvailabilityChanged();
  },"PM");

  bars.append(am, pm);
  d.append(num, bars);

  function render(){
    am.className = `bar ${state[dateISO].am}`;
    pm.className = `bar ${state[dateISO].pm}`;
  }
  render();
  return d;
}

function bar(fn, label){
  const b=document.createElement("div");
  b.className="bar";
  b.dataset.label = label;
  b.onclick = fn;
  return b;
}

/* ===================== MODE TOGGLE (Bulk drawer) ===================== */
let bulkOpen = false;
function setMode(open){
  bulkOpen = open;
  document.getElementById("bulkPanel").style.display = bulkOpen ? "block" : "none";
  document.getElementById("modeLabel").textContent = bulkOpen ? "Bulk Push" : "Fine-Tune";
  document.getElementById("modePill").title =
    bulkOpen
      ? "Bulk Push is open. Stamp patterns, then fine-tune on the calendar."
      : "Fine-Tune mode. Click to open Bulk Push tools.";
}
document.getElementById("modePill")?.addEventListener("click", ()=> setMode(!bulkOpen));
setMode(false);

/* ===================== BULK ACTIONS (writes into SAME state model) ===================== */
function ensureDay(dateISO){
  state[dateISO] ||= { am:"clear", pm:"clear" };
  return state[dateISO];
}

function setRangeDefaults(){
  // Default range: next 28 days (starting tomorrow)
  const from = addDays(new Date(), 1);
  const to   = addDays(from, 27);
  document.getElementById("bulkFrom").value = iso(from);
  document.getElementById("bulkTo").value   = iso(to);
}

function templateWeekA(){
  // Current week anchored Thu→Wed, uses whatever is currently in state
  const start = startOfWeekThursday(new Date());
  const out = [];
  for(let i=0;i<7;i++){
    const ds = iso(addDays(start, i));
    const v = ensureDay(ds);
    out.push({ date: ds, am: v.am, pm: v.pm });
  }
  return out;
}

function templateWeekB(){
  // Next week anchored Thu→Wed
  const start = addDays(startOfWeekThursday(new Date()), 7);
  const out = [];
  for(let i=0;i<7;i++){
    const ds = iso(addDays(start, i));
    const v = ensureDay(ds);
    out.push({ date: ds, am: v.am, pm: v.pm });
  }
  // If it's totally blank, it's okay — it means your alternating week isn’t defined yet.
  return out;
}

function copyWeekForward(){
  const startA = startOfWeekThursday(new Date());
  const startB = addDays(startA, 7);

  for(let i=0;i<7;i++){
    const src = iso(addDays(startA, i));
    const dst = iso(addDays(startB, i));
    const v = ensureDay(src);
    state[dst] = { am: v.am, pm: v.pm };
  }
}

function applyPatternToRange(){
  const fromISO = document.getElementById("bulkFrom").value;
  const toISO   = document.getElementById("bulkTo").value;
  if(!fromISO || !toISO) return;

  const from = parseISO(fromISO);
  const to   = parseISO(toISO);
  if(to < from) return;

  const pattern = document.getElementById("bulkPattern").value;

  const A = templateWeekA();
  const B = templateWeekB();

  const baseStart = startOfWeekThursday(from);

  for(let d = new Date(from.getFullYear(), from.getMonth(), from.getDate());
       d <= to;
       d = addDays(d,1)){

    const ds = iso(d);

    // Find which week block this day belongs to, relative to baseStart
    const weekStart = startOfWeekThursday(d);
    const weekIndex = Math.floor((weekStart.getTime() - baseStart.getTime()) / (7*24*60*60*1000));

    const dayIndex = Math.floor((d.getTime() - weekStart.getTime()) / (24*60*60*1000)); // 0..6

    let src;
    if(pattern === "week2"){
      src = (weekIndex % 2 === 0) ? A[dayIndex] : B[dayIndex];
    }else{
      src = A[dayIndex];
    }

    state[ds] = { am: src.am, pm: src.pm };
  }
}

function clearRange(){
  const fromISO = document.getElementById("bulkFrom").value;
  const toISO   = document.getElementById("bulkTo").value;
  if(!fromISO || !toISO) return;

  const from = parseISO(fromISO);
  const to   = parseISO(toISO);
  if(to < from) return;

  for(let d = new Date(from.getFullYear(), from.getMonth(), from.getDate());
       d <= to;
       d = addDays(d,1)){
    const ds = iso(d);
    state[ds] = { am:"clear", pm:"clear" };
  }
}

function commitBulkChange(){
  // Re-render UI + save once (debounced sync handles the rest)
  build();
  onAvailabilityChanged();
}

/* Wire buttons */
document.getElementById("btnCopyFwd")?.addEventListener("click", ()=>{
  copyWeekForward();
  commitBulkChange();
});

document.getElementById("btnApplyRange")?.addEventListener("click", ()=>{
  applyPatternToRange();
  commitBulkChange();
});

document.getElementById("btnClearRange")?.addEventListener("click", ()=>{
  clearRange();
  commitBulkChange();
});

/* ===================== STARTUP ===================== */
build();
setRangeDefaults();
loadAvailability(getActiveMemberId());

document.getElementById("member")?.addEventListener("change", async ()=>{
  // wipe current in-memory state, rebuild, then load for new member
  for(const k of Object.keys(state)) delete state[k];
  build();
  setRangeDefaults();
  await loadAvailability(getActiveMemberId());
});
</script>

</body>
</html>
