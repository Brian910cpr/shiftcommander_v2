<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ShiftCommander – Member</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    select, textarea, button { font-size: 16px; margin: 5px 0; }
    .status { margin-top: 10px; color: green; }
  </style>
</head>
<body>

<h1>Member Availability</h1>

<label>Member:</label><br />
<select id="memberSelect"></select>

<h3>Availability JSON</h3>
<textarea id="payload" rows="10" cols="60"></textarea><br />

<button onclick="save()">Save</button>

<div class="status" id="status"></div>

<script>
const STORE = "https://adr-fr.org/api/store";

async function loadRoster() {
  const res = await fetch(`${STORE}?kind=members`);
  const data = await res.json();

  // members.json may be an object, not array
  const members = Array.isArray(data.payload)
    ? data.payload
    : Object.values(data.payload || {});

  const sel = document.getElementById("memberSelect");
  sel.innerHTML = "";

  members.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name} (${m.id})`;
    sel.appendChild(opt);
  });

  sel.onchange = loadMember;
  if (members.length) loadMember();
}

async function loadMember() {
  const id = document.getElementById("memberSelect").value;
  const res = await fetch(`${STORE}?kind=member_availability&member_id=${id}`);
  const data = await res.json();
  document.getElementById("payload").value =
    JSON.stringify(data.payload || {}, null, 2);
}

async function save() {
  const id = document.getElementById("memberSelect").value;
  const payload = JSON.parse(document.getElementById("payload").value);

  await fetch(STORE, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      kind: "member_availability",
      member_id: id,
      payload
    })
  });

  document.getElementById("status").textContent = "Saved to Drive ✔";
}

loadRoster();
</script>

</body>
</html>
