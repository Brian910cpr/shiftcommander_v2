<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander — Wallboard</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --line:#d9e1ee; --line2:#eef2f7;
    --text:#0f172a; --muted:#64748b; --muted2:#94a3b8; --open:#9aa5b1;
    --shadow:0 1px 2px rgba(0,0,0,.06); --r:10px;
    --g:#16a34a; --y:#f59e0b; --red:#dc2626; --gray:#94a3b8;
  }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
  .top{ position:sticky; top:0; z-index:10; background:linear-gradient(#fff,#fbfdff); border-bottom:1px solid var(--line); box-shadow:var(--shadow);}
  .top-inner{ max-width:1500px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; }
  .title{ font-weight:1000; display:flex; align-items:baseline; gap:10px; }
  .sub{ font-size:12px; color:var(--muted); font-weight:900; }
  .pill{ font-size:12px; font-weight:900; color:var(--muted); border:1px solid var(--line); background:#fff; border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:10px;}
  .btn{ border:1px solid var(--line); background:#fff; border-radius:999px; padding:6px 10px; font-weight:1000; cursor:pointer; }
  .btn.primary{ border-color:#c7d2fe; background:#eef2ff; }
  .wrap{ max-width:1500px; margin:0 auto; padding:12px; }
  .week-block{ border:1px solid var(--line); border-radius:var(--r); background:var(--card); box-shadow:var(--shadow); overflow:hidden; margin-bottom:12px; }
  .week-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line2); background:linear-gradient(#fbfdff,#fff); gap:12px; }
  .week-head .left{ display:flex; align-items:baseline; gap:10px; }
  .week-title{ font-weight:1000; }
  .week-dates{ font-size:12px; color:var(--muted); font-weight:900; }
  .weekday-row{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; padding:10px 12px 0 12px; color:var(--muted); font-weight:1000; font-size:11px; letter-spacing:.08em; text-transform:uppercase;}
  .grid{ display:grid; grid-template-columns:repeat(7,minmax(165px,1fr)); gap:10px; padding:10px 12px 12px 12px; }
  .day{ display:grid; grid-template-columns:8px 1fr; border-radius:var(--r); overflow:hidden; border:1px solid var(--line); background:var(--card); }
  .health{ background:var(--gray); }
  .tile{ display:grid; grid-template-rows:30px 1fr 1fr; min-height:142px; }
  .dayhead{ display:flex; justify-content:space-between; align-items:center; padding:6px 10px; border-bottom:1px solid var(--line2); background:linear-gradient(#fbfdff,#fff); }
  .daynum{ font-size:16px; font-weight:1000; line-height:1; display:flex; align-items:center; gap:6px;}
  .iso{ font-size:11px; color:var(--muted2); font-weight:1000; }
  .slot{ display:grid; grid-template-columns:22px 1fr; gap:8px; padding:8px 10px; border-top:1px solid var(--line2); align-items:start; }
  .slot:first-of-type{ border-top:none; }
  .tag{ font-size:10px; font-weight:1000; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; padding-top:2px; }
  .lines{ display:flex; flex-direction:column; gap:5px; min-width:0; }
  .line{ font-size:12px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; }
  .open{ color:var(--open); font-weight:1000; letter-spacing:.06em; text-transform:uppercase; }
  .note{ margin-top:4px; font-size:11px; font-weight:1000; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .note strong{ color:var(--text); }
  .flag{ font-size:12px; font-weight:1000; color:var(--y); }
  .today .tile{ outline:2px solid #0f172a; outline-offset:-2px; }
  .err{ padding:12px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  @media (max-width:980px){ .weekday-row{display:none;} .grid{grid-template-columns:repeat(2,minmax(160px,1fr));} }
</style>
</head>
<body>

<div class="top">
  <div class="top-inner">
    <div class="title">
      <div>Wallboard</div>
      <div class="sub" id="rangeLabel">Prev + This + Planning</div>
    </div>
    <div class="pill">
      <span id="statusPill">Loading…</span>
      <button class="btn primary" id="setStoreBtn" title="Set the Cloudflare Worker store endpoint">Set STORE_URL</button>
    </div>
  </div>
</div>

<div class="wrap" id="root"></div>

<script>
let STORE_URL = (new URLSearchParams(location.search).get("store") || localStorage.getItem("STORE_URL") || "").trim();
const TOKEN = "";
const PLANNING_WEEKS = 4;
const WEEK_START = 0;

const KIND_SCHEDULE = "schedule";
const KIND_MEMBERS  = "members";

function isoDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const diff=(x.getDay()-WEEK_START+7)%7; x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtRange(a,b){ const opt={month:"short",day:"numeric"}; const left=a.toLocaleDateString(undefined,opt); const right=b.toLocaleDateString(undefined,opt); return `${left} – ${right}, ${b.getFullYear()}`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function setPill(msg, color){ const el=document.getElementById("statusPill"); el.textContent=msg; el.style.color=color||""; }

function storeUrl(kind){
  const u = new URL(STORE_URL);
  u.searchParams.set("kind", kind);
  if(TOKEN) u.searchParams.set("token", TOKEN);
  return u.toString();
}
async function fetchText(url){
  const r = await fetch(url, { cache:"no-store" });
  return await r.text();
}
async function fetchJsonSmart(kind, fallbackPath){
  if(STORE_URL){
    const t = await fetchText(storeUrl(kind));
    let j;
    try { j = JSON.parse(t); } catch(e){
      if(t.trim().startsWith("<!DOCTYPE html")) throw new Error(`Store returned HTML for kind=${kind} (auth/CORS).`);
      throw e;
    }
    if(j && j.ok === false) throw new Error(j.error || `Store error for kind=${kind}`);
    return j;
  } else {
    const t = await fetchText(fallbackPath);
    return JSON.parse(t);
  }
}

function buildRosterIndex(membersJson){
  const byId = {};
  const list = Array.isArray(membersJson) ? membersJson : (membersJson.members || membersJson.data || []);
  for(const m of list){
    const id = String(m.member_id ?? m.id ?? m.memberId ?? "").trim();
    if(!id) continue;

    const cert = (m.medical || m.medical_level || m.level || m.ems_level || "").toString().toUpperCase();
    const quals = m.quals || m.qualifications || m.qual || [];

    const isALS =
      cert.includes("AEMT") || cert.includes("PARAMEDIC") || cert.includes("EMT-P") ||
      (Array.isArray(quals) && quals.some(q => String(q).toUpperCase().includes("AEMT") || String(q).toUpperCase().includes("PARAMEDIC")));

    const isEMT = (cert.includes("EMT") && !isALS);

    const has120 =
      m.qual_120 === true || m.qual120 === true ||
      (Array.isArray(quals) && quals.some(q => String(q).includes("120"))) ||
      (typeof quals === "object" && (quals.qual_120 || quals["120"]));

    byId[id] = {
      name: (m.name || m.full_name || m.display_name || m.last_first || id).toString(),
      tier: isALS ? "ALS" : (isEMT ? "EMT" : "UNK"),
      has120: !!has120
    };
  }
  return byId;
}

function normalizePair(pair){
  const a = (pair && pair[0]) ? String(pair[0]).trim() : "OPEN";
  const d = (pair && pair[1]) ? String(pair[1]).trim() : "OPEN";
  return [a || "OPEN", d || "OPEN"];
}
function getDay(schedule, iso){
  const obj = schedule[iso] || {};
  const am = normalizePair(obj.AM || obj.am || obj.Am || ["OPEN","OPEN"]);
  const pm = normalizePair(obj.PM || obj.pm || obj.Pm || ["OPEN","OPEN"]);
  const flags = obj.flags || [];
  const notes = obj.notes || {};
  return { am, pm, flags, notes };
}

function shiftHealth(attId, drvId, roster){
  const att = roster[attId];
  const drv = roster[drvId];

  const attTier = (attId === "OPEN") ? "OPEN" : (att?.tier || "UNK");
  const drvTier = (drvId === "OPEN") ? "OPEN" : (drv?.tier || "UNK");
  const drvHas120 = (drvId !== "OPEN") && !!(drv?.has120);

  if(attId === "OPEN" || attTier !== "ALS") return "RED";
  if(drvId === "OPEN" || !drvHas120) return "RED";
  if(drvTier === "EMT") return "GREEN";
  return "YELLOW";
}
function dayHealth(dayObj, roster){
  const ranks = { RED:3, YELLOW:2, GREEN:1 };
  const [amA, amD] = dayObj.am;
  const [pmA, pmD] = dayObj.pm;
  const amH = shiftHealth(amA, amD, roster);
  const pmH = shiftHealth(pmA, pmD, roster);
  return (ranks[amH] >= ranks[pmH]) ? amH : pmH;
}
function needsHint(attId, drvId, roster){
  if(attId === "OPEN" || (roster[attId]?.tier !== "ALS")) return "Needs ALS";
  if(drvId === "OPEN" || !roster[drvId]?.has120) return "Need Driver";
  if(roster[drvId]?.tier === "ALS") return "Needs EMT";
  return "";
}

function healthColor(h){
  if(h==="GREEN") return "var(--g)";
  if(h==="YELLOW") return "var(--y)";
  if(h==="RED") return "var(--red)";
  return "var(--gray)";
}
function nameFor(id, roster){
  if(!id || id === "OPEN") return `<span class="open">OPEN</span>`;
  const nm = (roster[id]?.name || id).toString();
  return escapeHtml(nm);
}

function renderWeekBlock(root, title, weekStartDate, schedule, roster, opts={}){
  const weekEnd = addDays(weekStartDate, 6);
  const block = document.createElement("div");
  block.className = "week-block";

  const head = document.createElement("div");
  head.className = "week-head";
  head.innerHTML = `
    <div class="left">
      <div class="week-title">${escapeHtml(title)}</div>
      <div class="week-dates">${escapeHtml(fmtRange(weekStartDate, weekEnd))}</div>
    </div>
    <div class="sub">${escapeHtml(opts.sub || "")}</div>
  `;
  block.appendChild(head);

  const wd = document.createElement("div");
  wd.className = "weekday-row";
  wd.innerHTML = `<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>`;
  block.appendChild(wd);

  const grid = document.createElement("div");
  grid.className = "grid";

  const todayIso = isoDate(new Date());

  for(let i=0;i<7;i++){
    const d = addDays(weekStartDate, i);
    const iso = isoDate(d);
    const dayObj = getDay(schedule, iso);
    const h = dayHealth(dayObj, roster);
    const hasCaution = Array.isArray(dayObj.flags) && dayObj.flags.length > 0;

    const [amA, amD] = dayObj.am;
    const [pmA, pmD] = dayObj.pm;

    const amNeed = opts.showNeeds ? needsHint(amA, amD, roster) : "";
    const pmNeed = opts.showNeeds ? needsHint(pmA, pmD, roster) : "";

    const day = document.createElement("div");
    day.className = "day" + (iso===todayIso ? " today" : "");

    const health = document.createElement("div");
    health.className = "health";
    health.style.background = healthColor(h);

    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <div class="dayhead">
        <div class="daynum">${d.getDate()} ${hasCaution ? `<span class="flag">⚠</span>` : ""}</div>
        <div class="iso">${iso}</div>
      </div>

      <div class="slot">
        <div class="tag">AM</div>
        <div class="lines">
          <div class="line">${nameFor(amA, roster)}</div>
          <div class="line">${nameFor(amD, roster)}</div>
          ${amNeed ? `<div class="note"><strong>${escapeHtml(amNeed)}</strong></div>` : ""}
        </div>
      </div>

      <div class="slot">
        <div class="tag">PM</div>
        <div class="lines">
          <div class="line">${nameFor(pmA, roster)}</div>
          <div class="line">${nameFor(pmD, roster)}</div>
          ${pmNeed ? `<div class="note"><strong>${escapeHtml(pmNeed)}</strong></div>` : ""}
        </div>
      </div>
    `;
    day.appendChild(health);
    day.appendChild(tile);
    grid.appendChild(day);
  }

  block.appendChild(grid);
  root.appendChild(block);
}

async function main(){
  const root = document.getElementById("root");
  root.innerHTML = "";

  setPill(STORE_URL ? "Loading…" : "No STORE_URL — trying ./schedule.json", STORE_URL ? "" : "#b45309");

  const schedule = await fetchJsonSmart(KIND_SCHEDULE, "./schedule.json");
  const members  = await fetchJsonSmart(KIND_MEMBERS,  "./members.json");
  const roster = buildRosterIndex(members);

  const now = new Date();
  const thisWeekStart = startOfWeek(now);
  const prevWeekStart = addDays(thisWeekStart, -7);
  const planningStarts = addDays(thisWeekStart, 7);

  renderWeekBlock(root, "Previous Week", prevWeekStart, schedule, roster, { sub:"Context" });
  renderWeekBlock(root, "This Week", thisWeekStart, schedule, roster, { sub:"Operational" });

  for(let w=0; w<PLANNING_WEEKS; w++){
    const ws = addDays(planningStarts, w*7);
    const isLast = (w === PLANNING_WEEKS-1);
    renderWeekBlock(root, `Planning Week ${w+1}`, ws, schedule, roster, { sub: isLast ? "Notes + Needs" : "Planning", showNeeds:isLast });
  }

  setPill("Live", "#166534");
  document.getElementById("rangeLabel").textContent = `Prev + This + ${PLANNING_WEEKS} Planning week(s)`;
}

document.getElementById("setStoreBtn").addEventListener("click", async () => {
  const cur = STORE_URL || "https://shift.adr-fr.org/store";
  const next = prompt("Enter STORE_URL (Cloudflare Worker endpoint that proxies Apps Script):", cur);
  if(next && next.trim()){
    STORE_URL = next.trim();
    localStorage.setItem("STORE_URL", STORE_URL);
    try{ await main(); }catch(e){ console.error(e); setPill("Load failed", "#b91c1c"); }
  }
});

main().catch(err => {
  console.error(err);
  setPill("Load failed", "#b91c1c");
  const root = document.getElementById("root");
  root.innerHTML = `<div class="week-block err">
    <div class="week-head"><div class="week-title">Error</div><div class="sub">Check STORE_URL / data paths</div></div>
    <div class="err mono">${escapeHtml(err.message || String(err))}</div>
  </div>`;
});
</script>
</body>
</html>
