<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADR-FR Wallboard â€” Display-only Health</title>

<style>
:root{
  --bg:#0b1020;
  --panel:rgba(255,255,255,.035);
  --line:rgba(255,255,255,.12);
  --text:#e7ecff;
  --muted:#a9b3d6;

  --ok:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;
  --plan:#60a5fa;

  --shadow: 0 10px 26px rgba(0,0,0,.35);
  --r:14px;

  --b-ok:   0 0 0 3px rgba(34,197,94,.60),  0 0 0 6px rgba(34,197,94,.18);
  --b-warn: 0 0 0 3px rgba(245,158,11,.65), 0 0 0 6px rgba(245,158,11,.18);
  --b-bad:  0 0 0 3px rgba(239,68,68,.70),  0 0 0 6px rgba(239,68,68,.22);
  --b-plan: 0 0 0 3px rgba(96,165,250,.70), 0 0 0 6px rgba(96,165,250,.18);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: linear-gradient(180deg,#060a18,var(--bg));
  color:var(--text);
  overflow:hidden;
}

/* Top bar */
.top{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  background:rgba(8,12,28,.7);
}
.brand{ font-weight:900; }
.controls{ display:flex; gap:8px; align-items:center; }
.btn{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
}

/* Layout */
.wrap{ height:calc(100vh - 42px); padding:10px; }
.board{ display:flex; flex-direction:column; gap:10px; }

/* Sections */
details.section{
  border:1px solid var(--line);
  border-radius:var(--r);
  background:var(--panel);
  box-shadow:var(--shadow);
}
summary{
  cursor:pointer;
  list-style:none;
  padding:8px 10px;
  font-weight:900;
  display:flex; justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.08);
}
summary::-webkit-details-marker{ display:none; }

.weeks{ padding:10px; display:flex; flex-direction:column; gap:10px; }

/* Week row */
.weekRow{
  display:grid;
  grid-template-columns:160px repeat(7,1fr);
  gap:6px;
  padding:8px;
  border-radius:14px;
  background:rgba(0,0,0,.14);
}
.weekRow.state-controlled{ box-shadow:var(--b-warn); }
.weekRow.state-published { box-shadow:var(--b-ok); }
.weekRow.state-planning  { box-shadow:var(--b-plan); }

.weekMeta{
  padding:8px;
  border-radius:12px;
  background:rgba(0,0,0,.18);
  font-weight:900;
  font-size:13px;
}

/* Day cell */
.dayCell{
  border-radius:12px;
  background:rgba(0,0,0,.12);
  padding:6px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* DAY HEADER PILL = HEALTH */
.dayPill{
  position:relative;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  border-radius:10px;
  font-weight:900;
  border:3px solid rgba(148,163,184,.35);
  background:rgba(148,163,184,.18);
}
.dayPill.ok{
  background:rgba(34,197,94,.28);
  border-color:rgba(34,197,94,.75);
  box-shadow:0 0 0 2px rgba(34,197,94,.25);
}
.dayPill.warn{
  background:rgba(245,158,11,.26);
  border-color:rgba(245,158,11,.80);
}
.dayPill.bad{
  background:rgba(239,68,68,.26);
  border-color:rgba(239,68,68,.85);
}
.dayPill.warn::after,
.dayPill.bad::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:10px;
  pointer-events:none;
}
.dayPill.warn::after{
  background:repeating-linear-gradient(
    45deg, rgba(255,255,255,.25) 0 5px, transparent 5px 10px
  );
}
.dayPill.bad::after{
  background:repeating-linear-gradient(
    135deg, rgba(255,255,255,.35) 0 4px, transparent 4px 8px
  );
}

.dow{ font-size:11px; color:var(--muted); }
.dayNum{ font-size:15px; }

/* Slots */
.slot{
  display:grid;
  grid-template-columns:28px 1fr;
  gap:6px;
  font-size:12px;
}
.slotLabel{ color:var(--muted); font-weight:900; }
.name{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.name.open{ opacity:.55; }

/* Health helpers */
.healthStrip{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.hBox{ height:8px; border-radius:6px; background:rgba(148,163,184,.25); }
.hBox.ok{ background:rgba(34,197,94,.6); }
.hBox.warn{ background:rgba(245,158,11,.6); }
.hBox.bad{ background:rgba(239,68,68,.6); }
</style>
</head>

<body>
<div class="top">
  <div class="brand">Wallboard <small>display-only</small></div>
  <div class="controls">
    <button class="btn" id="btnNames">Name: First</button>
  </div>
</div>

<div class="wrap">
  <div class="board" id="board"></div>
</div>

<script>
/* NOTE:
   Wallboard is DISPLAY ONLY.
   Health comes exclusively from schedule.meta.health_v1.
*/

const STORE="https://store.adr-fr.org";
const qs=new URLSearchParams(location.search);
const NAME_MODE=Number(qs.get("name")||1);

const DOW=["SUN","MON","TUE","WED","THU","FRI","SAT"];

function iso(d){ return d.toISOString().slice(0,10); }
function add(d,n){ const x=new Date(d); x.setUTCDate(x.getUTCDate()+n); return x; }
function sow(d){ const x=new Date(d); x.setUTCDate(x.getUTCDate()-x.getUTCDay()); return x; }

async function get(kind){
  const r=await fetch(`${STORE}?kind=${kind}`,{cache:"no-store"});
  const j=await r.json();
  return j.payload||j;
}

function dayHealth(hv,date){
  const d=hv?.days?.[date];
  if(!d) return "unknown";
  if(d.AM==="bad"||d.PM==="bad") return "bad";
  if(d.AM==="warn"||d.PM==="warn") return "warn";
  if(d.AM==="ok"&&d.PM==="ok") return "ok";
  return "unknown";
}

function fmtName(m,id){
  const s=(m?.display_name||m?.name||id||"").trim();
  if(NAME_MODE===2) return s.split(/\s+/).map(x=>x[0]).join("").toUpperCase();
  return s.split(/\s+/)[0];
}

async function main(){
  const [org,members,sched]=await Promise.all([
    get("org_settings"), get("members"), get("schedule")
  ]);

  const schedule=sched.schedule||sched;
  const hv=sched.meta?.health_v1;
  const mBy={};
  members.forEach(m=>mBy[m.member_id]=m);

  const board=document.getElementById("board");
  board.innerHTML="";

  const ws=sow(new Date());
  const rows=org.workflow?.controlled_weeks||2;

  for(let w=0;w<rows;w++){
    const start=add(ws,w*7);
    const row=document.createElement("div");
    row.className="weekRow state-controlled";

    const meta=document.createElement("div");
    meta.className="weekMeta";
    meta.textContent=iso(start);
    row.appendChild(meta);

    for(let i=0;i<7;i++){
      const d=add(start,i);
      const di=iso(d);
      const cell=document.createElement("div");
      cell.className="dayCell";

      const pill=document.createElement("div");
      pill.className="dayPill "+dayHealth(hv,di);
      pill.innerHTML=`<div class="dow">${DOW[d.getUTCDay()]}</div><div class="dayNum">${d.getUTCDate()}</div>`;
      cell.appendChild(pill);

      const day=schedule[di]||{};
      ["AM","PM"].forEach(sh=>{
        const slot=day[sh]||["OPEN","OPEN"];
        const s=document.createElement("div");
        s.className="slot";
        s.innerHTML=`<div class="slotLabel">${sh}</div><div>
          ${slot.map(id=>{
            if(!id||id==="OPEN") return `<div class="name open">OPEN</div>`;
            return `<div class="name">${fmtName(mBy[id],id)}</div>`;
          }).join("")}
        </div>`;
        cell.appendChild(s);
      });

      row.appendChild(cell);
    }
    board.appendChild(row);
  }
}
main();
</script>
</body>
</html>
