<!doctype html>
<html lang="en">
<head>
<<<<<<< HEAD
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADR-FR Wallboard ‚Äî Display-only Health (Day Pill)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.12);
      --text:#e7ecff;
      --muted:#a9b3d6;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#60a5fa;

      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --r:14px;

      /* Phase borders (thicker, color-deficiency friendly) */
      --b-ok:  0 0 0 5px rgba(34,197,94,.60),  0 0 0 10px rgba(34,197,94,.18);
      --b-warn:0 0 0 5px rgba(245,158,11,.65), 0 0 0 10px rgba(245,158,11,.18);
      --b-plan:0 0 0 5px rgba(96,165,250,.68), 0 0 0 10px rgba(96,165,250,.18);
      --b-neutral:0 0 0 3px rgba(148,163,184,.25);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 700px at 20% -20%, rgba(124,92,255,.30), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(88,166,255,.22), transparent 52%),
        linear-gradient(180deg, #060a18, var(--bg));
      color:var(--text);
      overflow:hidden;
    }

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px;
      background: rgba(8,12,28,.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .brand{ display:flex; align-items:baseline; gap:10px; font-weight:950; letter-spacing:.2px; white-space:nowrap; }
    .brand small{ font-weight:850; color:var(--muted); }
    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      font-size:12px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:#94a3b8;
      box-shadow:0 0 0 4px rgba(148,163,184,.14);
    }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.14); }
    .dot.warn{ background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.14); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.14); }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      padding:6px 9px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }

    /* Main */
    .wrap{
      height: calc(100vh - 44px);
      padding:8px 10px 12px;
      overflow:hidden;
    }
    .board{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    /* Collapsible sections */
    details.section{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    details.section > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.16);
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:950;
      font-size:13px;
    }
    details.section > summary::-webkit-details-marker{ display:none; }
    .sLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .sTitle{ white-space:nowrap; }
    .sHelp{ color:var(--muted); font-weight:850; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sRight{ display:flex; align-items:center; gap:8px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }

    .weeks{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* One row per week */
    .weekRow{
      display:grid;
      grid-template-columns: 150px repeat(7, minmax(0, 1fr));
      gap:6px;
      padding:8px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
    }
    .weekRow.state-controlled{ box-shadow: var(--b-warn); }
    .weekRow.state-published{  box-shadow: var(--b-ok); }
    .weekRow.state-planning{   box-shadow: var(--b-plan); }
    .weekRow.state-archived{   box-shadow: var(--b-neutral); }

    .weekMeta{
      padding:6px 8px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
      min-width:0;
    }
    .wkTitle{ font-weight:950; letter-spacing:.2px; line-height:1.05; font-size: 13px; }
    .wkRange{ font-weight:850; color:var(--muted); font-size: 12px; line-height:1.1; }
    .wkMini{
      display:flex; align-items:center; gap:6px; flex-wrap:wrap;
      font-weight:950;
      font-size:11px;
      color:var(--muted);
    }
    .wkMini b{ color:var(--text); }

    .dayCell{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
      padding:6px 8px;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* ‚úÖ Day header pill carries day health */
    .dayPill{
      position:relative;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
      padding:6px 8px;
      border-radius: 10px;
      border:3px solid rgba(148,163,184,.35);
      background: rgba(148,163,184,.16);
      overflow:hidden;
    }
    .dayPill .dow{ font-weight:950; font-size:11px; color:rgba(231,236,255,.78); letter-spacing:.4px; }
    .dayPill .dayNum{ font-weight:950; font-size:15px; letter-spacing:.2px; }

    .dayPill.ok{
      background: rgba(34,197,94,.26);
      border-color: rgba(34,197,94,.80);
      box-shadow: 0 0 0 2px rgba(34,197,94,.22);
    }
    .dayPill.warn{
      background: rgba(245,158,11,.24);
      border-color: rgba(245,158,11,.86);
      box-shadow: 0 0 0 2px rgba(245,158,11,.20);
    }
    .dayPill.bad{
      background: rgba(239,68,68,.24);
      border-color: rgba(239,68,68,.90);
      box-shadow: 0 0 0 2px rgba(239,68,68,.22);
    }

    /* Patterns for accessibility */
    .dayPill.warn::after,
    .dayPill.bad::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.55;
    }
    .dayPill.warn::after{
      background: repeating-linear-gradient(45deg, rgba(255,255,255,.18) 0 5px, rgba(255,255,255,0) 5px 10px);
    }
    .dayPill.bad::after{
      opacity:.62;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.22) 0 4px, rgba(255,255,255,0) 4px 8px);
    }

    /* Compact slot layout: label + stacked names */
    .slot{
      display:grid;
      grid-template-columns: 26px 1fr;
      gap:6px;
      align-items:start;
      border-top:1px solid rgba(255,255,255,.06);
      padding-top:4px;
    }
    .slot:first-of-type{ border-top:none; padding-top:0; }
    .slotLabel{ font-weight:950; font-size:11px; color:var(--muted); }
    .names{
      display:grid;
      grid-auto-rows: min-content;
      gap:2px;
      min-width:0;
    }
    .name{
      font-weight:950;
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      line-height:1.15;
    }
    .name.open{ color: rgba(231,236,255,.55); font-weight:900; }

    /* Planning health strip */
    .healthStrip{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin-top:6px;
    }
    .healthDay{
      display:grid;
      grid-template-rows: 10px 10px;
      gap:3px;
      border-radius:8px;
      padding:4px 5px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .hBox{
      border-radius:6px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(148,163,184,.20);
      position:relative;
      overflow:hidden;
    }
    .hBox.ok{ background: rgba(34,197,94,.28); border-color: rgba(34,197,94,.45); }
    .hBox.warn{ background: rgba(245,158,11,.26); border-color: rgba(245,158,11,.45); }
    .hBox.bad{ background: rgba(239,68,68,.24); border-color: rgba(239,68,68,.45); }

    /* Error banner */
    .fatal{
      margin:8px 10px 0;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(239,68,68,.45);
      background: rgba(239,68,68,.14);
      color:#ffe4e6;
      font-weight:900;
      display:none;
      font-size:12px;
    }

    @media (max-width: 1200px){
      .weekRow{ grid-template-columns: 140px repeat(7, minmax(0, 1fr)); }
      .name{ font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">
      Wallboard <small>display-only health ‚Ä¢ day-pill</small>
    </div>
    <div class="controls">
      <button class="btn" id="btnNames" title="Toggle name style">Name: First</button>
      <span class="chip" id="chipStatus"><span class="dot warn" id="dot"></span><span id="status">Loading‚Ä¶</span></span>
      <span class="chip"><span id="updated">‚Äî</span></span>
    </div>
  </div>

  <div class="fatal" id="fatal"></div>

  <div class="wrap">
    <div class="board" id="board"></div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const STORE_BASE = "https://store.adr-fr.org";
  const LS_TOKEN = "sc_token";

  const OPT = {
    refreshSec: clampInt(qs.get("refresh"), 10, 3600, 60),
    weeks: clampInt(qs.get("weeks"), 3, 24, 10),
    // name modes: 1=first(default), 2=initials, 3=F.Last, 4=First L., 5=First+Last, 6=Callsign
    name: clampInt(qs.get("name"), 1, 6, 1),
    planning: clampInt(qs.get("planning"), 2, 12, 6),
    controlled: clampInt(qs.get("controlled"), 1, 4, 2),
    published: clampInt(qs.get("published"), 1, 6, 2),
  };

  function clampInt(v, min, max, def){
    const n = Number(v);
    if (!Number.isFinite(n)) return def;
    const i = Math.floor(n);
    return Math.max(min, Math.min(max, i));
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function fatal(msg, err){
    const el = document.getElementById("fatal");
    el.style.display = "block";
    el.innerHTML = "WALLBOARD ERROR: " + escapeHtml(msg) + (err ? " <code>"+escapeHtml(err.message||String(err))+"</code>" : "");
    setStatus("bad","Error");
  }
  function setStatus(kind, text){
    const dot = document.getElementById("dot");
    dot.className = "dot " + (kind||"warn");
    document.getElementById("status").textContent = text;
  }
  function setUpdated(text){ document.getElementById("updated").textContent = text; }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(d){
    const dt = new Date(d.getTime());
    dt.setUTCHours(0,0,0,0);
    return dt.getUTCFullYear()+"-"+pad2(dt.getUTCMonth()+1)+"-"+pad2(dt.getUTCDate());
  }
  function parseIso(s){
    const [y,m,d] = String(s).split("-").map(Number);
    if(!y||!m||!d) return null;
    const dt = new Date(Date.UTC(y,m-1,d));
    dt.setUTCHours(0,0,0,0);
    return dt;
  }
  function addDays(dateObj, n){
    const d = new Date(dateObj.getTime());
    d.setUTCDate(d.getUTCDate()+n);
    return d;
  }
  function startOfWeekSunday(dateObj){
    const d = new Date(dateObj.getTime());
    const dow = d.getUTCDay();
    d.setUTCDate(d.getUTCDate()-dow);
    d.setUTCHours(0,0,0,0);
    return d;
  }
  function fmtRange(start){
    const end = addDays(start, 6);
    const opts = { month:"short", day:"numeric" };
    const a = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
    const b = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));
    return a.toLocaleDateString(undefined, opts) + " ‚Äì " + b.toLocaleDateString(undefined, opts);
  }
  const DOW = ["SUN","MON","TUE","WED","THU","FRI","SAT"];

  function getToken(){ try{ return localStorage.getItem(LS_TOKEN) || ""; }catch(e){ return ""; } }
  async function storeGet(kind){
    const url = new URL(STORE_BASE);
    url.searchParams.set("kind", kind);
    const token = getToken();
    if(token) url.searchParams.set("token", token);
    const resp = await fetch(url.toString(), { method:"GET", cache:"no-store" });
    const text = await resp.text();
    let j = null;
    try{ j = JSON.parse(text); }catch(e){}
    if(!resp.ok) throw new Error("Store GET "+kind+" failed ("+resp.status+")");
    return j ?? text;
  }
  function unwrapStorePayload(resp){
    if(resp && typeof resp === "object"){
      if(resp.payload !== undefined) return resp.payload;
      if(resp.data !== undefined) return resp.data;
      if(resp.value !== undefined) return resp.value;
      if(resp.body !== undefined) return resp.body;
      if(resp.ok && resp.kind && resp.result !== undefined) return resp.result;
    }
    return resp;
  }
  function normalizeScheduleMap(s){
    if(!s || typeof s !== "object") return {};
    if(s.schedule && typeof s.schedule === "object") return s.schedule;
    return s;
  }
  function getSlot(schedule, dateIso, shift){
    const day = schedule?.[dateIso];
    if(!day || typeof day !== "object") return null;
    return day?.[shift] || day?.[shift.toLowerCase()] || null;
  }
  function listNames(slot){
    if(!slot) return ["OPEN","OPEN"];
    if(Array.isArray(slot)) return slot.map(x=>x||"OPEN");
    if(slot && typeof slot === "object"){
      const out = [];
      if(slot.attendant !== undefined) out.push(slot.attendant);
      if(slot.operator !== undefined) out.push(slot.operator);
      if(slot.third !== undefined) out.push(slot.third);
      if(out.length) return out.map(x=>x||"OPEN");
    }
    return ["OPEN","OPEN"];
  }
  function isOpen(v){
    const s = String(v||"").trim().toUpperCase();
    return !s || s==="OPEN" || s==="-" || s==="‚Äî";
  }

  /* Name modes */
  function splitName(full){
    const s = String(full||"").trim().replace(/\s+/g," ");
    if(!s) return { first:"", last:"", parts:[] };
    const parts = s.split(" ");
    return { first: parts[0]||"", last: parts.length>1 ? parts[parts.length-1] : "", parts };
  }
  function initials(parts){ return parts.filter(Boolean).map(p => (p[0]||"").toUpperCase()).join(""); }
  function formatName(memberObj, idStr){
    const base = String(
      memberObj?.display_name ||
      memberObj?.name ||
      memberObj?.callsign ||
      idStr
    ).trim();
    const { first, last, parts } = splitName(base);
    const single = parts.length <= 1;

    switch(OPT.name){
      case 2: return single ? base.toUpperCase().slice(0,3) : initials(parts);
      case 3: return single ? base : ((first?first[0].toUpperCase()+".":"") + (last?(" "+last):"")).trim();
      case 4: return single ? base : ((first||base) + (last?(" "+last[0].toUpperCase()+"."):"")).trim();
      case 5: return single ? base : ((first||"") + (last?(" "+last):"")).trim();
      case 6: return String(memberObj?.callsign||"").trim() || (first||base);
      case 1:
      default: return first || base;
    }
  }
  function nameModeLabel(){
    return {1:"First",2:"Initials",3:"F.Last",4:"First L.",5:"First Last",6:"Callsign"}[OPT.name] || "First";
  }

  /* Health display-only helpers */
  function normalizeHealthToken(x){
    const s = String(x||"unknown").toLowerCase();
    if(s==="ok"||s==="warn"||s==="bad"||s==="unknown"||s==="na") return s;
    return "unknown";
  }
  function dayOverallHealth(hvForDate){
    const a = normalizeHealthToken(hvForDate?.AM);
    const p = normalizeHealthToken(hvForDate?.PM);
    if(a==="bad" || p==="bad") return "bad";
    if(a==="warn" || p==="warn") return "warn";
    if(a==="ok" && p==="ok") return "ok";
    if((a==="ok" && p==="unknown") || (p==="ok" && a==="unknown")) return "warn";
    return "unknown";
  }

  function buildWeekStarts(schedule){
    const keys = Object.keys(schedule||{}).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
    const dates = keys.map(parseIso).filter(Boolean).sort((a,b)=>a-b);
    if(!dates.length){
      const t = new Date();
      const base = startOfWeekSunday(new Date(Date.UTC(t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate())));
      return Array.from({length:8}, (_,i)=>addDays(base, i*7));
    }
    const seen = new Set();
    const starts = [];
    for(const d of dates){
      const ws = startOfWeekSunday(d);
      const key = isoDate(ws);
      if(seen.has(key)) continue;
      seen.add(key);
      starts.push(ws);
    }
    return starts;
  }

  function renderWeekRow({label, stateClass, ws, schedule, membersById, healthDays, showNames=true, showHealth=true}){
    const row = document.createElement("div");
    row.className = "weekRow " + stateClass;

    const meta = document.createElement("div");
    meta.className = "weekMeta";
    meta.innerHTML = `
      <div class="wkTitle">${escapeHtml(fmtRange(ws))}</div>
      <div class="wkRange">${escapeHtml(isoDate(ws))}</div>
      <div class="wkMini"><b>${escapeHtml(label)}</b> ‚Ä¢ <span>AM/PM health</span></div>
    `;
    if(showHealth){
      const hs = document.createElement("div");
      hs.className = "healthStrip";
      for(let i=0;i<7;i++){
        const d = addDays(ws, i);
        const dateIso = isoDate(d);
        const hv = healthDays?.[dateIso] || {AM:"unknown", PM:"unknown"};
        const day = document.createElement("div");
        day.className = "healthDay";
        const am = document.createElement("div");
        am.className = "hBox " + normalizeHealthToken(hv.AM);
        const pm = document.createElement("div");
        pm.className = "hBox " + normalizeHealthToken(hv.PM);
        day.appendChild(am); day.appendChild(pm);
        hs.appendChild(day);
      }
      meta.appendChild(hs);
    }
    row.appendChild(meta);

    for(let i=0;i<7;i++){
      const d = addDays(ws, i);
      const dateIso = isoDate(d);
      const cell = document.createElement("div");
      cell.className = "dayCell";

      const hv = healthDays?.[dateIso] || {AM:"unknown", PM:"unknown"};
      const overall = dayOverallHealth(hv);

      const pill = document.createElement("div");
      pill.className = "dayPill " + overall;
      pill.innerHTML = `<div class="dow">${DOW[d.getUTCDay()]}</div><div class="dayNum">${d.getUTCDate()}</div>`;
      cell.appendChild(pill);

      if(showNames){
        for(const sh of ["AM","PM"]){
          const slot = getSlot(schedule, dateIso, sh);
          const ids = listNames(slot);

          const lines = ids.slice(0,3).map((id)=>{
            const open = isOpen(id);
            const m = open ? null : (membersById[String(id)] || null);
            const nm = open ? "OPEN" : formatName(m, String(id));
            const cls = open ? "name open" : "name";
            return `<div class="${cls}" title="${escapeHtml(nm)}">${escapeHtml(nm)}</div>`;
          }).join("");

          const s = document.createElement("div");
          s.className = "slot";
          s.innerHTML = `<div class="slotLabel">${sh}</div><div class="names">${lines}</div>`;
          cell.appendChild(s);
        }
      }

      row.appendChild(cell);
    }

    return row;
  }

  function buildSection({title, help, countPill, open, rows}){
    const det = document.createElement("details");
    det.className = "section";
    det.open = !!open;

    const sum = document.createElement("summary");
    sum.innerHTML = `
      <div class="sLeft">
        <div class="sTitle">${escapeHtml(title)}</div>
        <div class="sHelp">${escapeHtml(help)}</div>
      </div>
      <div class="sRight">
        <span class="pill">${escapeHtml(countPill)}</span>
      </div>
    `;
    det.appendChild(sum);

    const box = document.createElement("div");
    box.className = "weeks";
    rows.forEach(r => box.appendChild(r));
    det.appendChild(box);
    return det;
  }

  function syncButtons(){
    document.getElementById("btnNames").textContent = "Name: " + nameModeLabel();
  }
  document.getElementById("btnNames").addEventListener("click", ()=>{
    OPT.name = (OPT.name % 6) + 1;
    syncButtons();
    main();
  });

  async function loadData(){
    setStatus("warn","Loading‚Ä¶");
    const [orgResp, membersResp, schedResp] = await Promise.allSettled([
      storeGet("org_settings"), storeGet("members"), storeGet("schedule")
    ]);
    const org = (orgResp.status==="fulfilled") ? unwrapStorePayload(orgResp.value) : {};
    const members = (membersResp.status==="fulfilled") ? unwrapStorePayload(membersResp.value) : [];
    const sched = (schedResp.status==="fulfilled") ? unwrapStorePayload(schedResp.value) : {};
    return { org, members, sched };
  }

  function membersById(members){
    const by = {};
    (Array.isArray(members)?members:[]).forEach(m=>{
      const id = String(m.member_id||"").trim();
      if(!id) return;
      by[id] = m;
    });
    return by;
  }

  function partitionWeeks(starts, wf){
    const controlledN = clampInt(wf?.controlled_weeks, 1, 4, OPT.controlled);
    const publishedN  = clampInt(wf?.published_weeks, 1, 6, OPT.published);
    const planningN   = clampInt(wf?.planning_weeks,  2, 12, OPT.planning);

    const controlled = starts.slice(0, controlledN);
    const published  = starts.slice(controlledN, controlledN + publishedN);
    const planning   = starts.slice(controlledN + publishedN, controlledN + publishedN + planningN);
    return { controlled, published, planning };
  }

  function render(org, members, sched){
    const board = document.getElementById("board");
    board.innerHTML = "";

    const schedule = normalizeScheduleMap(sched);
    const hvDays = (sched?.meta?.health_v1?.days && typeof sched.meta.health_v1.days === "object") ? sched.meta.health_v1.days : {};

    const startsAll = buildWeekStarts(schedule).slice(0, OPT.weeks);
    const parts = partitionWeeks(startsAll, org?.workflow);

    const mBy = membersById(members);

    const controlledRows = parts.controlled.map(ws => renderWeekRow({
      label:"Controlled",
      stateClass:"state-controlled",
      ws, schedule, membersById:mBy,
      healthDays: hvDays,
      showNames:true, showHealth:true
    }));

    const publishedRows = parts.published.map(ws => renderWeekRow({
      label:"Published",
      stateClass:"state-published",
      ws, schedule, membersById:mBy,
      healthDays: hvDays,
      showNames:true, showHealth:true
    }));

    const planningRows = parts.planning.map(ws => renderWeekRow({
      label:"Planning",
      stateClass:"state-planning",
      ws, schedule, membersById:mBy,
      healthDays: hvDays,
      showNames:false, showHealth:true
    }));

    board.appendChild(buildSection({
      title:"Controlled",
      help:"Firm schedule. Changes require Supervisor review only.",
      countPill:`${controlledRows.length} week(s)`,
      open:true,
      rows: controlledRows
    }));

    board.appendChild(buildSection({
      title:"Published",
      help:"Drop / swap early ‚Äî avoid last-minute chaos.",
      countPill:`${publishedRows.length} week(s)`,
      open:true,
      rows: publishedRows
    }));

    board.appendChild(buildSection({
      title:"Planning",
      help:"No names shown. Health is display-only from Supervisor resolver run.",
      countPill:`${planningRows.length} week(s)`,
      open:false,
      rows: planningRows
    }));

    setStatus("ok","Live");
    setUpdated("Updated " + new Date().toLocaleTimeString());
  }

  async function main(){
    try{
      syncButtons();
      const { org, members, sched } = await loadData();
      render(org, members, sched);
    }catch(e){
      console.error(e);
      fatal("Load/render failed", e);
      setUpdated(new Date().toLocaleTimeString());
    }
  }

  try{
    setStatus("warn","Booting‚Ä¶");
    syncButtons();
    main();
    setInterval(main, OPT.refreshSec * 1000);
  }catch(e){
    console.error(e);
    fatal("Startup failed", e);
=======
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander ‚Äî Wallboard</title>
<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --line:#d9e1ee;
    --line2:#eef2f7;
    --text:#0f172a;
    --muted:#64748b;
    --muted2:#94a3b8;
    --open:#64748b;
    --shadow:0 1px 2px rgba(0,0,0,.06);
    --r:10px;

    /* Color-deficiency friendly */
    --g:#00ff2a;
    --y:#ffd400;
    --red:#d40000;
    --gray:#94a3b8;

    /* Layout vars */
    --gap:6px;
    --pad:8px;
    --weekHeadH:24px;
    --dayHeadH:24px;
    --nameMin:12px;
    --nameMax:14px;

    --topbg1:#ffffff;
    --topbg2:#fbfdff;
    --topborder:var(--line);

    --pillbg:#ffffff;
    --pillborder:var(--line);
    --pilltext:var(--muted);

    --btnbg:#ffffff;
    --btnborder:var(--line);
    --btntext:var(--text);
    --btnhover:#f8fafc;

    --needsbg:#fff1f2;
    --needsborder:#fecdd3;
  }

  body[data-theme="dark"]{
    --bg:#0b1220;
    --card:#0f172a;
    --line:#22304a;
    --line2:#1a2740;
    --text:#e5e7eb;
    --muted:#b6c2d3;
    --muted2:#93a4bf;
    --open:#93a4bf;
    --shadow:0 1px 2px rgba(0,0,0,.35);

    --gray:#6b7ea6;

    --topbg1:#0f172a;
    --topbg2:#0b1220;
    --topborder:#22304a;

    --pillbg:#0b1220;
    --pillborder:#22304a;
    --pilltext:#b6c2d3;

    --btnbg:#0b1220;
    --btnborder:#22304a;
    --btntext:#e5e7eb;
    --btnhover:#111c33;

    --needsbg:rgba(212,0,0,.08);
    --needsborder:rgba(212,0,0,.28);
  }

  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow:hidden; /* wallboard should not scroll the page */
  }

  .top{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(var(--topbg1),var(--topbg2));
    border-bottom:1px solid var(--topborder);
    box-shadow:var(--shadow);
  }
  .top-inner{
    max-width:1600px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding:9px 12px;
  }
  .title{
    font-weight:1000;
    display:flex; align-items:baseline; gap:10px;
  }
  .sub{
    font-size:12px; color:var(--muted);
    font-weight:900;
  }

  .pill{
    font-size:12px;
    font-weight:900;
    color:var(--pilltext);
    border:1px solid var(--pillborder);
    background:var(--pillbg);
    border-radius:999px;
    padding:6px 10px;
    white-space:nowrap;
  }

  .top-right{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .btn{
    appearance:none;
    border:1px solid var(--btnborder);
    background:var(--btnbg);
    color:var(--btntext);
    border-radius:999px;
    padding:6px 10px;
    font-weight:1000;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    user-select:none;
    white-space:nowrap;
  }
  .btn:hover{ background:var(--btnhover); }
  .btn:active{ transform:translateY(1px); }
  .btn .ico{ width:14px; height:14px; display:inline-block; }

  .wrap{
    max-width:1600px;
    margin:0 auto;
    padding:var(--pad);
    height: calc(100vh - 54px);
    box-sizing: border-box;
    display:flex;
    flex-direction:column;
    gap:var(--gap);
  }

  /* The board is a non-scrolling viewport by default (static display).
     Add ?scroll=1 to enable scrolling. */
  #root{
    flex: 1 1 auto;
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    overflow:hidden;
    min-height:0;
    transition: opacity .22s ease;
  }
  body[data-scroll="1"] #root{ overflow:auto; }

  .footer{
    flex: 0 0 auto;
    padding:4px 2px 0 2px;
    color:var(--muted);
    font-size:12px;
    font-weight:900;
    text-align:right;
  }
  .footer strong{ color:var(--text); }

  /* ===== Week rows: each week is ONE row in a column stack (no giant cards) ===== */
  .week{
    flex:1 1 0;
    min-height:0;
    border:1px solid var(--line);
    border-radius:var(--r);
    background:var(--card);
    box-shadow:var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .week-head{
    height:var(--weekHeadH);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 10px;
    border-bottom:1px solid var(--line2);
    background:linear-gradient(var(--topbg2),var(--card));
    gap:10px;
    flex:0 0 auto;
  }
  .week-title{ font-weight:1000; font-size:12px; }
  .week-dates{ font-size:12px; color:var(--muted); font-weight:900; }

  .grid{
    flex:1 1 auto;
    min-height:0;
    display:grid;
    grid-template-columns: repeat(7, minmax(130px, 1fr));
    gap:var(--gap);
    padding:6px 8px 8px 8px;
    align-content:stretch;
  }

  /* Day tile: designed to compress vertically */
  .day{
    display:grid;
    grid-template-columns: 8px 1fr;
    border-radius:var(--r);
    overflow:hidden;
    border:1px solid var(--line);
    background:var(--card);
    min-height:0;
  }
  .health{ background:var(--gray); }
  .tile{
    min-height:0;
    display:grid;
    grid-template-rows: var(--dayHeadH) 1fr 1fr;
  }
  .dayhead{
    height:var(--dayHeadH);
    display:flex; justify-content:space-between; align-items:center;
    padding:0 8px;
    border-bottom:1px solid var(--line2);
    background:linear-gradient(var(--topbg2),var(--card));
    gap:8px;
  }
  .daynum{ font-size:15px; font-weight:1000; line-height:1; display:flex; align-items:center; gap:6px; }
  .iso{ font-size:11px; color:var(--muted2); font-weight:900; }
  .truckpill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(248,250,252,.9);
    color:var(--text);
    font-weight:1000;
    font-size:11px;
    line-height:1;
    white-space:nowrap;
  }
  body[data-theme="dark"] .truckpill{ background:rgba(17,28,51,.75); }

  .slot{
    display:grid;
    grid-template-columns: 22px 1fr;
    gap:6px;
    padding:6px 8px;
    border-top:1px solid var(--line2);
    align-items:start;
    min-height:0;
  }
  .slot:first-of-type{ border-top:none; }
  .tag{
    font-size:10px;
    font-weight:1000;
    color:var(--muted);
    letter-spacing:.08em;
    text-transform:uppercase;
    padding-top:2px;
  }

  .lines{ display:flex; flex-direction:column; gap:4px; min-width:0; }
  .line{
    font-size:clamp(var(--nameMin), 1.05vw, var(--nameMax));
    font-weight:950;
    line-height:1.12;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
  }
  .open{ color:var(--open); font-weight:1000; letter-spacing:.06em; text-transform:uppercase; }

  .warn-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:10px;
    font-weight:1000;
    color:var(--red);
    background:var(--needsbg);
    border:1px solid var(--needsborder);
    padding:1px 7px;
    border-radius:999px;
    margin-left:6px;
  }

  .today .tile{ outline:2px solid var(--text); outline-offset:-2px; }

  .past{ opacity:.62; }
  .past .health{ opacity:1; }

  /* Orientation tuning */
  body.landscape{
    --gap:5px;
    --pad:6px;
    --weekHeadH:22px;
    --dayHeadH:22px;
    --nameMin:11px;
    --nameMax:13px;
  }

  body.portrait{
    --gap:8px;
    --pad:10px;
    --weekHeadH:26px;
    --dayHeadH:26px;
    --nameMin:14px;
    --nameMax:16px;
  }
  body.portrait .grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }

  @media (max-width: 560px){
    .wrap{ padding:6px; height: calc(100vh - 54px); }
    body.portrait .grid{ grid-template-columns: 1fr; }
    .line{ font-size: clamp(14px, 4.2vw, 18px); }
  }
</style>
</head>
<body>

<div class="top">
  <div class="top-inner">
    <div class="title">
      <div>Wallboard <span class="sub" id="buildTag" style="font-weight:1000;margin-left:6px"></span></div>
      <div class="sub" id="rangeLabel" style="display:none;"></div>
    </div>

    <div class="top-right">
      <button class="btn" id="themeToggle" type="button" title="Toggle Day/Night">
        <span class="ico" aria-hidden="true" id="themeIco"></span>
        <span id="themeLabel">Night</span>
      </button>
      <button class="btn" id="archToggle" type="button" title="Toggle Archived week">
        <span class="ico" aria-hidden="true">üóÉÔ∏è</span>
        <span id="archLabel">Archived: Off</span>
      </button>
      <div class="pill" id="statusPill">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="root"></div>
  <div class="footer" id="resolverFooter"></div>
</div>

<script>
/** ========= THEME (DAY/NIGHT) ========= **/
const THEME_KEY = "sc_wallboard_theme"; // "light" | "dark"

function prefersDark(){
  try{ return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches; }
  catch(_e){ return false; }
}
function setTheme(theme){
  const t = (theme === "dark") ? "dark" : "light";
  document.body.setAttribute("data-theme", t);
  try{ localStorage.setItem(THEME_KEY, t); }catch(_e){}
  updateThemeButton();
}
function getSavedTheme(){
  try{ return localStorage.getItem(THEME_KEY); }catch(_e){ return null; }
}
function themeIconSvg(theme){
  if(theme === "dark"){
    return `
      <svg viewBox="0 0 24 24" width="14" height="14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 13.2A8.5 8.5 0 0 1 10.8 3a7 7 0 1 0 10.2 10.2Z"
          stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>`;
  }
  return `
    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
      <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
        stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
}
function updateThemeButton(){
  const t = document.body.getAttribute("data-theme") || "light";
  const lbl = document.getElementById("themeLabel");
  const ico = document.getElementById("themeIco");
  if(!lbl || !ico) return;
  const next = (t === "dark") ? "light" : "dark";
  lbl.textContent = (next === "dark") ? "Night" : "Day";
  ico.innerHTML = themeIconSvg(t);
}

(function initTheme(){
  const saved = getSavedTheme();
  if(saved === "light" || saved === "dark"){
    setTheme(saved);
  }else{
    setTheme(prefersDark() ? "dark" : "light");
  }
  const btn = document.getElementById("themeToggle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const t = document.body.getAttribute("data-theme") || "light";
      setTheme(t === "dark" ? "light" : "dark");
    });
  }
})();
</script>

<script>
/** ========= CONFIG ========= **/
const STORE_URL = "https://schedule-cors-910cpr.brian-9ac.workers.dev";
const USE_FIRST_NAME = true;
const WEEK_START = 0; // Sunday
const AUTO_REFRESH_MS = 5 * 60 * 1000;

const AUTO_SCROLL = false; // default off; this wallboard is meant to be static unless you add ?scroll=1

const KIND_SCHEDULE = "schedule";
const KIND_MEMBERS  = "members";
const KIND_ORG      = "org_settings";
// Optional: if your store has it, this lets wallboard flag impossible assignments
const KIND_AVAIL_1  = "member_availability";
const KIND_AVAIL_2  = "availability";

/* Weeks rendered */
const WEEKS_LANDSCAPE = 4;  // üëà fits on most TVs without scroll
const WEEKS_PORTRAIT  = 6;

/** ========= ORIENTATION ========= **/
function setOrientationClass(){
  const portrait = window.matchMedia("(orientation: portrait)").matches;
  document.body.classList.toggle("portrait", portrait);
  document.body.classList.toggle("landscape", !portrait);
}
setOrientationClass();
window.addEventListener("resize", setOrientationClass);

/** ========= QUERY FLAGS ========= **/
const QS = new URLSearchParams(location.search);
const SCROLL_OK = QS.get("scroll") === "1";
if(SCROLL_OK) document.body.setAttribute("data-scroll","1");

let SHOW_ARCHIVED = (QS.get("archived") === "1");
function updateArchivedBtn(){
  const lbl = document.getElementById("archLabel");
  if(lbl) lbl.textContent = "Archived: " + (SHOW_ARCHIVED ? "On" : "Off");
}
updateArchivedBtn();
const archBtn = document.getElementById("archToggle");
if(archBtn){
  archBtn.addEventListener("click", ()=>{
    SHOW_ARCHIVED = !SHOW_ARCHIVED;
    updateArchivedBtn();
    refreshBoard({initial:false, force:true});
  });
}

/** ========= DATE UTILS ========= **/
function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function startOfWeek(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = (x.getDay() - WEEK_START + 7) % 7;
  x.setDate(x.getDate() - diff);
  x.setHours(0,0,0,0);
  return x;
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function fmtRange(a,b){
  const opt = { month:"short", day:"numeric" };
  const left = a.toLocaleDateString(undefined, opt);
  const right = b.toLocaleDateString(undefined, opt);
  const yr = b.getFullYear();
  return `${left} ‚Äì ${right}, ${yr}`;
}
function fmtLocalTimeFromIso(isoStr){
  try{
    const d = new Date(String(isoStr));
    if(isNaN(d.getTime())) return "";
    return new Intl.DateTimeFormat(undefined, { timeZone:"America/New_York", hour:"2-digit", minute:"2-digit" }).format(d);
  }catch(_e){ return ""; }
}
function fmtLocalDateTimeFromIso(isoStr){
  try{
    const d = new Date(String(isoStr));
    if(isNaN(d.getTime())) return "";
    return new Intl.DateTimeFormat(undefined, { timeZone:"America/New_York", weekday:"short", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit", timeZoneName:"short" }).format(d);
  }catch(_e){ return ""; }
}

/** ========= FETCH ========= **/
function storeUrl(kind){
  const u = new URL(STORE_URL, location.origin);
  u.searchParams.set("kind", kind);
  return u.toString();
}
async function fetchJson(url){
  const r = await fetch(url, { cache:"no-store" });
  const t = await r.text();
  try{
    const j = JSON.parse(t);
    if(j && j.ok === false) throw new Error(j.error || "Store error");
    return j;
  }catch(e){
    if(t.trim().startsWith("<!DOCTYPE html")) throw new Error("Upstream returned HTML (auth/cors/drive).");
    throw e;
  }
}
function unwrapStorePayload(obj){
  let x = obj;
  for(let i=0;i<6;i++){
    if(!x || typeof x !== "object") break;
    if("payload" in x && x.payload && typeof x.payload === "object"){
      x = x.payload;
      continue;
    }
    break;
  }
  return x || {};
}

/** ========= ROSTER MAP ========= **/
function buildRosterIndex(membersJson){
  const byId = {};
  const payload = unwrapStorePayload(membersJson);

  const list =
    Array.isArray(payload) ? payload :
    (payload && Array.isArray(payload.members)) ? payload.members :
    (payload && Array.isArray(payload.data)) ? payload.data :
    [];

  for(const m of list){
    const id = String(m.member_id ?? m.id ?? m.memberId ?? "").trim();
    if(!id) continue;

    const quals = m.quals || m.qualifications || m.qual || [];
    const cert = (m.medical || m.medical_level || m.level || m.ems_level || "").toString().toUpperCase();

    const isALS =
      cert.includes("AEMT") || cert.includes("PARAMEDIC") || cert.includes("EMT-P") ||
      (Array.isArray(quals) && quals.some(q => {
        const s = String(q).toUpperCase();
        return s.includes("AEMT") || s.includes("PARAMEDIC");
      }));

    const isEMT =
      (!isALS) && (cert.includes("EMT") || (Array.isArray(quals) && quals.some(q => String(q).toUpperCase().includes("EMT"))));

    const first = (m.first_name || m.firstName || "").toString().trim();
    const last  = (m.last_name  || m.lastName  || "").toString().trim();
    const nm =
      (m.name || m.full_name || m.display_name || m.last_first || `${first} ${last}`.trim() || id).toString().trim();

    byId[id] = {
      name: nm,
      first: first || nm.split(" ")[0] || nm,
      tier: isALS ? "ALS" : (isEMT ? "EMT" : "UNK"),
      raw: m
    };
  }
  return byId;
}

/** ========= SCHEDULE NORMALIZE ========= **/
function normalizePair(pair){
  const a = (pair && pair[0]) ? String(pair[0]).trim() : "OPEN";
  const d = (pair && pair[1]) ? String(pair[1]).trim() : "OPEN";
  return [a || "OPEN", d || "OPEN"];
}
function getDay(schedule, iso){
  const obj = schedule[iso] || {};
  const am = normalizePair(obj.AM || obj.am || obj.Am || ["OPEN","OPEN"]);
  const pm = normalizePair(obj.PM || obj.pm || obj.Pm || ["OPEN","OPEN"]);
  const flags = obj.flags || [];
  const notes = obj.notes || {};
  const unit = (obj && typeof obj === 'object' && obj._unit && typeof obj._unit === 'object') ? obj._unit : null;
  return { am, pm, flags, notes, unit };
}

/** ========= SEAT ACTIVITY ========= **/
function seatsForDateShift(iso, shift, org){
  try{
    const sh = String(shift||"").toUpperCase();
    const day = (org && org.active_seats_by_date && org.active_seats_by_date[iso]) ? org.active_seats_by_date[iso] : null;

    if(day && Object.prototype.hasOwnProperty.call(day, sh)){
      const v = day[sh];
      if(Array.isArray(v)) return v.map(String);
    }

    const def = (org && org.ops_defaults && org.ops_defaults.seats)
      ? (org.ops_defaults.seats[sh] || org.ops_defaults.seats[sh.toLowerCase()])
      : null;
    if(Array.isArray(def)) return def.map(String);

    return null;
  }catch(_e){
    return null;
  }
}
function isNoSeating(arr){ return Array.isArray(arr) && arr.length === 0; }

/** ========= OPTIONAL AVAILABILITY (flags impossible assignments) ========= **/
function buildAvailIndex(availPayload){
  // Supports a few common shapes:
  // 1) availability_by_member[memberId][iso] => {AM:true/false, PM:true/false}
  // 2) [memberId][iso] => {AM:true/false, PM:true/false}
  // 3) member_availability: [{member_id, date, AM, PM}]
  const p = (availPayload && typeof availPayload === "object") ? availPayload : {};
  if(p.availability_by_member && typeof p.availability_by_member === "object") return p.availability_by_member;

  const looksLikeIndex = Object.keys(p).some(k => typeof p[k] === "object" && p[k] && !Array.isArray(p[k]));
  if(looksLikeIndex) return p;

  const out = {};
  const list =
    Array.isArray(p) ? p :
    Array.isArray(p.member_availability) ? p.member_availability :
    Array.isArray(p.availability) ? p.availability :
    [];
  for(const row of list){
    const id = String(row.member_id || row.id || row.memberId || "").trim();
    const iso = String(row.date || row.iso || row.day || "").slice(0,10);
    if(!id || !iso) continue;
    out[id] ||= {};
    out[id][iso] ||= {};
    if("AM" in row) out[id][iso].AM = !!row.AM;
    if("PM" in row) out[id][iso].PM = !!row.PM;
  }
  return out;
}
function isAvailable(avIdx, memberId, iso, shift){
  try{
    if(!avIdx) return null; // unknown
    const m = avIdx[String(memberId||"").trim()];
    if(!m) return null;
    const d = m[String(iso||"").trim()];
    if(!d) return null;
    const sh = String(shift||"").toUpperCase();
    if(sh in d) return !!d[sh];
    return null;
  }catch(_e){
    return null;
  }
}

/** ========= HEALTH RULES ========= **/
function digitsFromUnit(unitId){
  const s = String(unitId || "").trim();
  if(!s) return "";
  const m = s.match(/(\d{3})(?!\d)/);
  return m ? m[1] : s;
}
function truckLabelForDate(iso, org){
  const au = (org && org.active_units_by_date && org.active_units_by_date[iso]) ? org.active_units_by_date[iso] : null;
  if(!au) return "";
  const a = digitsFromUnit(au.AM || "");
  const p = digitsFromUnit(au.PM || "");
  if(!a && !p) return "";
  if(a && (!p || p === a)) return a;
  if(!a && p) return p;
  return a + "/" + p;
}
function unitPillText(dayObj, org, iso){
  const u = dayObj && dayObj.unit ? dayObj.unit : null;
  const am = u && u.AM ? String(u.AM).trim() : "";
  const pm = u && u.PM ? String(u.PM).trim() : "";
  if(am && pm) return (am === pm) ? am : `AM ${am} ‚Ä¢ PM ${pm}`;
  if(am) return `AM ${am}`;
  if(pm) return `PM ${pm}`;
  const t = truckLabelForDate(iso, org);
  return t ? String(t) : "";
}

function healthColor(h){
  if(h==="GREEN") return "var(--g)";
  if(h==="YELLOW") return "var(--y)";
  if(h==="RED") return "var(--red)";
  return "var(--gray)";
}
function shiftHealth(attId, drvId, roster, seatsArr, violation){
  if(isNoSeating(seatsArr)) return "GRAY";
  if(violation) return "RED";

  const att = roster[attId];
  const drv = roster[drvId];

  const attTier = (attId === "OPEN") ? "OPEN" : (att?.tier || "UNK");
  const drvTier = (drvId === "OPEN") ? "OPEN" : (drv?.tier || "UNK");

  // Minimum rules for display health:
  // - Attendant should be ALS (or OPEN means unfilled)
  // - Driver should not be OPEN
  if(attId === "OPEN" || attTier !== "ALS") return "RED";
  if(drvId === "OPEN") return "RED";
  if(drvTier === "EMT") return "GREEN";
  if(drvTier === "ALS") return "YELLOW";
  return "YELLOW";
}

function dayHealth(dayObj, roster, iso, org, avIdx){
  const [amA, amD] = dayObj.am;
  const [pmA, pmD] = dayObj.pm;
  const amSeats = seatsForDateShift(iso, "AM", org);
  const pmSeats = seatsForDateShift(iso, "PM", org);

  const amV =
    (isAvailable(avIdx, amA, iso, "AM") === false) ||
    (isAvailable(avIdx, amD, iso, "AM") === false);
  const pmV =
    (isAvailable(avIdx, pmA, iso, "PM") === false) ||
    (isAvailable(avIdx, pmD, iso, "PM") === false);

  const ranks = { RED:3, YELLOW:2, GREEN:1, GRAY:0 };
  const amH = shiftHealth(amA, amD, roster, amSeats, amV);
  const pmH = shiftHealth(pmA, pmD, roster, pmSeats, pmV);
  return (ranks[amH] >= ranks[pmH]) ? amH : pmH;
}

function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function nameFor(id, roster){
  if(!id || id === "OPEN") return `<span class="open">OPEN</span>`;
  const r = roster[id];
  let nm = (r?.name || "Assigned").toString();
  if(USE_FIRST_NAME && r?.first) nm = String(r.first);
  return escapeHtml(nm);
}
function lineWithAvail(id, roster, avIdx, iso, shift){
  const base = nameFor(id, roster);
  if(!id || id === "OPEN") return base;
  const ok = isAvailable(avIdx, id, iso, shift);
  if(ok === false) return `${base} <span class="warn-badge">‚ö† AVAIL</span>`;
  return base;
}

/** ========= RENDER ========= **/
function renderWeek(root, weekStartDate, schedule, roster, org, avIdx, label){
  const weekEnd = addDays(weekStartDate, 6);
  const range = fmtRange(weekStartDate, weekEnd);

  const week = document.createElement("div");
  week.className = "week";

  const head = document.createElement("div");
  head.className = "week-head";
  head.innerHTML = `
    <div class="week-title">${escapeHtml(label || "")}</div>
    <div class="week-dates">${escapeHtml(range)}</div>
  `;
  week.appendChild(head);

  const grid = document.createElement("div");
  grid.className = "grid";

  const todayIso = isoDate(new Date());

  for(let i=0;i<7;i++){
    const d = addDays(weekStartDate, i);
    const iso = isoDate(d);
    const dayObj = getDay(schedule, iso);

    const h = dayHealth(dayObj, roster, iso, org, avIdx);
    const truck = unitPillText(dayObj, org, iso);

    const [amA, amD] = dayObj.am;
    const [pmA, pmD] = dayObj.pm;

    const amSeats = seatsForDateShift(iso, "AM", org);
    const pmSeats = seatsForDateShift(iso, "PM", org);
    const amNoSeat = isNoSeating(amSeats);
    const pmNoSeat = isNoSeating(pmSeats);

    const day = document.createElement("div");
    day.className = "day" + (iso===todayIso ? " today" : "") + (iso < todayIso ? " past" : "");

    const health = document.createElement("div");
    health.className = "health";
    health.style.background = healthColor(h);

    const tile = document.createElement("div");
    tile.className = "tile";

    tile.innerHTML = `
      <div class="dayhead">
        <div class="daynum">${d.getDate()}</div>
        <div>${truck ? `<span class="truckpill">${escapeHtml(truck)}</span>` : ""}</div>
        <div class="iso">${iso}</div>
      </div>

      <div class="slot">
        <div class="tag">AM</div>
        <div class="lines">
          ${amNoSeat
            ? `<div class="line open">N/A</div>`
            : `<div class="line">${lineWithAvail(amA, roster, avIdx, iso, "AM")}</div>
               <div class="line">${lineWithAvail(amD, roster, avIdx, iso, "AM")}</div>`
          }
        </div>
      </div>

      <div class="slot">
        <div class="tag">PM</div>
        <div class="lines">
          ${pmNoSeat
            ? `<div class="line open">N/A</div>`
            : `<div class="line">${lineWithAvail(pmA, roster, avIdx, iso, "PM")}</div>
               <div class="line">${lineWithAvail(pmD, roster, avIdx, iso, "PM")}</div>`
          }
        </div>
      </div>
    `;

    day.appendChild(health);
    day.appendChild(tile);
    grid.appendChild(day);
  }

  week.appendChild(grid);
  root.appendChild(week);
}

async function loadData(){
  const [scheduleResp, membersResp] = await Promise.all([
    fetchJson(storeUrl(KIND_SCHEDULE)),
    fetchJson(storeUrl(KIND_MEMBERS))
  ]);

  let org = {};
  try{
    const orgResp = await fetchJson(storeUrl(KIND_ORG));
    org = (orgResp && orgResp.payload) ? orgResp.payload : (orgResp || {});
  }catch(_e){ org = {}; }

  // Optional availability
  let avIdx = null;
  try{
    const avResp = await fetchJson(storeUrl(KIND_AVAIL_1));
    const avPayload = (avResp && avResp.payload) ? avResp.payload : avResp;
    avIdx = buildAvailIndex(unwrapStorePayload(avPayload));
  }catch(_e1){
    try{
      const avResp2 = await fetchJson(storeUrl(KIND_AVAIL_2));
      const avPayload2 = (avResp2 && avResp2.payload) ? avResp2.payload : avResp2;
      avIdx = buildAvailIndex(unwrapStorePayload(avPayload2));
    }catch(_e2){
      avIdx = null;
    }
>>>>>>> parent of 334f017 (Update wallboard.html)
  }

  const schedule = unwrapStorePayload(scheduleResp);
  const roster   = buildRosterIndex(membersResp);
  return { schedule, roster, org, avIdx };
}

function hashLite(obj){
  try{
    const s = JSON.stringify(obj);
    let h = 0;
    for(let i=0;i<s.length;i++){
      h = ((h<<5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    return String(h);
  }catch(_e){
    return String(Date.now());
  }
}

function renderAll(root, schedule, roster, org, avIdx){
  root.innerHTML = "";

  const now = new Date();
  const thisWeekStart = startOfWeek(now);
  const wantWeeks = document.body.classList.contains("portrait") ? WEEKS_PORTRAIT : WEEKS_LANDSCAPE;

  // Build list: (optional) archived, then controlled (this + next), then future
  const starts = [];

  if(SHOW_ARCHIVED){
    starts.push({ start: addDays(thisWeekStart, -7), label:"Archived" });
  }
  starts.push({ start: thisWeekStart, label:"Controlled" });
  starts.push({ start: addDays(thisWeekStart,  7), label:"Controlled" });

  let off = 14;
  while(starts.length < wantWeeks){
    starts.push({ start: addDays(thisWeekStart, off), label:"Future" });
    off += 7;
  }

  for(const b of starts){
    renderWeek(root, b.start, schedule, roster, org, avIdx, b.label);
  }
}

async function refreshBoard({initial=false, force=false}={}){
  const pill = document.getElementById("statusPill");
  const root = document.getElementById("root");

  try{
    pill.textContent = initial ? "Loading‚Ä¶" : "Refreshing‚Ä¶";
    const data = await loadData();

    document.getElementById("buildTag").textContent = "v2026-02-01.static-weeks+avail-flags";

    window.__sc_lastHash ||= "";
    const h = hashLite({ schedule: data.schedule, roster: data.roster, org: data.org, archived: SHOW_ARCHIVED });

    if(!force && !initial && h === window.__sc_lastHash){
      const ra = data.schedule && data.schedule.meta ? data.schedule.meta.resolved_at : null;
      const t = ra ? fmtLocalTimeFromIso(ra) : "";
      pill.textContent = ra && t ? ("Updated " + t + " ‚Ä¢ Live") : "Live";
      pill.style.color = "#166534";
      const foot = document.getElementById("resolverFooter");
      if(foot){
        foot.innerHTML = ra
          ? (`Last resolver run: <strong>${escapeHtml(fmtLocalDateTimeFromIso(ra))}</strong>`)
          : "Last resolver run: <strong>Unknown</strong>";
      }
      return;
    }
    window.__sc_lastHash = h;

    const temp = document.createElement("div");
    temp.style.display = "contents";
    renderAll(temp, data.schedule, data.roster, data.org, data.avIdx);

    if(!initial){
      root.style.opacity = "0.18";
      setTimeout(()=>{
        root.innerHTML = temp.innerHTML;
        root.style.opacity = "1";
      }, 160);
    }else{
      root.innerHTML = temp.innerHTML;
      root.style.opacity = "1";
    }

    const ra = data.schedule && data.schedule.meta ? data.schedule.meta.resolved_at : null;
    const t = ra ? fmtLocalTimeFromIso(ra) : "";
    pill.textContent = ra && t ? ("Updated " + t + " ‚Ä¢ Live") : "Live";
    pill.title = (ra ? ("Resolved: " + fmtLocalDateTimeFromIso(ra)) : "No resolve stamp yet");
    pill.style.color = "#166534";

    const foot = document.getElementById("resolverFooter");
    if(foot){
      foot.innerHTML = ra ? (`Last resolver run: <strong>${escapeHtml(fmtLocalDateTimeFromIso(ra))}</strong>`) : "Last resolver run: <strong>Unknown</strong>";
    }

  }catch(err){
    console.error(err);
    pill.textContent = "Load failed";
    pill.style.color = "#b91c1c";
    root.innerHTML = `<div class="pill" style="border-color:#fecaca;color:#b91c1c">
      ${escapeHtml(String(err.message || err))}
    </div>`;
  }
}

refreshBoard({initial:true});
setInterval(()=> refreshBoard({initial:false}), AUTO_REFRESH_MS);
</script>

<script>
(function(){
  function show(msg){
    try{
      var d=document.getElementById('scFatal');
      if(!d){
        d=document.createElement('div');
        d.id='scFatal';
        d.style.cssText='position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);color:#fff;padding:14px;font:14px/1.35 ui-monospace,Menlo,Consolas,monospace;overflow:auto;';
        d.innerHTML='<div style="font-weight:900;font-size:16px;margin-bottom:8px;">ShiftCommander error</div><pre id="scFatalMsg" style="white-space:pre-wrap;margin:0;"></pre>';
        document.body.appendChild(d);
      }
      var pre=document.getElementById('scFatalMsg');
      if(pre) pre.textContent=String(msg||'Unknown error');
    }catch(_e){}
  }
  window.addEventListener('error', function(e){
    show((e && (e.message||e.error)) ? (e.message||e.error) : e);
  });
  window.addEventListener('unhandledrejection', function(e){
    show('Unhandled Promise rejection: ' + (e && e.reason ? (e.reason.stack||e.reason.message||String(e.reason)) : 'unknown'));
  });
})();
</script>

</body>
</html>
