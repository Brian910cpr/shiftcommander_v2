<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADR-FR Wallboard — Display-only Health</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.12);
      --text:#e7ecff;
      --muted:#a9b3d6;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --plan:#60a5fa;

      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --r:14px;

      /* Color-deficiency friendly borders */
      --b-ok:    0 0 0 3px rgba(34,197,94,.60),  0 0 0 6px rgba(34,197,94,.18);
      --b-warn:  0 0 0 3px rgba(245,158,11,.65), 0 0 0 6px rgba(245,158,11,.18);
      --b-bad:   0 0 0 3px rgba(239,68,68,.70),  0 0 0 6px rgba(239,68,68,.22);
      --b-plan:  0 0 0 3px rgba(96,165,250,.70), 0 0 0 6px rgba(96,165,250,.18);
      --b-neutral: 0 0 0 2px rgba(148,163,184,.25);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 700px at 20% -20%, rgba(124,92,255,.30), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(88,166,255,.22), transparent 52%),
        linear-gradient(180deg, #060a18, var(--bg));
      color:var(--text);
      overflow:hidden;
    }

    .top{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px;
      background: rgba(8,12,28,.70);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .brand{ display:flex; align-items:baseline; gap:10px; font-weight:950; letter-spacing:.2px; white-space:nowrap; }
    .brand small{ font-weight:850; color:var(--muted); }
    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      font-size:12px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#94a3b8; box-shadow:0 0 0 4px rgba(148,163,184,.14); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.14); }
    .dot.warn{ background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.14); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.14); }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      padding:6px 9px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }

    .wrap{
      height: calc(100vh - 44px);
      padding:8px 10px 12px;
      overflow:hidden;
    }
    .board{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    details.section{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    details.section > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.16);
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:950;
      font-size:13px;
    }
    details.section > summary::-webkit-details-marker{ display:none; }
    .sLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .sTitle{ white-space:nowrap; }
    .sHelp{ color:var(--muted); font-weight:850; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }

    .weeks{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .weekRow{
      display:grid;
      grid-template-columns: 165px repeat(7, minmax(0, 1fr));
      gap:6px;
      padding:8px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
    }

    .weekRow.state-controlled{ box-shadow: var(--b-warn); }
    .weekRow.state-published{  box-shadow: var(--b-ok); }
    .weekRow.state-planning{   box-shadow: var(--b-plan); }
    .weekRow.state-archived{   box-shadow: var(--b-neutral); }

    .weekMeta{
      padding:6px 8px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
      min-width:0;
    }
    .wkTitle{ font-weight:950; letter-spacing:.2px; line-height:1.05; font-size: 13px; }
    .wkRange{ font-weight:850; color:var(--muted); font-size: 12px; line-height:1.1; }
    .wkMini{ font-weight:900; font-size:11px; color:var(--muted); }

    .dayCell{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
      padding:6px 8px;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .dayTop{ display:flex; align-items:baseline; justify-content:space-between; gap:8px; white-space:nowrap; }
    .dow{ font-weight:950; font-size:11px; color:var(--muted); letter-spacing:.4px; }
    .dayNum{ font-weight:950; font-size:14px; letter-spacing:.2px; }
    .obs{ font-weight:950; font-size:11px; color:rgba(231,236,255,.85); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }
    .obs span{ opacity:.9; }

    .slot{
      display:grid;
      grid-template-columns: 26px 1fr;
      gap:6px;
      align-items:start;
      border-top:1px solid rgba(255,255,255,.06);
      padding-top:4px;
    }
    .slot:first-of-type{ border-top:none; padding-top:0; }
    .slotLabel{ font-weight:950; font-size:11px; color:var(--muted); }
    .names{
      display:grid;
      grid-auto-rows: min-content;
      gap:2px;
      min-width:0;
    }
    .name{
      font-weight:950;
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      line-height:1.15;
    }
    .name.open{ color: rgba(231,236,255,.55); font-weight:900; }

    /* Health strip: display-only */
    .healthStrip{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin-top:6px;
    }
    .healthDay{
      display:grid;
      grid-template-rows: 10px 10px;
      gap:3px;
      border-radius:8px;
      padding:4px 5px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .hBox{
      border-radius:6px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(148,163,184,.18); /* unknown */
      position:relative;
      overflow:hidden;
    }
    .hBox.ok{ background: rgba(34,197,94,.28); border-color: rgba(34,197,94,.50); }
    .hBox.warn{ background: rgba(245,158,11,.26); border-color: rgba(245,158,11,.50); }
    .hBox.bad{ background: rgba(239,68,68,.24); border-color: rgba(239,68,68,.50); }

    /* pattern overlay for accessibility */
    .hBox.bad::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.18) 0 4px, rgba(255,255,255,0) 4px 8px);
      opacity:.55;
    }
    .hBox.warn::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(45deg, rgba(255,255,255,.14) 0 5px, rgba(255,255,255,0) 5px 10px);
      opacity:.45;
    }

    .fatal{
      margin:8px 10px 0;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(239,68,68,.45);
      background: rgba(239,68,68,.14);
      color:#ffe4e6;
      font-weight:900;
      display:none;
      font-size:12px;
    }
    .fatal code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Debug scroll */
    body.scroll .wrap{ overflow:auto; }
    body.scroll{ overflow:auto; }
    body.scroll .board{ overflow:auto; padding-bottom:40px; }

    @media (max-width: 1200px){
      .weekRow{ grid-template-columns: 155px repeat(7, minmax(0, 1fr)); }
      .name{ font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">
      Wallboard <small>display-only health • build 2026-02-02</small>
    </div>
    <div class="controls">
      <button class="btn" id="btnShift" title="Toggle view: Both → Night → Day">Both</button>
      <button class="btn" id="btnNames" title="Toggle name style">Name: First</button>
      <span class="chip" id="chipStatus"><span class="dot warn" id="dot"></span><span id="status">Loading…</span></span>
      <span class="chip"><span id="updated">—</span></span>
    </div>
  </div>

  <div class="fatal" id="fatal"></div>

  <div class="wrap">
    <div class="board" id="board"></div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const STORE_BASE = "https://store.adr-fr.org";
  const LS_TOKEN = "sc_token";

  const OPT = {
    scroll: qs.get("scroll")==="1",
    refreshSec: clampInt(qs.get("refresh"), 10, 3600, 60),
    weeks: clampInt(qs.get("weeks"), 3, 24, 12),
    name: clampInt(qs.get("name"), 1, 6, 1),
    controlled: clampInt(qs.get("controlled"), 1, 4, 2),
    published: clampInt(qs.get("published"), 1, 6, 2),
    planning: clampInt(qs.get("planning"), 2, 12, 6),
    hol: qs.get("hol")==="1"
  };
  if(OPT.scroll) document.body.classList.add("scroll");

  function clampInt(v,min,max,def){
    const n = Number(v);
    if(!Number.isFinite(n)) return def;
    const i = Math.floor(n);
    return Math.max(min, Math.min(max, i));
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function fatal(msg, err){
    const el = document.getElementById("fatal");
    el.style.display = "block";
    el.innerHTML = "WALLBOARD ERROR: " + escapeHtml(msg) + (err ? " <code>"+escapeHtml(err.message||String(err))+"</code>" : "");
    setStatus("bad","Error");
  }
  function setStatus(kind, text){
    const dot = document.getElementById("dot");
    dot.className = "dot " + (kind||"warn");
    document.getElementById("status").textContent = text;
  }
  function setUpdated(text){ document.getElementById("updated").textContent = text; }

  function getToken(){ try{ return localStorage.getItem(LS_TOKEN) || ""; }catch(e){ return ""; } }
  async function storeGet(kind){
    const url = new URL(STORE_BASE);
    url.searchParams.set("kind", kind);
    const token = getToken();
    if(token) url.searchParams.set("token", token);
    const resp = await fetch(url.toString(), { method:"GET", cache:"no-store" });
    const text = await resp.text();
    let j = null;
    try{ j = JSON.parse(text); }catch(e){}
    if(!resp.ok) throw new Error("Store GET "+kind+" failed ("+resp.status+")");
    return j ?? text;
  }
  function unwrapStorePayload(resp){
    if(resp && typeof resp === "object"){
      if(resp.payload !== undefined) return resp.payload;
      if(resp.data !== undefined) return resp.data;
      if(resp.value !== undefined) return resp.value;
      if(resp.body !== undefined) return resp.body;
      if(resp.ok && resp.kind && resp.result !== undefined) return resp.result;
    }
    return resp;
  }
  function normalizeScheduleMap(s){
    if(!s || typeof s !== "object") return {};
    if(s.schedule && typeof s.schedule === "object") return s.schedule;
    return s;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(d){
    const dt = new Date(d.getTime());
    dt.setUTCHours(0,0,0,0);
    return dt.getUTCFullYear()+"-"+pad2(dt.getUTCMonth()+1)+"-"+pad2(dt.getUTCDate());
  }
  function parseIso(s){
    const [y,m,d] = String(s).split("-").map(Number);
    if(!y||!m||!d) return null;
    const dt = new Date(Date.UTC(y,m-1,d));
    dt.setUTCHours(0,0,0,0);
    return dt;
  }
  function addDays(dateObj, n){
    const d = new Date(dateObj.getTime());
    d.setUTCDate(d.getUTCDate()+n);
    return d;
  }
  function startOfWeekSunday(dateObj){
    const d = new Date(dateObj.getTime());
    const dow = d.getUTCDay();
    d.setUTCDate(d.getUTCDate()-dow);
    d.setUTCHours(0,0,0,0);
    return d;
  }
  function fmtRange(start){
    const end = addDays(start, 6);
    const opts = { month:"short", day:"numeric" };
    const a = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
    const b = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));
    return a.toLocaleDateString(undefined, opts) + " – " + b.toLocaleDateString(undefined, opts);
  }
  const DOW = ["SUN","MON","TUE","WED","THU","FRI","SAT"];

  // ===== Name modes =====
  function splitName(full){
    const s = String(full||"").trim().replace(/\s+/g," ");
    if(!s) return { first:"", last:"", parts:[] };
    const parts = s.split(" ");
    return { first: parts[0]||"", last: parts.length>1 ? parts[parts.length-1] : "", parts };
  }
  function initials(parts){ return parts.filter(Boolean).map(p => (p[0]||"").toUpperCase()).join(""); }
  function formatName(memberObj, idStr){
    const base = String(memberObj?.display_name || memberObj?.name || memberObj?.callsign || idStr).trim();
    const { first, last, parts } = splitName(base);
    const single = parts.length<=1;
    switch(OPT.name){
      case 2: return single ? base.toUpperCase().slice(0,3) : initials(parts);
      case 3: return single ? base : ((first?first[0].toUpperCase()+".":"") + (last?(" "+last):"")).trim();
      case 4: return single ? base : ((first||base) + (last?(" "+last[0].toUpperCase()+"."):"")).trim();
      case 5: return single ? base : ((first||"") + (last?(" "+last):"")).trim();
      case 6: return String(memberObj?.callsign||"").trim() || (first||base);
      case 1:
      default: return first || base;
    }
  }
  function nameModeLabel(){
    return {1:"First",2:"Initials",3:"F.Last",4:"First L.",5:"First Last",6:"Callsign"}[OPT.name] || "First";
  }

  // ===== Slot parsing (supports optional third rider) =====
  function getSlot(schedule, dateIso, shift){
    const day = schedule?.[dateIso];
    if(!day || typeof day !== "object") return null;
    return day?.[shift] || day?.[shift.toLowerCase?.()] || null;
  }
  function listIds(slot){
    if(!slot) return ["OPEN","OPEN"];
    if(Array.isArray(slot)) return slot.map(x=>x||"OPEN");
    if(slot && typeof slot === "object"){
      const out = [];
      if(slot.attendant !== undefined) out.push(slot.attendant);
      if(slot.operator !== undefined) out.push(slot.operator);
      if(slot.third !== undefined) out.push(slot.third);
      if(out.length) return out.map(x=>x||"OPEN");
    }
    return ["OPEN","OPEN"];
  }
  function isOpen(v){
    const s = String(v||"").trim().toUpperCase();
    return !s || s==="OPEN" || s==="-" || s==="—";
  }

  // ===== Health lookup (display-only) =====
  function getHealthMeta(schedule){
    // accept schedule.meta.health_v1 or schedule.health_v1 if older
    const meta = (schedule && typeof schedule==="object") ? schedule.meta : null;
    const hv = meta?.health_v1 || schedule?.health_v1 || null;
    return hv && typeof hv==="object" ? hv : null;
  }
  function getHealthFor(hv, dateIso, shift){
    if(!hv || !hv.days) return "unknown";
    const day = hv.days[dateIso];
    if(!day) return "unknown";
    const v = day[shift] || day[shift.toLowerCase?.()] || "unknown";
    return ["ok","warn","bad"].includes(v) ? v : "unknown";
  }

  // ===== Tier 1 observances (optional) =====
  function getObs(org, dateIso){
    if(!OPT.hol) return null;
    const o = org?.observances_v1?.[dateIso];
    if(!o) return null;
    const emoji = String(o.emoji||"").trim();
    const label = String(o.label||"").trim();
    if(!emoji && !label) return null;
    return {emoji,label};
  }

  function buildWeekStarts(schedule){
    const keys = Object.keys(schedule||{}).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
    const dates = keys.map(parseIso).filter(Boolean).sort((a,b)=>a-b);
    if(!dates.length){
      const t = new Date();
      const base = startOfWeekSunday(new Date(Date.UTC(t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate())));
      return Array.from({length:12}, (_,i)=>addDays(base, i*7));
    }
    const seen = new Set();
    const starts = [];
    for(const d of dates){
      const ws = startOfWeekSunday(d);
      const key = isoDate(ws);
      if(seen.has(key)) continue;
      seen.add(key);
      starts.push(ws);
    }
    return starts;
  }

  // ===== Render pieces =====
  let SHIFT_VIEW = "BOTH"; // BOTH | PM | AM

  function renderWeekRow({label, stateClass, ws, schedule, membersById, hv, showNames=true, showHealth=true, org=null}){
    const row = document.createElement("div");
    row.className = "weekRow " + stateClass;

    const meta = document.createElement("div");
    meta.className = "weekMeta";
    meta.innerHTML = `
      <div class="wkTitle">${escapeHtml(fmtRange(ws))}</div>
      <div class="wkRange">${escapeHtml(isoDate(ws))}</div>
      <div class="wkMini"><b>${escapeHtml(label)}</b> • health from Supervisor resolve</div>
    `;
    if(showHealth){
      const strip = document.createElement("div");
      strip.className = "healthStrip";
      for(let i=0;i<7;i++){
        const d = addDays(ws, i);
        const dateIso = isoDate(d);
        const day = document.createElement("div");
        day.className = "healthDay";

        const am = document.createElement("div");
        am.className = "hBox " + getHealthFor(hv, dateIso, "AM");

        const pm = document.createElement("div");
        pm.className = "hBox " + getHealthFor(hv, dateIso, "PM");

        day.appendChild(am); day.appendChild(pm);
        strip.appendChild(day);
      }
      meta.appendChild(strip);
    }
    row.appendChild(meta);

    for(let i=0;i<7;i++){
      const d = addDays(ws, i);
      const dateIso = isoDate(d);

      const cell = document.createElement("div");
      cell.className = "dayCell";
      const dow = DOW[d.getUTCDay()];
      const dayNum = String(new Date(dateIso+"T00:00:00").getDate());

      const obs = getObs(org, dateIso);
      const obsHtml = obs ? `<div class="obs"><span>${escapeHtml(obs.emoji)}</span> ${escapeHtml(obs.label)}</div>` : "";

      cell.innerHTML = `
        <div class="dayTop">
          <div class="dow">${dow}</div>
          <div class="dayNum">${dayNum}</div>
        </div>
        ${obsHtml}
      `;

      if(showNames){
        const shifts = (SHIFT_VIEW==="BOTH") ? ["AM","PM"] : [SHIFT_VIEW];
        for(const sh of shifts){
          const slot = getSlot(schedule, dateIso, sh);
          const ids = listIds(slot);

          const lines = ids.slice(0,3).map(id=>{
            const open = isOpen(id);
            const m = open ? null : (membersById[String(id)] || null);
            const nm = open ? "OPEN" : formatName(m, String(id));
            const cls = open ? "name open" : "name";
            return `<div class="${cls}" title="${escapeHtml(nm)}">${escapeHtml(nm)}</div>`;
          }).join("");

          const s = document.createElement("div");
          s.className = "slot";
          s.innerHTML = `<div class="slotLabel">${sh}</div><div class="names">${lines}</div>`;
          cell.appendChild(s);
        }
      }

      row.appendChild(cell);
    }
    return row;
  }

  function buildSection({title, help, countPill, open, rows}){
    const det = document.createElement("details");
    det.className = "section";
    det.open = !!open;

    const sum = document.createElement("summary");
    sum.innerHTML = `
      <div class="sLeft">
        <div class="sTitle">${escapeHtml(title)}</div>
        <div class="sHelp">${escapeHtml(help)}</div>
      </div>
      <div class="sRight">
        <span class="pill">${escapeHtml(countPill)}</span>
      </div>
    `;
    det.appendChild(sum);

    const box = document.createElement("div");
    box.className = "weeks";
    rows.forEach(r => box.appendChild(r));
    det.appendChild(box);
    return det;
  }

  // ===== Controls =====
  function syncButtons(){
    document.getElementById("btnShift").textContent = (SHIFT_VIEW==="BOTH") ? "Both" : (SHIFT_VIEW==="PM" ? "Night" : "Day");
    document.getElementById("btnNames").textContent = "Name: " + nameModeLabel();
  }
  document.getElementById("btnShift").addEventListener("click", ()=>{
    SHIFT_VIEW = (SHIFT_VIEW==="BOTH") ? "PM" : (SHIFT_VIEW==="PM" ? "AM" : "BOTH");
    syncButtons(); main();
  });
  document.getElementById("btnNames").addEventListener("click", ()=>{
    OPT.name = (OPT.name % 6) + 1;
    syncButtons(); main();
  });

  function membersById(members){
    const by = {};
    (Array.isArray(members)?members:[]).forEach(m=>{
      const id = String(m.member_id||"").trim();
      if(id) by[id] = m;
    });
    return by;
  }

  function partitionWeeks(starts, org){
    const wf = org?.workflow || {};
    const controlled = Number(wf.controlled_weeks || OPT.controlled);
    const published  = Number(wf.published_weeks  || OPT.published);
    const planning   = Number(wf.planning_weeks   || OPT.planning);

    return {
      controlled: starts.slice(0, controlled),
      published:  starts.slice(controlled, controlled + published),
      planning:   starts.slice(controlled + published, controlled + published + planning)
    };
  }

  async function loadData(){
    setStatus("warn","Loading…");
    const [orgResp, membersResp, schedResp] = await Promise.allSettled([
      storeGet("org_settings"),
      storeGet("members"),
      storeGet("schedule")
    ]);

    const org = (orgResp.status==="fulfilled") ? unwrapStorePayload(orgResp.value) : {};
    const members = (membersResp.status==="fulfilled") ? unwrapStorePayload(membersResp.value) : [];
    const scheduleRaw = (schedResp.status==="fulfilled") ? unwrapStorePayload(schedResp.value) : {};

    return { org, members, scheduleRaw };
  }

  function renderAll({org, members, scheduleRaw}){
    const board = document.getElementById("board");
    board.innerHTML = "";

    const schedule = normalizeScheduleMap(scheduleRaw);
    const hv = getHealthMeta(scheduleRaw) || getHealthMeta(schedule);

    const mBy = membersById(members);

    const startsAll = buildWeekStarts(schedule).slice(0, OPT.weeks);
    const parts = partitionWeeks(startsAll, org);

    const controlledRows = parts.controlled.map(ws => renderWeekRow({
      label:"Controlled",
      stateClass:"state-controlled",
      ws, schedule, membersById:mBy, hv,
      showNames:true, showHealth:true,
      org
    }));

    const publishedRows = parts.published.map(ws => renderWeekRow({
      label:"Published",
      stateClass:"state-published",
      ws, schedule, membersById:mBy, hv,
      showNames:true, showHealth:true,
      org
    }));

    const planningRows = parts.planning.map(ws => renderWeekRow({
      label:"Planning",
      stateClass:"state-planning",
      ws, schedule, membersById:mBy, hv,
      showNames:false, showHealth:true,
      org
    }));

    board.appendChild(buildSection({
      title:"Controlled",
      help:"Firm schedule. Changes require Supervisor review only.",
      countPill:`${controlledRows.length} week(s)`,
      open:true,
      rows: controlledRows
    }));

    board.appendChild(buildSection({
      title:"Published",
      help:"Drop / swap requests encouraged early. Avoid last-minute chaos.",
      countPill:`${publishedRows.length} week(s)`,
      open:true,
      rows: publishedRows
    }));

    board.appendChild(buildSection({
      title:"Planning",
      help:"Names hidden. Health strip is display-only and comes from Supervisor resolve.",
      countPill:`${planningRows.length} week(s)`,
      open:false,
      rows: planningRows
    }));

    setStatus(hv ? "ok" : "warn", hv ? "Live" : "No health_v1 yet");
    setUpdated("Updated " + new Date().toLocaleTimeString());
  }

  async function main(){
    try{
      syncButtons();
      const data = await loadData();
      renderAll(data);
    }catch(e){
      console.error(e);
      fatal("Load/render failed", e);
      setUpdated(new Date().toLocaleTimeString());
    }
  }

  // Boot
  try{
    setStatus("warn","Booting…");
    syncButtons();
    main();
    setInterval(main, OPT.refreshSec * 1000);
  }catch(e){
    console.error(e);
    fatal("Startup failed", e);
  }
})();
</script>
</body>
</html>
