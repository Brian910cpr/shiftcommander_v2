<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftCommander — Wallboard</title>
  <style>
    :root{
      --bg:#061025; --text:#e8eefc; --muted:#a7b3d6;
      --good:#19c37d; --warn:#f7b955; --bad:#ff5c5c; --gray:#6b7aa7;
      --bd: rgba(37,50,84,.85);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1400px 900px at 15% 10%, #102a5e 0%, var(--bg) 55%);
      color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:rgba(6,16,37,.75);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(37,50,84,.75);}
    .wrap{max-width:1400px;margin:0 auto;padding:12px 14px;}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .pill{padding:8px 10px;border-radius:999px;background:rgba(22,32,71,.65);
      border:1px solid rgba(37,50,84,.85);color:var(--muted);font-size:12px;}
    .board{padding:12px 14px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{border-top:1px solid rgba(37,50,84,.65);padding:10px 8px;vertical-align:middle}
    th{color:var(--muted);font-size:12px;font-weight:700;border-top:none}
    .dcol{width:160px}
    .scol{width:64px}
    .hcol{width:190px}
    .health{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(37,50,84,.85);background:rgba(22,32,71,.55);font-size:12px;white-space:nowrap;}
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.green{background:var(--good)} .dot.yellow{background:var(--warn)} .dot.red{background:var(--bad)} .dot.gray{background:var(--gray)}
    .seat{display:flex;flex-direction:column;gap:2px}
    .name{font-weight:900;font-size:13px;line-height:1.15}
    .lvl{color:var(--muted);font-size:11px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>ShiftCommander — Wallboard</h1>
        <div class="sub" id="status">Loading…</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span class="pill" id="orgpill">Org: …</span>
        <span class="pill" id="rangePill">Range: …</span>
      </div>
    </div>
  </div>
</header>

<div class="wrap board">
  <table>
    <thead>
      <tr>
        <th class="dcol">Date</th>
        <th class="scol">Shift</th>
        <th class="hcol">Health</th>
        <th>Medical</th>
        <th>Driver/EMT</th>
        <th>Riders</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>
</div>

<script>
/* ===================== Drive Store (Apps Script) ===================== */
const STORE = {
  url: "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec",
  token: "BC3BD023C58CB9B909CCDC6C8D4EDCE3EFFD1EC2BC2571F8A0D2B0F6974E6741"
};
async function storeGet(params){
  const u = new URL(STORE.url);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, String(v)));
  u.searchParams.set("token", STORE.token);
  const r = await fetch(u.toString(), { cache: "no-store" });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store GET failed");
  return j.payload;
}

const PATHS = {
  org: "./data/org_settings.json",
  historyIndex: "./data/history/history.index.json",
  supervisorPatchFile: "./data/overrides/supervisor_patch.json"
};

function $(id){return document.getElementById(id);}
function fmtISO(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function parseISO(s){const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d);}
function addDays(d,n){const x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x;}
function startOfWeekThursday(anyDate){
  const target=4; // Thu
  const d=new Date(anyDate.getFullYear(), anyDate.getMonth(), anyDate.getDate());
  const dow=d.getDay();
  const delta=(dow-target+7)%7;
  return addDays(d,-delta);
}
async function fetchJSON(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(`Fetch failed ${r.status}: ${url}`);
  return await r.json();
}
async function tryFetchJSON(url){
  try{ return await fetchJSON(url); }catch(e){ return null; }
}

const LEAD_DAYS = 21;
function isWithinLead(dateISO){
  const today = new Date();
  const d = new Date(dateISO + "T00:00:00");
  const ms = d.getTime() - new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
  const daysOut = Math.floor(ms / (1000*60*60*24));
  return daysOut <= LEAD_DAYS;
}

let ORG=null;
let HISTORY={ days:{} };
let PATCH={ generated_at:null, overrides:{} };

function getHistoryShift(dateISO, shift){
  return HISTORY.days?.[dateISO]?.[shift] || null;
}
function getPatchShift(dateISO, shift){
  return PATCH.overrides?.[dateISO]?.[shift] || null;
}
function mergeShiftView(dateISO, shift){
  const base=getHistoryShift(dateISO, shift) || {
    medical:{name:"Open", level:""},
    driver_emt:{name:"Open", level:""},
    riders:[]
  };
  const p=getPatchShift(dateISO, shift);
  const riders_allowed = (p && typeof p.riders_allowed==="boolean") ? p.riders_allowed : (base.riders_allowed ?? ((ORG?.riders?.default_allowed===true)?true:false));
  const riders_max     = (p && typeof p.riders_max==="number") ? p.riders_max : (base.riders_max ?? (ORG?.riders?.default_max_per_shift ?? 1));
  const riders         = (p && Array.isArray(p.riders)) ? p.riders : (Array.isArray(base.riders) ? base.riders : []);
  return {...base, riders_allowed, riders_max, riders};
}

function computeHealth(dateISO, shiftObj){
  if(!isWithinLead(dateISO)) return {state:"gray", msg:"Outside lead window"};

  const medical=shiftObj?.medical||null;
  const driver=shiftObj?.driver_emt||null;

  const medicalFilled=!!medical?.name && medical.name.toLowerCase()!=="open";
  const driverFilled=!!driver?.name && driver.name.toLowerCase()!=="open";

  if(!medicalFilled || !driverFilled) return {state:"red", msg:"Open seat"};

  const medLevel=(medical.level||"").toUpperCase();
  const drvLevel=(driver.level||"").toUpperCase();

  if(medLevel!=="ALS") return {state:"red", msg:"Needs ALS"};
  if(drvLevel==="ALS") return {state:"yellow", msg:"Needs EMT"};
  return {state:"green", msg:"Staffed"};
}

function seatCell(seat){
  const name = (seat?.name || "Open");
  const lvl  = (seat?.level || "");
  return `
    <div class="seat">
      <div class="name">${name}</div>
      <div class="lvl">${lvl}</div>
    </div>
  `;
}

function ridersCell(view){
  if(view.riders_allowed === false) return `<span class="muted">Disabled</span>`;
  const riders = view.riders || [];
  if(!riders.length) return `<span class="muted">—</span>`;
  return riders.map(r => `<span class="muted">${r.name || ("Member "+r.member_id)}</span>`).join("<br>");
}

function addRow(tbody, dateISO, shift){
  const view = mergeShiftView(dateISO, shift);
  const h = computeHealth(dateISO, view);
  const dotClass = (h.state==="green") ? "green" : (h.state==="yellow") ? "yellow" : (h.state==="red") ? "red" : "gray";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="dcol"><div style="font-weight:900">${dateISO}</div></td>
    <td class="scol"><div style="font-weight:900">${shift}</div></td>
    <td class="hcol"><div class="health"><span class="dot ${dotClass}"></span><span>${h.msg}</span></div></td>
    <td>${seatCell(view.medical)}</td>
    <td>${seatCell(view.driver_emt)}</td>
    <td>${ridersCell(view)}</td>
  `;
  tbody.appendChild(tr);
}

async function boot(){
  try{
    $("status").textContent = "Loading org/history/patch…";
    ORG = await fetchJSON(PATHS.org);
    $("orgpill").textContent = `Org: ${ORG?.org?.name || "Unknown"}`;

    // history
    const index = await fetchJSON(PATHS.historyIndex);
    const files = index?.files || [];
    const merged = { days:{} };
    for(const f of files){
      const monthUrl = f.filename ? `./data/history/${f.filename}` : f.path;
      const monthObj = await fetchJSON(monthUrl);
      if(monthObj?.days){
        for(const [ds, dayObj] of Object.entries(monthObj.days)){
          merged.days[ds] = merged.days[ds] || {};
          if(dayObj.AM) merged.days[ds].AM = dayObj.AM;
          if(dayObj.PM) merged.days[ds].PM = dayObj.PM;
        }
      }
    }
    HISTORY = merged;

    // patch (Drive first, fallback to file)
    try{
      PATCH = await storeGet({ kind:"supervisor" }) || { generated_at:null, overrides:{} };
    }catch(e){
      const filePatch = await tryFetchJSON(PATHS.supervisorPatchFile);
      PATCH = filePatch?.overrides ? filePatch : { generated_at:null, overrides:{} };
    }

    // render 7 weeks starting this Thu
    const start = startOfWeekThursday(new Date());
    const end = addDays(start, 7*7 - 1); // 49 days
    $("rangePill").textContent = `Range: ${fmtISO(start)} → ${fmtISO(end)}`;

    const tbody = $("body");
    tbody.innerHTML = "";
    for(let i=0;i<49;i++){
      const d = addDays(start, i);
      const ds = fmtISO(d);
      addRow(tbody, ds, "AM");
      addRow(tbody, ds, "PM");
    }

    $("status").textContent = "Ready.";
  }catch(err){
    console.error(err);
    $("status").textContent = "ERROR: " + err.message;
    alert("Wallboard failed to load:\n\n" + err.message);
  }
}

boot();
</script>
</body>
</html>
