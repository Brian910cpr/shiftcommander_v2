<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShiftCommander â€” Wallboard</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;margin:16px;}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,button{font:inherit;padding:6px 8px}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px}
th{background:#f6f6f6;text-align:left}
.small{font-size:12px;color:#666}
</style></head>
<body>
<h2>Wallboard</h2>
<div class="row">
  <label>Store URL <input id="store" size="80" placeholder="https://script.google.com/macros/s/DEPLOY/exec"></label>
  <label>Token <input id="token" size="30" placeholder="TOKEN"></label>
  <label>Week (Sun) <input id="week" type="date"></label>
  <button id="load">Load</button>
  <span class="small">Displays locked assignments (future) + published schedule (if available)</span>
</div>

<table id="tbl">
  <thead><tr><th>Date</th><th>Shift</th><th>Unit</th><th>Seat</th><th>Member</th><th>Status</th></tr></thead>
  <tbody></tbody>
</table>

<script>
function base(){ return store.value.trim().replace(/\/+$/,''); }
function tok(){ return token.value.trim(); }
async function apiGet(kind, params={}){
  const u = new URL(base());
  u.searchParams.set("kind", kind);
  u.searchParams.set("token", tok());
  for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
  const r = await fetch(u.toString(), {cache:"no-store"});
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j || j.ok===false) throw new Error((j&&j.error)?j.error:`GET ${kind} failed`);
  return j.payload;
}
const store=document.getElementById("store");
const token=document.getElementById("token");
const week=document.getElementById("week");
function iso(d){ return d.toISOString().slice(0,10); }
function nextSundayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  const add=(7-d.getDay())%7; d.setDate(d.getDate()+add);
  return iso(d);
}
week.value = nextSundayISO();

document.getElementById("load").onclick = async ()=>{
  const w = week.value;
  const membersDoc = await apiGet("members");
  const members = Array.isArray(membersDoc.members) ? membersDoc.members : (Array.isArray(membersDoc)?membersDoc:[]);
  const nameBy = {};
  for (const m of members) nameBy[m.member_id] = ((m.first_name||"")+" "+(m.last_name||"")).trim();

  const rows=[];
  const locksDoc = await apiGet("locks", {week:w});
  for (const lk of (locksDoc.locks||[])){
    rows.push({date:lk.date, shift:lk.shift, unit:lk.unit, seat:lk.seat, member:nameBy[lk.member_id]||lk.member_id, status:"locked"});
  }
  try{
    const sched = await apiGet("schedule");
    const items = sched.items || sched.assignments || sched.rows || [];
    for (const a of items){
      rows.push({date:a.date, shift:(a.shift||a.slot||""), unit:a.unit, seat:a.seat, member:nameBy[a.member_id]||a.member_id, status:"published"});
    }
  }catch(_e){}

  rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shift||"").localeCompare(b.shift||""));
  const tb=document.querySelector("#tbl tbody");
  tb.innerHTML = rows.map(r=>`<tr>
    <td>${r.date||""}</td><td>${r.shift||""}</td><td>${r.unit||""}</td><td>${r.seat||""}</td><td>${r.member||""}</td><td>${r.status||""}</td>
  </tr>`).join("");
};

</script>
</body></html>