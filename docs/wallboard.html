<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShiftCommander â€” Wallboard</title>
<style>
:root{--b:#ddd;--g:#f6f6f6;--mut:#666}
body{font-family:system-ui,Segoe UI,Arial;margin:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,button{font:inherit;padding:6px 8px}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid var(--b);padding:6px 8px;font-size:12px}
th{background:var(--g);text-align:left}
.small{font-size:12px;color:var(--mut)}
.pill{border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:11px}
.pill.lock{background:#fff3cd;border-color:#ffe69c}
.pill.pub{background:#e7f5ff;border-color:#b6dfff}
</style></head>
<body>
<h2>Wallboard</h2>
<div class="row">
  <label>Store <input id="store" size="80" placeholder="https://script.google.com/macros/s/DEPLOY/exec"></label>
  <label>Token <input id="token" size="34" placeholder="TOKEN"></label>
  <label>Week (Sun) <input id="week" type="date"></label>
  <button id="load">Load</button>
  <button id="saveCfg">Save</button>
  <span class="small">locked + published/resolved</span>
</div>

<table id="tbl">
  <thead><tr><th>Date</th><th>Shift</th><th>Unit</th><th>Seat</th><th>Member</th><th>Status</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const LS="sc_cfg_full_v3";
const $=id=>document.getElementById(id);

function sanitizeStore(u){
  u=String(u||"").trim();
  if(!u) return "";
  try{
    const x=new URL(u);
    x.hash=""; x.search=""; // strip pasted ?kind=...
    return x.toString().replace(/\/+$/,"");
  }catch(_){
    return u.replace(/\/+$/,"");
  }
}
function loadCfg(){
  const cfg=JSON.parse(localStorage.getItem(LS)||"{}");
  if(cfg.store) $("store").value=cfg.store;
  if(cfg.token) $("token").value=cfg.token;
}
function saveCfg(){
  localStorage.setItem(LS, JSON.stringify({
    store:sanitizeStore($("store").value),
    token:$("token").value.trim()
  }));
}
function storeBase(){
  const cfg=JSON.parse(localStorage.getItem(LS)||"{}");
  return sanitizeStore($("store").value.trim()||cfg.store||"");
}
function tok(){
  const cfg=JSON.parse(localStorage.getItem(LS)||"{}");
  return ($("token").value.trim()||cfg.token||"");
}
function isAppsScript(){ return /script\.google\.com\/macros/i.test(storeBase()); }

function getUrl(kind, params={}){
  if(isAppsScript()){
    const u=new URL(storeBase());
    u.searchParams.set("kind",kind);
    u.searchParams.set("token",tok());
    for(const [k,v] of Object.entries(params)) u.searchParams.set(k,v);
    return u.toString();
  }
  const u=new URL(storeBase().replace(/\/+$/,"") + "/sc/get");
  u.searchParams.set("kind",kind);
  for(const [k,v] of Object.entries(params)) u.searchParams.set(k,v);
  return u.toString();
}

async function apiGet(kind, params={}){
  const r=await fetch(getUrl(kind, params), {cache:"no-store", redirect:"follow"});
  const j=await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok===false) throw new Error((j&&j.error)?j.error:`GET ${kind} failed`);
  return j.payload;
}

function iso(d){ return d.toISOString().slice(0,10); }
function nextSundayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  const add=(7-d.getDay())%7; d.setDate(d.getDate()+add);
  return iso(d);
}
$("week").value = nextSundayISO();

$("saveCfg").onclick = saveCfg;

$("load").onclick = async ()=>{
  saveCfg();
  const w=$("week").value;

  const members=await apiGet("members");
  const list=Array.isArray(members.members)?members.members:(Array.isArray(members)?members:[]);
  const nameBy={}; list.forEach(m=> nameBy[m.member_id]=((m.first_name||"")+" "+(m.last_name||"")).trim()||m.member_id);

  const rows=[];
  const locks=await apiGet("locks",{week:w}).catch(()=>({locks:[]}));
  (locks.locks||[]).forEach(lk=> rows.push({date:lk.date,shift:lk.shift,unit:lk.unit,seat:lk.seat,member:nameBy[lk.member_id]||lk.member_id,status:"locked"}));

  const weekDoc=await apiGet("week",{week:w}).catch(()=>null);
  if(weekDoc && Array.isArray(weekDoc.assignments)){
    (weekDoc.assignments||[]).forEach(a=> rows.push({date:a.date,shift:a.shift,unit:a.unit,seat:a.seat,member:nameBy[a.member_id]||a.member_id,status:weekDoc.status||"resolved"}));
  }

  rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shift||"").localeCompare(b.shift||""));
  $("tbl").querySelector("tbody").innerHTML = rows.map(r=>`<tr>
    <td>${r.date||""}</td><td>${r.shift||""}</td><td>${r.unit||""}</td><td>${r.seat||""}</td><td>${r.member||""}</td>
    <td>${r.status==="locked"?'<span class="pill lock">locked</span>':(r.status==="published"?'<span class="pill pub">published</span>':r.status||"")}</td>
  </tr>`).join("");
};

loadCfg();
</script></body></html>
