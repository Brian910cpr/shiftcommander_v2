<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander — Wallboard</title>
<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --line:#d9e1ee;
    --line2:#eef2f7;
    --text:#0f172a;
    --muted:#64748b;
    --muted2:#94a3b8;
    --open:#9aa5b1;
    --shadow:0 1px 2px rgba(0,0,0,.06);
    --r:10px;

    --g:#16a34a;   /* green */
    --y:#f59e0b;   /* yellow */
    --red:#dc2626; /* red */
    --gray:#94a3b8;
  }

  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .top{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(#fff,#fbfdff);
    border-bottom:1px solid var(--line);
    box-shadow:var(--shadow);
  }
  .top-inner{
    max-width:1500px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding:10px 12px;
  }
  .title{
    font-weight:1000;
    display:flex; align-items:baseline; gap:10px;
  }
  .sub{
    font-size:12px; color:var(--muted);
    font-weight:900;
  }

  /* Visible build/version tag so it's obvious when the latest HTML is live */
  .ver{
    font-size:11px;
    font-weight:1000;
    color:var(--muted);
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:2px 8px;
  }

  .pill{
    font-size:12px;
    font-weight:900;
    color:var(--muted);
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:6px 10px;
  }

  .wrap{
    max-width:1500px;
    margin:0 auto;
    padding:8px;
  }

  .week-block{
    border:1px solid var(--line);
    border-radius:var(--r);
    background:var(--card);
    box-shadow:var(--shadow);
    overflow:hidden;
    margin-bottom:8px;
  }

  .divider{
    height:1px;
    background: repeating-linear-gradient(90deg, var(--line), var(--line) 10px, transparent 10px, transparent 16px);
    margin: 10px 0 14px 0;
  }

  .week-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid var(--line2);
    background:linear-gradient(#fbfdff,#fff);
    gap:12px;
  }
  .week-head .left{
    display:flex; align-items:baseline; gap:10px;
  }
  .week-title{
    font-weight:1000;
  }
  .week-dates{
    font-size:12px; color:var(--muted); font-weight:900;
  }

  .weekday-row{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
    padding:6px 8px 0 8px;
    color:var(--muted);
    font-weight:1000;
    font-size:11px;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(7, minmax(165px, 1fr));
    gap:6px;
    padding:6px 8px 8px 8px;
  }

  /* Day tile */
  .day{
    display:grid;
    grid-template-columns: 8px 1fr; /* health strip + tile */
    gap:0;
    border-radius:var(--r);
    overflow:hidden;
    border:1px solid var(--line);
    background:var(--card);
  }
  .health{
    background:var(--gray);
  }
  .tile{
    display:grid;
    grid-template-rows: 30px 1fr 1fr; /* head + AM + PM */
    min-height: 132px;
  }
  .dayhead{
    display:flex; justify-content:space-between; align-items:center;
    padding:5px 8px;
    border-bottom:1px solid var(--line2);
    background:linear-gradient(#fbfdff,#fff);
  }
  .daynum{ font-size:16px; font-weight:1000; line-height:1; }
  .truck{ font-size:12px; font-weight:1000; color:var(--muted); }
  /* Ambulance/unit label pill shown between day number and ISO date */
  .truckpill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#f8fafc;
    color:#0f172a;
    font-weight:1000;
    font-size:11px;
    line-height:1;
  }
  .iso{ font-size:11px; color:var(--muted2); font-weight:1000; }

  .slot{
    display:grid;
    grid-template-columns: 22px 1fr; /* tiny AM/PM + names */
    gap:6px;
    padding:6px 8px;
    border-top:1px solid var(--line2);
    align-items:start;
  }
  .slot:first-of-type{ border-top:none; }

  .tag{
    font-size:10px;
    font-weight:1000;
    color:var(--muted);
    letter-spacing:.08em;
    text-transform:uppercase;
    padding-top:2px;
  }

  .lines{ display:flex; flex-direction:column; gap:5px; min-width:0; }
  .line{
    font-size:clamp(13px, 1.45vw, 16px);
    font-weight:900;
    line-height:1.15;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
  }
  .open{
    color:var(--open);
    font-weight:1000;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .note{
    margin-top:4px;
    font-size:11px;
    font-weight:1000;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .note strong{ color:var(--text); }
  .note.needs{
    color:var(--red);
    background:#fff1f2;
    border:1px solid #fecdd3;
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
  }
  .note.needs strong{ color:var(--red); }

  .flag{
    font-size:12px;
    font-weight:1000;
    color:var(--y);
    margin-left:8px;
  }

  .today .tile{ outline:2px solid #0f172a; outline-offset:-2px; }

  /* Past days (greyed out) */
  .past{ opacity:.55; filter: grayscale(1); }
  .past .health{ opacity:.75; }

  @media (max-width: 980px){
    .weekday-row{ display:none; }
    .grid{ grid-template-columns: repeat(2, minmax(150px, 1fr)); gap:6px; padding:6px 8px 8px 8px; }
  }

  @media (max-width: 560px){
    .wrap{ padding:6px; }
    .week-head{ padding:8px 8px; }
    .grid{ grid-template-columns: 1fr; gap:6px; padding:6px 8px 8px 8px; }
    .tile{ min-height: 120px; }
    .line{ font-size: clamp(14px, 4.4vw, 18px); }
  }


  #root{ transition: opacity .22s ease; }

  #rangeLabel{ display:none; }

  .footer{
    max-width:1500px;
    margin:0 auto;
    padding:10px 12px 16px 12px;
    color:var(--muted);
    font-size:12px;
    font-weight:900;
    text-align:right;
  }
  .footer strong{ color:var(--text); }

</style>
</head>
<body>

<div class="top">
  <div class="top-inner">
    <div class="title">
      <div>Wallboard <span class="sub" id="buildTag" style="font-weight:1000;margin-left:6px"></span></div>
      <div class="sub" id="rangeLabel"></div>
    </div>
    <div class="pill" id="statusPill">Loading…</div>
  </div>
</div>

<div class="wrap" id="root"></div>

<div class="footer" id="resolverFooter"></div>

<script>
/** ========= CONFIG ========= **/
// ShiftCommander Store — ALWAYS via Cloudflare Worker
const STORE_URL = "https://schedule-cors-910cpr.brian-9ac.workers.dev";
const USE_FIRST_NAME = true; // wallboard display: first name only
const PLANNING_WEEKS = 0; // planning hidden on public wallboard
const SHOW_PLANNING = false; // public wallboard never shows planning
const WEEK_START = 0; // 0=Sunday (ADR matches wallboard)
const SHOW_WEEKDAY_HEADER = true;

// Auto-refresh (keeps board current without frequent flashing)
// 5 minutes is a good default for public displays.
const AUTO_REFRESH_MS = 5 * 60 * 1000;


/** kind names in Apps Script */
const KIND_SCHEDULE = "schedule"; // should return schedule.json contents
const KIND_MEMBERS  = "members";  // should return members.json contents (tiers + qual_120)
const KIND_ORG      = "org_settings"; // optional: active units/seats for truck label

/** ========= DATE UTILS ========= **/
function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function startOfWeek(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = (x.getDay() - WEEK_START + 7) % 7;
  x.setDate(x.getDate() - diff);
  x.setHours(0,0,0,0);
  return x;
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function fmtRange(a,b){
  const opt = { month:"short", day:"numeric" };
  const left = a.toLocaleDateString(undefined, opt);
  const right = b.toLocaleDateString(undefined, opt);
  const yr = b.getFullYear();
  return `${left} – ${right}, ${yr}`;
}

function fmtLocalTimeFromIso(isoStr){
  try{
    const d = new Date(String(isoStr));
    if(isNaN(d.getTime())) return "";
    return new Intl.DateTimeFormat(undefined, { timeZone:"America/New_York", hour:"2-digit", minute:"2-digit" }).format(d);
  }catch(_e){
    return "";
  }
}
function fmtLocalDateTimeFromIso(isoStr){
  try{
    const d = new Date(String(isoStr));
    if(isNaN(d.getTime())) return "";
    return new Intl.DateTimeFormat(undefined, { timeZone:"America/New_York", weekday:"short", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit", timeZoneName:"short" }).format(d);
  }catch(_e){
    return "";
  }
}

/** ========= FETCH ========= **/
function storeUrl(kind){
  const u = new URL(STORE_URL, location.origin);
  u.searchParams.set("kind", kind);
  return u.toString();
}
async function fetchJson(url){
  const r = await fetch(url, { cache:"no-store" });
  const t = await r.text();
  // Worker may wrap HTML errors in JSON {ok:false,...}
  try{
    const j = JSON.parse(t);
    if(j && j.ok === false) throw new Error(j.error || "Store error");
    return j;
  }catch(e){
    // if it wasn't JSON, surface first bytes
    if(t.trim().startsWith("<!DOCTYPE html")) throw new Error("Upstream returned HTML (auth/cors/drive).");
    throw e;
  }
}


function unwrapStorePayload(obj){
  // Unwrap nested {ok,kind,payload} layers (worker/store sometimes returns nested envelopes)
  let x = obj;
  for(let i=0;i<6;i++){
    if(!x || typeof x !== "object") break;
    if("payload" in x && x.payload && typeof x.payload === "object"){
      x = x.payload;
      continue;
    }
    break;
  }
  return x || {};
}


/** ========= ROSTER MAP ========= **/
/**
 * We need:
 *  - tier: ALS if AEMT/P, EMT if EMT-B
 *  - qual_120: true/false
 *
 * Adapt this mapper once we see your exact members.json format.
 */
function buildRosterIndex(membersJson){
  const byId = {};
  // Accept either the full store response {ok, kind, payload:{...}}
  // or the payload itself.
  const payload = unwrapStorePayload(membersJson);

  const list =
    Array.isArray(payload) ? payload :
    (payload && Array.isArray(payload.members)) ? payload.members :
    (payload && Array.isArray(payload.data)) ? payload.data :
    [];

  for(const m of list){
    const id = String(m.member_id ?? m.id ?? m.memberId ?? "").trim();
    if(!id) continue;

    // ALS tier: AEMT or Paramedic => ALS; EMT-B => EMT
    const quals = m.quals || m.qualifications || m.qual || [];
    const cert = (m.medical || m.medical_level || m.level || m.ems_level || "").toString().toUpperCase();

    const isALS =
      cert.includes("AEMT") || cert.includes("PARAMEDIC") || cert.includes("EMT-P") ||
      (Array.isArray(quals) && quals.some(q => {
        const s = String(q).toUpperCase();
        return s.includes("AEMT") || s.includes("PARAMEDIC");
      }));

    const isEMT =
      (!isALS) && (cert.includes("EMT") || (Array.isArray(quals) && quals.some(q => String(q).toUpperCase().includes("EMT"))));

    const has120 =
      m.qual_120 === true ||
      m.qual120 === true ||
      (Array.isArray(quals) && quals.some(q => String(q).includes("120"))) ||
      (typeof quals === "object" && (quals.qual_120 || quals["120"]));

    const first = (m.first_name || m.firstName || "").toString().trim();
    const last  = (m.last_name  || m.lastName  || "").toString().trim();
    const nm =
      (m.name || m.full_name || m.display_name || m.last_first || `${first} ${last}`.trim() || id).toString().trim();

    byId[id] = { name: nm, first: first || nm.split(" ")[0] || nm, tier: isALS ? "ALS" : (isEMT ? "EMT" : "UNK"), quals: Array.isArray(quals)? quals.map(q=>String(q)) : [], has120: !!has120 };
  }
  return byId;
}

/** ========= SCHEDULE NORMALIZE ========= **/
function normalizePair(pair){
  // pair is ["203","115"] or ["210","OPEN"]
  const a = (pair && pair[0]) ? String(pair[0]).trim() : "OPEN";
  const d = (pair && pair[1]) ? String(pair[1]).trim() : "OPEN";
  return [a || "OPEN", d || "OPEN"];
}
function getDay(schedule, iso){
  const obj = schedule[iso] || {};
  const am = normalizePair(obj.AM || obj.am || obj.Am || ["OPEN","OPEN"]);
  const pm = normalizePair(obj.PM || obj.pm || obj.Pm || ["OPEN","OPEN"]);
  const flags = obj.flags || []; // optional: day-level flags
  const notes = obj.notes || {}; // optional: { AM:"...", PM:"..." }
  const unit = (obj && typeof obj === 'object' && obj._unit && typeof obj._unit === 'object') ? obj._unit : null;
  return { am, pm, flags, notes, unit };
}

function unitPillText(dayObj, org, iso){
  // Prefer schedule-provided unit info (written by Supervisor resolver).
  const u = dayObj && dayObj.unit ? dayObj.unit : null;
  const am = u && u.AM ? String(u.AM).trim() : "";
  const pm = u && u.PM ? String(u.PM).trim() : "";

  if(am && pm){
    return (am === pm) ? am : `AM ${am} • PM ${pm}`;
  }
  if(am) return `AM ${am}`;
  if(pm) return `PM ${pm}`;

  // Fallback to org_settings-based label if present
  const t = truckLabelForDate(iso, org);
  return t ? String(t) : "";
}


/** ========= SEAT ACTIVITY (from org_settings.active_seats_by_date) ========= **/
function seatsForDateShift(iso, shift, org){
  try{
    const sh = String(shift||"").toUpperCase();
    const day = (org && org.active_seats_by_date && org.active_seats_by_date[iso]) ? org.active_seats_by_date[iso] : null;

    // If the key exists and is an empty array, treat as explicit NONE (no seating required)
    if(day && Object.prototype.hasOwnProperty.call(day, sh)){
      const v = day[sh];
      if(Array.isArray(v)) return v.map(String); // may be []
    }

    // Otherwise fall back to defaults
    const def = org && org.ops_defaults && org.ops_defaults.seats ? (org.ops_defaults.seats[sh] || org.ops_defaults.seats[sh.toLowerCase()]) : null;
    if(Array.isArray(def)) return def.map(String);

    // Unknown (treat as active by default)
    return null;
  }catch(_e){
    return null;
  }
}
function isNoSeating(arr){
  return Array.isArray(arr) && arr.length === 0;
}

/** ========= HEALTH RULES (ALL SHIFTS ARE ALS SHIFTS) ========= **/
function hasQual(member, key){
  try{
    const k = String(key||"").trim();
    if(!k) return true;
    const ks = k.replace(/^qual_/, "");
    const q = Array.isArray(member?.quals) ? member.quals.map(x=>String(x)) : [];
    return q.includes(k) || (ks && q.includes(ks)) || q.includes("qual_"+ks);
  }catch(_e){
    return false;
  }
}

function shiftHealth(attId, drvId, roster, operatorQualKey, seatsArr){
  // If seating is explicitly NONE for this shift, treat as N/A
  if(isNoSeating(seatsArr)) return "GRAY";

  // Red if attendant is not ALS, or driver lacks qual_120
  const att = roster[attId];
  const drv = roster[drvId];

  const attTier = (attId === "OPEN") ? "OPEN" : (att?.tier || "UNK");
  const drvTier = (drvId === "OPEN") ? "OPEN" : (drv?.tier || "UNK");
  const opKey = (operatorQualKey||"").trim();
  const drvHasOp = (drvId !== "OPEN") && hasQual(drv, opKey);

  // Missing or non-ALS attendant => RED
  if(attId === "OPEN" || attTier !== "ALS") return "RED";

  // Missing driver or missing per-unit operator qual => RED
  if(drvId === "OPEN" || !drvHasOp) return "RED";

  // Ideal: ALS attendant + EMT driver w/ required operator qual => GREEN
  if(drvTier === "EMT") return "GREEN";

  // Driver is ALS (still ok, less ideal) => YELLOW
  if(drvTier === "ALS") return "YELLOW";

  // Unknown tier but has120 => waiver-minimum => YELLOW
  return "YELLOW";
}

function dayHealth(dayObj, roster, iso, org){
  const [amA, amD] = dayObj.am;
  const [pmA, pmD] = dayObj.pm;

  const amOpKey = operatorQualForDateShift(iso, "AM", org);
  const pmOpKey = operatorQualForDateShift(iso, "PM", org);

  const amSeats = seatsForDateShift(iso, "AM", org);
  const pmSeats = seatsForDateShift(iso, "PM", org);

  // Worst-of (RED beats YELLOW beats GREEN; GRAY is N/A)
  const ranks = { RED:3, YELLOW:2, GREEN:1, GRAY:0 };
  const amH = shiftHealth(amA, amD, roster, amOpKey, amSeats);
  const pmH = shiftHealth(pmA, pmD, roster, pmOpKey, pmSeats);

  return (ranks[amH] >= ranks[pmH]) ? amH : pmH;
}

/** ========= NEEDS HINTS (ONLY IN LAST PLANNING WEEK) ========= **/
function needsHint(attId, drvId, roster, operatorQualKey, seatsArr){
  if(isNoSeating(seatsArr)) return "";

  // Based on your preferences:
  // - If 2 ALS scheduled (ALS attendant + ALS driver w/ 120) => Needs EMT
  // - If ALS attendant but driver missing or lacks required operator qual => Need Driver
  // - If attendant missing or not ALS => Need ALS
  if(attId === "OPEN" || (roster[attId]?.tier !== "ALS")) return "Needs ALS";
  const opKey = (operatorQualKey||"").trim();
  const hasOp = (drvId !== "OPEN") && hasQual(roster[drvId], opKey);
  if(drvId === "OPEN" || !hasOp) return "Need Driver";
  if(roster[drvId]?.tier === "ALS") return "Needs EMT";
  return ""; // already ideal
}

/** ========= RENDER ========= **/
function nameFor(id, roster){
  if(!id || id === "OPEN") return `<span class="open">OPEN</span>`;
  const r = roster[id];
  let nm = (r?.name || "Assigned").toString();
  if(USE_FIRST_NAME && r?.first) nm = String(r.first);

  return escapeHtml(nm);
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function healthColor(h){
  if(h==="GREEN") return "var(--g)";
  if(h==="YELLOW") return "var(--y)";
  if(h==="RED") return "var(--red)";
  return "var(--gray)";
}


// ---- OPERATOR QUAL (per unit) ----
function operatorQualForDateShift(iso, shift, org){
  try{
    const au = (org && org.active_units_by_date && org.active_units_by_date[iso]) ? org.active_units_by_date[iso] : null;
    if(!au) return "";
    const unitId = (shift === "PM") ? (au.PM || "") : (au.AM || "");
    if(!unitId) return "";
    const units = (org && Array.isArray(org.units)) ? org.units : [];
    const u = units.find(x => String(x.unit_id||"") === String(unitId));
    return (u && u.operator_qual_key) ? String(u.operator_qual_key) : "";
  }catch(_e){
    return "";
  }
}
// ---- TRUCK LABEL (from org_settings.active_units_by_date) ----
function digitsFromUnit(unitId){
  const s = String(unitId || "").trim();
  if(!s) return "";
  const m = s.match(/(\d{3})(?!\d)/); // grab 3-digit truck number if present
  return m ? m[1] : s; // fallback to full string
}
function truckLabelForDate(iso, org){
  const au = (org && org.active_units_by_date && org.active_units_by_date[iso]) ? org.active_units_by_date[iso] : null;
  if(!au) return "";
  const a = digitsFromUnit(au.AM || "");
  const p = digitsFromUnit(au.PM || "");
  if(!a && !p) return "";
  if(a && (!p || p === a)) return a;
  if(!a && p) return p;
  return a + "/" + p;
}

function renderWeekBlock(root, title, weekStartDate, schedule, roster, org, opts={}){
  const weekEnd = addDays(weekStartDate, 6);
  const range = fmtRange(weekStartDate, weekEnd);

  const block = document.createElement("div");
  block.className = "week-block";

  const head = document.createElement("div");
  head.className = "week-head";
  head.innerHTML = `
    <div class="left">
      <div class="week-title">${escapeHtml(title)}</div>
      <div class="week-dates">${escapeHtml(range)}</div>
    </div>
    <div class="sub">${opts.sub || ""}</div>
  `;
  block.appendChild(head);

  if(SHOW_WEEKDAY_HEADER){
    const wd = document.createElement("div");
    wd.className = "weekday-row";
    wd.innerHTML = `<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>`;
    block.appendChild(wd);
  }

  const grid = document.createElement("div");
  grid.className = "grid";

  const todayIso = isoDate(new Date());

  for(let i=0;i<7;i++){
    const d = addDays(weekStartDate, i);
    const iso = isoDate(d);
    const dayObj = getDay(schedule, iso);
    const h = dayHealth(dayObj, roster, iso, org);

    // optional caution flag if day has flags
    const hasCaution = Array.isArray(dayObj.flags) && dayObj.flags.length > 0;

    const truck = unitPillText(dayObj, org, iso);

    const day = document.createElement("div");
    day.className = "day" + (iso===todayIso ? " today" : "") + (iso < todayIso ? " past" : "");

    const health = document.createElement("div");
    health.className = "health";
    health.style.background = healthColor(h);

    const tile = document.createElement("div");
    tile.className = "tile";

    const [amA, amD] = dayObj.am;
    const [pmA, pmD] = dayObj.pm;

    const amSeats = seatsForDateShift(iso, "AM", org);
    const pmSeats = seatsForDateShift(iso, "PM", org);
    const amNoSeat = isNoSeating(amSeats);
    const pmNoSeat = isNoSeating(pmSeats);

    // Planning “Needs …” only in last planning week block
    const amNeed = opts.showNeeds ? needsHint(amA, amD, roster, operatorQualForDateShift(iso, "AM", org), seatsForDateShift(iso, "AM", org)) : "";
    const pmNeed = opts.showNeeds ? needsHint(pmA, pmD, roster, operatorQualForDateShift(iso, "PM", org), seatsForDateShift(iso, "PM", org)) : "";

    tile.innerHTML = `
      <div class="dayhead">
        <div class="daynum">${d.getDate()}${hasCaution ? `<span class="flag">⚠</span>` : ""}</div>
        <div class="truck">${truck ? `<span class="truckpill">${escapeHtml(truck)}</span>` : ""}</div>
        <div class="iso">${iso}</div>
      </div>

      <div class="slot">
        <div class="tag">AM</div>
        <div class="lines">
          ${amNoSeat
            ? `<div class="line open">N/A</div><div class="note">No seating required</div>`
            : `<div class="line">${nameFor(amA, roster)}</div><div class="line">${nameFor(amD, roster)}</div>${amNeed ? `<div class="note needs"><strong>${escapeHtml(amNeed)}</strong></div>` : ""}`
          }
        </div>
      </div>

      <div class="slot">
        <div class="tag">PM</div>
        <div class="lines">
          ${pmNoSeat
            ? `<div class="line open">N/A</div><div class="note">No seating required</div>`
            : `<div class="line">${nameFor(pmA, roster)}</div><div class="line">${nameFor(pmD, roster)}</div>${pmNeed ? `<div class="note needs"><strong>${escapeHtml(pmNeed)}</strong></div>` : ""}`
          }
        </div>
      </div>
    `;

    day.appendChild(health);
    day.appendChild(tile);
    grid.appendChild(day);
  }

  block.appendChild(grid);
  root.appendChild(block);
}

/** ========= MAIN ========= **/
async function loadData(){
  const [scheduleResp, membersResp] = await Promise.all([
    fetchJson(storeUrl(KIND_SCHEDULE)),
    fetchJson(storeUrl(KIND_MEMBERS))
  ]);

  // org_settings is optional (used for truck labels)
  let org = {};
  try{
    const orgResp = await fetchJson(storeUrl(KIND_ORG));
    org = (orgResp && orgResp.payload) ? orgResp.payload : (orgResp || {});
  }catch(_e){ org = {}; }

  const schedule = unwrapStorePayload(scheduleResp);
  const roster   = buildRosterIndex(membersResp);
  return { schedule, roster, org };
}

function hashLite(obj){
  // Simple stable-ish hash to avoid re-rendering when nothing changed.
  // (Not cryptographic; just reduces unnecessary redraw.)
  try{
    const s = JSON.stringify(obj);
    let h = 0;
    for(let i=0;i<s.length;i++){
      h = ((h<<5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    return String(h);
  }catch(_e){
    return String(Date.now());
  }
}

function renderAll(root, schedule, roster, org){
  root.innerHTML = "";

  const now = new Date();
  const thisWeekStart = startOfWeek(now);

  // Week offsets (from "this week")
  const archivedStart   = addDays(thisWeekStart, -7);   // -1
  const controlled0     = thisWeekStart;                // 0
  const controlled1     = addDays(thisWeekStart,  7);   // +1 (show Needs)
  const published2      = addDays(thisWeekStart, 14);   // +2
  const published3      = addDays(thisWeekStart, 21);   // +3

  // Header label
    // Render blocks
  renderWeekBlock(root, "", archivedStart, schedule, roster, org, { sub:"Archived" });
  renderWeekBlock(root, "", controlled0, schedule, roster, org, { sub:"Controlled" });
  renderWeekBlock(root, "", controlled1, schedule, roster, org, { sub:"Controlled", showNeeds:true });

  renderWeekBlock(root, "", published2, schedule, roster, org, { sub:"Published" });
  renderWeekBlock(root, "", published3, schedule, roster, org, { sub:"Published" });

  // Visual end-of-published line
  const div = document.createElement("div");
  div.className = "divider";
  root.appendChild(div);
}

async function refreshBoard({initial=false}={}){
  const pill = document.getElementById("statusPill");
  const root = document.getElementById("root");

  try{
    if(initial){
      pill.textContent = "Loading schedule + roster…";
    }else{
      pill.textContent = "Refreshing…";
    }

    const data = await loadData();

    // Visible “did the update push?” marker (build tag)
    document.getElementById("buildTag").textContent = "v2026-01-16.7";

    // Only re-render if something actually changed
    window.__sc_lastHash ||= "";
    const h = hashLite({ schedule: data.schedule, roster: data.roster, org: data.org });
    if(!initial && h === window.__sc_lastHash){
      const ra = data.schedule && data.schedule.meta ? data.schedule.meta.resolved_at : null;
      const t = ra ? fmtLocalTimeFromIso(ra) : "";
      pill.textContent = ra && t ? ("Updated " + t + " • Live") : "Live";
      pill.title = ra ? ("Resolved: " + fmtLocalDateTimeFromIso(ra)) : "";
      pill.style.color = "#166534";

      const foot = document.getElementById("resolverFooter");
      if(foot){
        foot.innerHTML = ra
          ? (`Last resolver run: <strong>${escapeHtml(fmtLocalDateTimeFromIso(ra))}</strong>`)
          : "Last resolver run: <strong>Unknown</strong>";
      }
      return;
    }
    window.__sc_lastHash = h;

    // Build off-DOM then swap with a gentle fade (reduces “flash”)
    const temp = document.createElement("div");
    renderAll(temp, data.schedule, data.roster, data.org);

    if(!initial){
      root.style.opacity = "0.18";
      setTimeout(()=>{
        root.innerHTML = temp.innerHTML;
        root.style.opacity = "1";
      }, 180);
    }else{
      root.innerHTML = temp.innerHTML;
      root.style.opacity = "1";
    }

    {
      const ra = data.schedule && data.schedule.meta ? data.schedule.meta.resolved_at : null;
      const t = ra ? fmtLocalTimeFromIso(ra) : "";
      pill.textContent = ra && t ? ("Updated " + t + " • Live") : "Live";
      pill.title = (ra ? ("Resolved: " + fmtLocalDateTimeFromIso(ra)) : "No resolve stamp yet") + "\n" + "Build: v2026-01-16.6";
      pill.style.color = "#166534";
    const foot = document.getElementById("resolverFooter");
    if(foot){
      foot.innerHTML = ra ? (`Last resolver run: <strong>${escapeHtml(fmtLocalDateTimeFromIso(ra))}</strong>`) : "Last resolver run: <strong>Unknown</strong>";
    }
    }
  }catch(err){
    console.error(err);
    pill.textContent = "Load failed";
    pill.style.color = "#b91c1c";
    root.innerHTML = `<div class="pill" style="border-color:#fecaca;color:#b91c1c">
      ${escapeHtml(String(err.message || err))}
    </div>`;
  }
}

refreshBoard({initial:true});
setInterval(()=> refreshBoard({initial:false}), AUTO_REFRESH_MS);
</script>

<script>
(function(){
  function show(msg){
    try{
      var d=document.getElementById('scFatal');
      if(!d){
        d=document.createElement('div');
        d.id='scFatal';
        d.style.cssText='position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);color:#fff;padding:14px;font:14px/1.35 ui-monospace,Menlo,Consolas,monospace;overflow:auto;';
        d.innerHTML='<div style="font-weight:900;font-size:16px;margin-bottom:8px;">ShiftCommander error</div><pre id="scFatalMsg" style="white-space:pre-wrap;margin:0;"></pre>';
        document.body.appendChild(d);
      }
      var pre=document.getElementById('scFatalMsg');
      if(pre) pre.textContent=String(msg||'Unknown error');
    }catch(_e){}
  }
  window.addEventListener('error', function(e){
    show((e && (e.message||e.error)) ? (e.message||e.error) : e);
  });
  window.addEventListener('unhandledrejection', function(e){
    show('Unhandled Promise rejection: ' + (e && e.reason ? (e.reason.stack||e.reason.message||String(e.reason)) : 'unknown'));
  });
})();
</script>

</body>
</html>
