<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander — Wallboard</title>
<style>
  :root {
    --bg:#061021;
    --panel:#0c1b36;
    --line:rgba(255,255,255,.12);
    --text:#eef3ff;
    --muted:#9fb0e6;
    --good:#48d597;
    --warn:#f7c948;
    --bad:#ff6b6b;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#050914,var(--bg));color:var(--text);}
  header{position:sticky;top:0;z-index:10;background:rgba(5,9,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);}
  .wrap{max-width:1400px;margin:0 auto;padding:14px 16px;}
  .top{display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 10px;font-size:14px;outline:none;}
  .card{border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),rgba(12,27,54,.65));border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.35);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .day{padding:12px}
  .day h3{margin:0 0 10px;font-size:14px;color:var(--muted)}
  .shift{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background:rgba(0,0,0,.18);margin-bottom:10px}
  .shift .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .shift .name{font-weight:800}
  .slot{font-size:13px;margin-top:4px;color:var(--text)}
  .slot .k{color:var(--muted);font-weight:700;margin-right:6px}
  .status{font-size:12px;color:var(--muted);margin-top:10px}
  a{color:#9dc1ff;text-decoration:none}
  a:hover{text-decoration:underline}
</style>
</head>
<body>
<header>
  <div class="wrap top">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:900;letter-spacing:.3px">ShiftCommander — Wallboard</div>
      <span class="pill" id="pillNet">offline</span>
      <span class="pill" id="pillStore">store: —</span>
      <span class="pill" id="pillWeek">week: —</span>
    </div>
    <div class="row">
      <div>
        <label>Store Base</label>
        <input id="storeBase" value="https://store.adr-fr.org" />
      </div>
      <div>
        <label>Week (Sunday)</label>
        <input id="weekStart" type="date" />
      </div>
      <div>
        <label>Version</label>
        <input id="version" value="published" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnLoad" class="pill" style="cursor:pointer">Load</button>
      </div>
      <a class="pill" href="./supervisor.html" target="_blank">Supervisor</a>
      <a class="pill" href="./member.html" target="_blank">Member</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="status" id="status">—</div>
  <div class="grid" id="grid"></div>
</div>

<script type="module">
import { isoDateUTC, addDaysUTC } from "./js/sc_resolver_v2.js";

const $ = (id)=>document.getElementById(id);

function setPill(el, text, ok=true){
  el.textContent=text;
  el.style.borderColor = ok ? "rgba(72,213,151,.5)" : "rgba(255,107,107,.5)";
  el.style.background = ok ? "rgba(72,213,151,.10)" : "rgba(255,107,107,.10)";
  el.style.color = ok ? "#b7f7dd" : "#ffd0d0";
}

function storeBase(){
  const v = $("storeBase").value.trim().replace(/\/$/,"");
  localStorage.setItem("sc_store_base", v);
  return v;
}

function sundayOf(d){
  const x = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  const dow = x.getUTCDay();
  x.setUTCDate(x.getUTCDate()-dow);
  return x;
}
function toISODate(d){ return d.toISOString().slice(0,10); }
function weekStartVal(){ return $("weekStart").value || toISODate(sundayOf(new Date())); }

async function scGet(kind, params={}){
  const u = new URL(storeBase()+"/sc/get");
  u.searchParams.set("kind", kind);
  for (const [k,v] of Object.entries(params||{})) {
    if (v === undefined || v === null || v === "") continue;
    u.searchParams.set(k, String(v));
  }
  const r = await fetch(u.toString(), {cache:"no-store"});
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `GET ${kind} ${r.status}`);
  return j && j.value !== undefined ? j.value : null;
}

function cardHTML(dateIso, scheduleForDay, membersById){
  const am = scheduleForDay?.AM || {attendant:"OPEN",operator:"OPEN",third:"OPEN"};
  const pm = scheduleForDay?.PM || {attendant:"OPEN",operator:"OPEN",third:"OPEN"};
  const fmt = (id) => membersById.get(String(id||"OPEN")) || String(id||"OPEN");
  const shiftBlock = (label, obj) => `
    <div class="shift">
      <div class="hdr"><div class="name">${label}</div><div class="pill">${label==="AM"?"06–18":"18–06"}</div></div>
      <div class="slot"><span class="k">Att:</span>${fmt(obj.attendant)}</div>
      <div class="slot"><span class="k">Drv:</span>${fmt(obj.operator)}</div>
      <div class="slot"><span class="k">3rd:</span>${fmt(obj.third)}</div>
    </div>
  `;
  return `
    <div class="card day">
      <h3>${dateIso}</h3>
      ${shiftBlock("AM", am)}
      ${shiftBlock("PM", pm)}
    </div>
  `;
}

async function ping(){
  try {
    const r = await fetch(storeBase()+"/health", {cache:"no-store"});
    const j = await r.json().catch(()=>null);
    setPill($("pillStore"), "store: ok", true);
    $("status").textContent = "Store: " + JSON.stringify(j);
  } catch(e) {
    setPill($("pillStore"), "store: error", false);
    $("status").textContent = "Store ping failed: " + e.message;
  }
}

async function load(){
  $("pillWeek").textContent = "week: " + weekStartVal();
  $("status").textContent = "Loading…";
  const week = weekStartVal();
  const version = ($("version").value||"published").trim();
  const [members, planned, published] = await Promise.all([
    scGet("members").catch(()=>[]),
    scGet("schedule", {week, version:"planned"}).catch(()=>null),
    scGet("schedule", {week, version:"published"}).catch(()=>null)
  ]);
  const schedWrap = (version==="published" ? published : planned) || published || planned;
  const schedule = schedWrap?.schedule || schedWrap || null;
  const membersById = new Map((Array.isArray(members)?members:[]).map(m=>[String(m.member_id??m.id??""), String(m.name||m.member_id||m.id||"")]));

  if (!schedule) {
    $("status").textContent = `No schedule found for week ${week} (planned or published).`;
    $("grid").innerHTML = "";
    return;
  }

  const start = new Date(week + "T00:00:00Z");
  let html = "";
  for (let i=0;i<7;i++) {
    const dateIso = isoDateUTC(addDaysUTC(start,i));
    html += cardHTML(dateIso, schedule[dateIso], membersById);
  }
  $("grid").innerHTML = html;
  $("status").textContent = `Showing week ${week} • requested=${version} • using=${(version==="published" && published)? "published" : ((version==="planned" && planned)? "planned" : (published? "published" : "planned"))}`;
}

function init(){
  function updateNet(){
    const ok = navigator.onLine;
    setPill($("pillNet"), ok ? "online" : "offline", ok);
  }
  window.addEventListener("online", updateNet);
  window.addEventListener("offline", updateNet);
  updateNet();

  $("storeBase").value = localStorage.getItem("sc_store_base") || $("storeBase").value;
  $("weekStart").value = toISODate(sundayOf(new Date()));
  $("btnLoad").addEventListener("click", ()=>load().catch(e=>{$("status").textContent=e.message;}));
  ping();
  load().catch(()=>{});
}
init();
</script>
</body>
</html>
