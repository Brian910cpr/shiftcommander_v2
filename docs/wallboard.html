<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADR-FR Wallboard</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#0f1731;
    --panel2:#0c1329;
    --text:#e7ecff;
    --muted:#a9b3d6;
    --line:rgba(255,255,255,.10);
    --ok:#2ee59d;
    --warn:#ffd166;
    --bad:#ff4d6d;
    --chip: rgba(255,255,255,.06);
    --shadow: 0 12px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 700px at 25% -20%, rgba(124,92,255,.35), transparent 55%),
                radial-gradient(900px 600px at 90% 0%, rgba(88,166,255,.25), transparent 52%),
                linear-gradient(180deg, #060a18, var(--bg));
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow:hidden; /* STATIC by default */
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    background: rgba(8,12,28,.55);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;}
  .dot{width:10px; height:10px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 4px rgba(255,209,102,.14)}
  .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(46,229,157,.12)}
  .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,77,109,.14)}
  .meta{color:var(--muted); font-weight:800; font-size:12px}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
  .btn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:8px 10px;
    border-radius: 999px;
    font-weight:900;
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: var(--chip);
    font-weight:900;
    color:var(--muted);
    white-space:nowrap;
    font-size:12px;
  }
  .chip strong{color:var(--text)}
  main{height: calc(100vh - 54px); padding:10px 12px; overflow:hidden;}
  .weeks{
    height:100%;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .week{
    flex: 1 1 0;
    min-height:0;
    border:1px solid var(--line);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .weekHead{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.12);
    font-weight:950;
    letter-spacing:.2px;
  }
  .weekHead .sub{font-size:12px; color:var(--muted); font-weight:900}
  .grid{
    flex:1;
    min-height:0;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:8px;
    padding:8px;
  }
  .day{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.12);
    border-radius: 14px;
    padding:8px 8px 6px;
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .dayTop{
    display:flex; align-items:baseline; justify-content:space-between; gap:8px;
    margin-bottom:6px;
  }
  .dow{font-size:11px; color:var(--muted); font-weight:900; letter-spacing:.3px; text-transform:uppercase}
  .dnum{font-size: clamp(14px, 2.4vh, 22px); font-weight:1000; line-height:1}
  .crew{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-height:0;
  }
  .slot{
    display:flex;
    justify-content:space-between;
    gap:8px;
    align-items:flex-start;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius: 12px;
    padding:6px 7px;
    min-height: 0;
  }
  .slotLabel{
    font-size:11px;
    color:var(--muted);
    font-weight:950;
    width:32px;
    flex:0 0 auto;
  }
  .names{
    flex:1 1 auto;
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .n{
    font-size: clamp(11px, 1.8vh, 15px);
    font-weight:950;
    line-height:1.05;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .n.muted{color:var(--muted); font-weight:900}
  .flags{
    flex:0 0 auto;
    display:flex;
    flex-direction:column;
    gap:2px;
    align-items:flex-end;
    font-size:10px;
    font-weight:1000;
    color: var(--warn);
    white-space:nowrap;
  }
  .flagBad{color: var(--bad)}
  .flagOk{color: var(--ok)}
  .day.bad{border-color: rgba(255,77,109,.55); box-shadow: inset 0 0 0 1px rgba(255,77,109,.35)}
  .day.warn{border-color: rgba(255,209,102,.55); box-shadow: inset 0 0 0 1px rgba(255,209,102,.30)}
  .tiny{font-size:11px; color:var(--muted); font-weight:850}
  .hidden{display:none !important;}

  /* If user opts into scroll mode (?scroll=1) */
  body.scroll main{overflow:auto}
  body.scroll{overflow:auto}
</style>
</head>
<body>
<header>
  <div class="brand"><span id="statusDot" class="dot"></span><div>
    ADR-FR Wallboard
    <div class="meta" id="statusText">Loading…</div>
  </div></div>
  <div class="toolbar">
    <span class="chip" id="chipWeeks">Weeks: <strong id="weeksCount">—</strong></span>
    <span class="chip" id="chipMode">Mode: <strong id="modeText">AM+PM</strong></span>
    <button class="btn" id="btnMode">Toggle AM/PM</button>
    <button class="btn" id="btnArchived">Archived</button>
    <button class="btn" id="btnReload">Reload</button>
  </div>
</header>

<main>
  <div class="weeks" id="weeks"></div>
</main>

<script>
/** ========= CONFIG ========= **/
const STORE_URL = "https://schedule-cors-910cpr.brian-9ac.workers.dev";
const KIND_SCHEDULE = "schedule";
const KIND_MEMBERS  = "members";
const KIND_ORG      = "org_settings";
const AUTO_REFRESH_MS = 5 * 60 * 1000;

const ALS_KEYS = ["PARAMEDIC","MEDIC","AEMT","ALS"];
const EMT_KEYS = ["EMT","AEMT","PARAMEDIC","MEDIC"];

const params = new URLSearchParams(location.search);
const SCROLL_MODE = params.get("scroll")==="1";
const SHOW_ARCHIVED_DEFAULT = params.get("archived")==="1";

if(SCROLL_MODE) document.body.classList.add("scroll");

/** ========= STATE ========= **/
let state = {
  schedule: null,
  members: null,
  org: null,
  nameById: {},
  qualById: {},
  availById: {},  // member_id -> availability json
  showArchived: SHOW_ARCHIVED_DEFAULT,
  mode: "BOTH" // BOTH | AM | PM
};

function setStatus(kind, text){
  const dot = document.getElementById("statusDot");
  const el = document.getElementById("statusText");
  el.textContent = text || "";
  dot.classList.remove("ok","bad");
  if(kind==="ok") dot.classList.add("ok");
  if(kind==="bad") dot.classList.add("bad");
}

function storeUrl(kind){
  const u = new URL(STORE_URL, location.origin);
  u.searchParams.set("kind", kind);
  return u.toString();
}
async function fetchJson(url){
  const r = await fetch(url, { cache:"no-store" });
  const t = await r.text();
  try{
    const j = JSON.parse(t);
    if(j && j.ok === false) throw new Error(j.error || "Store error");
    return j;
  }catch(e){
    if(t.trim().startsWith("<!DOCTYPE html")) throw new Error("Upstream returned HTML (wrong origin / auth / cors).");
    throw e;
  }
}
function unwrap(j){
  if(j && typeof j === "object"){
    if(j.payload !== undefined) return j.payload;
    if(j.data !== undefined) return j.data;
  }
  return j;
}

/** ========= DATE HELPERS ========= **/
function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function addDays(d,n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function startOfWeek(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const dow = x.getDay(); // 0 Sun
  x.setDate(x.getDate()-dow);
  return x;
}
function fmtWeekRange(weekStart){
  const end = addDays(weekStart,6);
  const opts={month:"short", day:"numeric"};
  const a = weekStart.toLocaleDateString(undefined, opts);
  const b = end.toLocaleDateString(undefined, opts);
  return `${a} — ${b}`;
}
function dowName(i){
  return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][i] || "";
}

/** ========= MEMBERS / QUALS ========= **/
function buildMemberMaps(membersPayload){
  const arr = Array.isArray(membersPayload?.members) ? membersPayload.members : (Array.isArray(membersPayload)?membersPayload:[]);
  const nameById = {};
  const qualById = {};
  for(const m of arr){
    const id = String(m.member_id||"").trim();
    if(!id) continue;
    const nm = (m.first_name && m.last_name) ? `${m.first_name} ${m.last_name}` : (m.name||id);
    nameById[id] = nm;
    const q = new Set((m.qualifications||m.quals||[]).map(x=>String(x).toUpperCase().trim()).filter(Boolean));
    qualById[id] = q;
  }
  return {nameById, qualById};
}
function isALS(id){
  const q = state.qualById[id];
  if(!q) return false;
  return ALS_KEYS.some(k=>q.has(k));
}
function isEMT(id){
  const q = state.qualById[id];
  if(!q) return false;
  return EMT_KEYS.some(k=>q.has(k));
}
function displayName(id){
  if(!id) return "OPEN";
  const s = String(id);
  if(s.toUpperCase()==="OPEN") return "OPEN";
  return state.nameById[s] || s;
}

/** ========= AVAILABILITY ========= **/
async function loadAvailabilityFor(memberId){
  if(state.availById[memberId]) return state.availById[memberId];
  try{
    const j = await fetchJson(storeUrl(`member_availability_${memberId}`));
    state.availById[memberId] = unwrap(j) || {};
  }catch(e){
    state.availById[memberId] = null;
  }
  return state.availById[memberId];
}
function shiftKey(shift){
  return shift==="AM" ? "am" : "pm";
}
function availabilityState(av, dateIso, shift){
  if(!av || !av.days) return null;
  const d = av.days[dateIso];
  if(!d) return null;
  const key = shiftKey(shift);
  return d[key] || null;
}
// Interpret availability state values used in your JSON
function isUnavailableState(s){
  if(!s) return false;
  const v = String(s).toLowerCase();
  // Based on your current files: "clear" behaves like a block (unavailable)
  return (v === "clear" || v === "no" || v === "unavail" || v === "unavailable");
}

/** ========= SCHEDULE READ ========= **/
function getSlot(dayObj, shift){
  if(!dayObj) return ["OPEN","OPEN"];
  const a = dayObj[shift] || dayObj[shift.toLowerCase()];
  if(Array.isArray(a)) return [String(a[0]||"OPEN"), String(a[1]||"OPEN")];
  return ["OPEN","OPEN"];
}

function computeWeeksToShow(){
  const vh = Math.max(document.documentElement.clientHeight||0, window.innerHeight||0);
  // header ~54px, padding ~20px, gap ~10px
  const usable = vh - 70;
  // try to show between 4 and 6 weeks depending on height
  if(usable < 560) return 4;
  if(usable < 760) return 5;
  return 6;
}

/** ========= RENDER ========= **/
function el(tag, cls, txt){
  const e = document.createElement(tag);
  if(cls) e.className = cls;
  if(txt !== undefined) e.textContent = txt;
  return e;
}

async function render(){
  const schedule = state.schedule;
  const container = document.getElementById("weeks");
  container.innerHTML = "";

  const today = new Date();
  const week0 = startOfWeek(today);

  const weeksWanted = Number(params.get("weeks")||"") || computeWeeksToShow();
  document.getElementById("weeksCount").textContent = String(weeksWanted);

  // Build list of week starts
  const starts = [];
  // optional archived week (week -1)
  if(state.showArchived){
    starts.push(addDays(week0,-7));
  }
  for(let w=0; w<weeksWanted; w++){
    starts.push(addDays(week0, w*7));
  }

  // Determine which member IDs appear in visible weeks and prefetch avail
  const visibleIds = new Set();
  for(const ws of starts){
    for(let i=0;i<7;i++){
      const di = isoDate(addDays(ws,i));
      const dayObj = schedule?.[di];
      if(!dayObj) continue;
      for(const sh of ["AM","PM"]){
        const [a,b] = getSlot(dayObj, sh);
        if(a && a!=="OPEN") visibleIds.add(a);
        if(b && b!=="OPEN") visibleIds.add(b);
      }
    }
  }
  // Prefetch availability (best effort). Don't block rendering forever.
  const idList = Array.from(visibleIds);
  await Promise.all(idList.map(id => loadAvailabilityFor(id)));

  for(const ws of starts){
    const weekCard = el("section","week");
    const head = el("div","weekHead");
    head.appendChild(el("div","", `Week of ${ws.getFullYear()}-${String(ws.getMonth()+1).padStart(2,'0')}-${String(ws.getDate()).padStart(2,'0')}`));
    head.appendChild(el("div","sub", fmtWeekRange(ws)));
    weekCard.appendChild(head);

    const grid = el("div","grid");
    let weekHasBad=false, weekHasWarn=false;

    for(let i=0;i<7;i++){
      const d = addDays(ws,i);
      const di = isoDate(d);
      const day = el("div","day");
      const top = el("div","dayTop");
      top.appendChild(el("div","dow", dowName(d.getDay())));
      top.appendChild(el("div","dnum", String(d.getDate())));
      day.appendChild(top);

      const crew = el("div","crew");

      const dayObj = schedule?.[di] || null;

      const shiftsToShow = (state.mode==="AM") ? ["AM"] : (state.mode==="PM") ? ["PM"] : ["AM","PM"];

      let dayBad=false, dayWarn=false;

      for(const sh of shiftsToShow){
        const [att, op] = getSlot(dayObj, sh);
        const slot = el("div","slot");
        slot.appendChild(el("div","slotLabel", sh));

        const names = el("div","names");
        const attName = displayName(att);
        const opName = displayName(op);

        // build flags
        const flags = el("div","flags");
        const addFlag = (txt, bad=false)=>{
          const f = el("div", bad ? "flagBad" : "", txt);
          flags.appendChild(f);
        };

        // seat sanity
        if(att !== "OPEN" && !isALS(att)) { addFlag("ALS?", true); dayBad=true; }
        if(op !== "OPEN" && !isEMT(op))  { addFlag("EMT?", true); dayBad=true; }
        if(att !== "OPEN" && op !== "OPEN" && att === op){ addFlag("DUP", true); dayBad=true; }

        // availability sanity (if we have it)
        if(att !== "OPEN"){
          const av = state.availById[att];
          const st = availabilityState(av, di, sh);
          if(isUnavailableState(st)){ addFlag("AVAIL", true); dayBad=true; }
        }
        if(op !== "OPEN"){
          const av = state.availById[op];
          const st = availabilityState(av, di, sh);
          if(isUnavailableState(st)){ addFlag("AVAIL", true); dayBad=true; }
        }

        const n1 = el("div","n", attName);
        const n2 = el("div","n", opName);
        if(att==="OPEN") n1.classList.add("muted");
        if(op==="OPEN") n2.classList.add("muted");

        names.appendChild(n1);
        names.appendChild(n2);
        slot.appendChild(names);
        if(flags.childNodes.length) slot.appendChild(flags);
        crew.appendChild(slot);

        if(!dayBad){
          // warnings (soft): two OPENs
          if(att==="OPEN" || op==="OPEN") dayWarn=true;
        }
      }

      day.appendChild(crew);

      if(dayBad){ day.classList.add("bad"); weekHasBad=true; }
      else if(dayWarn){ day.classList.add("warn"); weekHasWarn=true; }

      grid.appendChild(day);
    }

    weekCard.appendChild(grid);

    // update status dot based on worst visible
    if(weekHasBad) {}
    container.appendChild(weekCard);
  }

  document.getElementById("modeText").textContent = (state.mode==="BOTH") ? "AM+PM" : state.mode;
}

/** ========= LOAD + LOOP ========= **/
async function loadAll(){
  setStatus("warn","Loading schedule / members / org…");
  const [schedJ, memJ, orgJ] = await Promise.all([
    fetchJson(storeUrl(KIND_SCHEDULE)),
    fetchJson(storeUrl(KIND_MEMBERS)),
    fetchJson(storeUrl(KIND_ORG))
  ]);
  state.schedule = unwrap(schedJ) || {};
  state.members  = unwrap(memJ) || {};
  state.org      = unwrap(orgJ) || {};
  const maps = buildMemberMaps(state.members);
  state.nameById = maps.nameById;
  state.qualById = maps.qualById;
  setStatus("ok","Loaded.");
  await render();
}

function toggleMode(){
  state.mode = (state.mode==="BOTH") ? "AM" : (state.mode==="AM") ? "PM" : "BOTH";
  document.getElementById("modeText").textContent = (state.mode==="BOTH") ? "AM+PM" : state.mode;
  render();
}
function toggleArchived(){
  state.showArchived = !state.showArchived;
  document.getElementById("btnArchived").textContent = state.showArchived ? "Archived ✓" : "Archived";
  render();
}

document.getElementById("btnMode").addEventListener("click", toggleMode);
document.getElementById("btnArchived").addEventListener("click", toggleArchived);
document.getElementById("btnReload").addEventListener("click", ()=>location.reload());

(async ()=>{
  try{
    document.getElementById("btnArchived").textContent = state.showArchived ? "Archived ✓" : "Archived";
    await loadAll();
    setInterval(async ()=>{
      try{
        const schedJ = await fetchJson(storeUrl(KIND_SCHEDULE));
        state.schedule = unwrap(schedJ) || {};
        await render();
        setStatus("ok","Updated.");
      }catch(e){
        setStatus("bad","Update failed: " + (e.message||e));
      }
    }, AUTO_REFRESH_MS);
  }catch(e){
    console.error(e);
    setStatus("bad", "Load failed: " + (e.message||e));
  }
})();
</script>
</body>
</html>
