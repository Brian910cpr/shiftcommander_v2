<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander — Supervisor</title>
<style>
:root{--b:#d9d9d9;--g:#f6f6f6;--mut:#666;--ok:#157f3b}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px}
h2{margin:0 0 8px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select,button{font:inherit;padding:6px 8px;border:1px solid var(--b);border-radius:10px}
button{cursor:pointer}
.card{border:1px solid var(--b);border-radius:16px;padding:12px;margin-top:12px}
.small{font-size:12px;color:var(--mut)}
table{border-collapse:separate;border-spacing:0;width:100%;margin-top:8px}
th,td{border:1px solid var(--b);padding:6px 8px;font-size:12px;vertical-align:top}
th{background:var(--g);text-align:left;position:sticky;top:0;z-index:2}
.pill{display:inline-block;border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:11px}
.pill.lock{background:#fff7ed;border-color:#fdba74}
.pill.plan{background:#f3f4f6}
.pill.pub{background:#eff6ff;border-color:#bfdbfe}
.good{color:var(--ok)}
.bad{color:#b91c1c}
.k{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
pre{white-space:pre-wrap;margin:0}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>

<h2>Supervisor</h2>

<div class="row">
  <label>Store <input id="store" size="46" value="https://store.adr-fr.org" /></label>
  <label>Write Key <input id="writeKey" size="18" placeholder="SC_TOKEN" /></label>
  <label>Week (Sun) <input id="week" type="date" /></label>
  <button id="btnSaveCfg">Save</button>
  <button id="btnLoad">Load</button>
  <span id="msg" class="small"></span>
</div>

<div class="card">
  <div class="actions">
    <button id="btnLoadLocks">Load Locks</button>
    <button id="btnSaveLocks">Save Locks</button>
    <button id="btnCopyLocksToPlanned">Locks → Planned</button>
    <button id="btnPublishPlanned">Publish Planned</button>
    <button id="btnLoadPublished">Load Published</button>
    <span class="small">Versions: <span class="k">locks</span>, <span class="k">planned</span>, <span class="k">published</span></span>
  </div>

  <table id="locksTbl">
    <thead><tr>
      <th style="width:120px">Date</th>
      <th style="width:70px">Shift</th>
      <th style="width:120px">Unit</th>
      <th style="width:160px">Seat</th>
      <th>Member</th>
      <th style="width:70px">Hrs</th>
      <th style="width:50px"></th>
    </tr></thead>
    <tbody></tbody>
  </table>
  <div class="actions" style="margin-top:8px">
    <button id="btnAddLock">+ Add lock</button>
  </div>
</div>

<div class="card">
  <div class="small">Combined view (locks + planned + published)</div>
  <table id="combinedTbl">
    <thead><tr>
      <th style="width:120px">Date</th><th style="width:70px">Shift</th><th style="width:120px">Unit</th><th style="width:160px">Seat</th>
      <th>Member</th><th style="width:120px">Status</th><th style="width:70px">Hrs</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <div class="actions">
    <button id="btnRefreshCore">Refresh Drive→KV (core)</button>
    <span class="small">members/units/seats/org_settings/qualifications</span>
  </div>
  <pre id="diag" class="small"></pre>
</div>

<script>

const LS_STORE_BASE = "sc_store_base";
const LS_WRITE_KEY  = "sc_write_key"; // SC_TOKEN equivalent in-browser

const $ = (id)=>document.getElementById(id);

function normBase(u){
  u = String(u||"").trim();
  if(!u) return "";
  try{
    const x = new URL(u);
    x.hash=""; x.search="";
    return x.toString().replace(/\/+$/,"");
  } catch(e){
    return u.replace(/\/+$/,"");
  }
}

function getStoreBase(){
  return normBase(localStorage.getItem(LS_STORE_BASE) || "https://store.adr-fr.org") || "https://store.adr-fr.org";
}
function setStoreBase(v){
  localStorage.setItem(LS_STORE_BASE, normBase(v) || "https://store.adr-fr.org");
}
function getWriteKey(){
  return String(localStorage.getItem(LS_WRITE_KEY) || "").trim();
}
function setWriteKey(v){
  localStorage.setItem(LS_WRITE_KEY, String(v||"").trim());
}

async function scGet(kind, params = {}){
  const url = new URL(getStoreBase() + "/sc/get");
  url.searchParams.set("kind", kind);
  for(const [k,v] of Object.entries(params||{})){
    if(v===undefined || v===null || v==="") continue;
    url.searchParams.set(k, String(v));
  }
  const r = await fetch(url.toString(), { cache:"no-store" });
  const j = await r.json().catch(()=>null);
  if(!r.ok) throw new Error(j?.error || `GET ${kind} failed (${r.status})`);
  if(!j || j.ok===false) throw new Error(j?.error || `GET ${kind} failed`);
  return j.value;
}

async function scPut(kind, value, params = {}){
  const key = getWriteKey();
  if(!key) throw new Error("Missing SC_TOKEN (write key). Enter it then Save.");
  const body = { kind, value, ...params };
  const r = await fetch(getStoreBase() + "/sc/put", {
    method:"POST",
    headers:{
      "content-type":"application/json",
      "x-adr-write-key": key
    },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>null);
  if(!r.ok) throw new Error(j?.error || `PUT ${kind} failed (${r.status})`);
  if(!j || j.ok===false) throw new Error(j?.error || `PUT ${kind} failed`);
  return j;
}

function iso(d){ return d.toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function nextSunday(from=new Date()){
  const d = new Date(from); d.setHours(0,0,0,0);
  const add = (7 - d.getDay()) % 7;
  d.setDate(d.getDate()+add);
  return d;
}

async function loadMembersFlat(){
  const v = await scGet("members");
  const arr = Array.isArray(v) ? v : (Array.isArray(v?.members) ? v.members : []);
  const nameBy = {};
  for(const m of arr){
    const id = String(m.member_id ?? m.id ?? "");
    if(!id) continue;
    nameBy[id] = ((m.first_name||"")+" "+(m.last_name||"")).trim() || id;
  }
  return {members:arr, nameBy};
}


function setMsg(t, ok=true) {
  const el = $("msg");
  el.className = "small " + (ok ? "good" : "bad");
  el.textContent = t || "";
}

function loadCfgToInputs(){
  $("store").value = getStoreBase();
  $("writeKey").value = getWriteKey();
}
function saveCfgFromInputs(){
  setStoreBase($("store").value);
  setWriteKey($("writeKey").value);
}

function mkMemberOptions(nameBy, selectedId){
  const ids = Object.keys(nameBy).sort((a,b)=>nameBy[a].localeCompare(nameBy[b]));
  return '<option value=""></option>' + ids.map(id =>
    `<option value="${id}" ${String(selectedId||"")===id?"selected":""}>${nameBy[id]} (${id})</option>`
  ).join("");
}

function lockRowHtml(r, nameBy){
  return `<tr>
    <td><input class="date" value="${r.date||""}" placeholder="YYYY-MM-DD" /></td>
    <td>
      <select class="shift">
        <option value="AM" ${(r.shift||"AM")==="AM"?"selected":""}>AM</option>
        <option value="PM" ${(r.shift||"AM")==="PM"?"selected":""}>PM</option>
      </select>
    </td>
    <td><input class="unit" value="${r.unit||""}" /></td>
    <td><input class="seat" value="${r.seat||""}" /></td>
    <td><select class="member">${mkMemberOptions(nameBy, r.member_id)}</select></td>
    <td><input class="hrs" type="number" min="1" max="24" value="${Number(r.hours||12)}" /></td>
    <td><button class="del">x</button></td>
  </tr>`;
}

function readLocksTable(){
  const rows = [...$("locksTbl").querySelectorAll("tbody tr")];
  const locks = rows.map(tr => {
    const date = tr.querySelector(".date").value.trim();
    const shift = tr.querySelector(".shift").value.trim();
    const unit = tr.querySelector(".unit").value.trim();
    const seat = tr.querySelector(".seat").value.trim();
    const member_id = tr.querySelector(".member").value.trim();
    const hours = Number(tr.querySelector(".hrs").value || 12);
    return {date, shift, unit, seat, member_id, hours};
  }).filter(x => x.date && x.unit && x.seat && x.member_id);
  return {
    schema:"sc.locks.v1",
    week_start: $("week").value,
    locks
  };
}

function renderLocks(doc, nameBy){
  const locks = (doc && Array.isArray(doc.locks)) ? doc.locks : [];
  const tbody = $("locksTbl").querySelector("tbody");
  tbody.innerHTML = locks.map(r => lockRowHtml(r, nameBy)).join("");
  tbody.querySelectorAll("button.del").forEach(b => b.onclick = () => b.closest("tr").remove());
}

function pill(status){
  if(status==="locked") return '<span class="pill lock">locked</span>';
  if(status==="planned") return '<span class="pill plan">planned</span>';
  if(status==="published") return '<span class="pill pub">published</span>';
  return status;
}

function renderCombined(locksDoc, plannedDoc, pubDoc, nameBy){
  const rows=[];
  (locksDoc?.locks||[]).forEach(x => rows.push({...x, _status:"locked"}));
  (plannedDoc?.items||[]).forEach(x => rows.push({...x, _status:"planned"}));
  (pubDoc?.items||[]).forEach(x => rows.push({...x, _status:"published"}));
  rows.sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.shift||"").localeCompare(b.shift||"") || (a.unit||"").localeCompare(b.unit||"") || (a.seat||"").localeCompare(b.seat||""));
  $("combinedTbl").querySelector("tbody").innerHTML = rows.map(r => `<tr>
    <td>${r.date||""}</td><td>${r.shift||""}</td><td>${r.unit||""}</td><td>${r.seat||""}</td>
    <td>${nameBy[String(r.member_id)]||r.member_id||""}</td>
    <td>${pill(r._status)}</td>
    <td>${Number(r.hours||12)}</td>
  </tr>`).join("");
}

async function loadAll(){
  saveCfgFromInputs();
  const week = $("week").value;
  setMsg("loading…");
  const core = await loadMembersFlat();
  const locks = await scGet("schedule", {week, version:"locks"}).catch(()=>({schema:"sc.locks.v1", week_start:week, locks:[]}));
  const planned = await scGet("schedule", {week, version:"planned"}).catch(()=>({schema:"sc.schedule.v1", week_start:week, items:[]}));
  const published = await scGet("schedule", {week, version:"published"}).catch(()=>({schema:"sc.schedule.v1", week_start:week, items:[]}));
  renderLocks(locks, core.nameBy);
  renderCombined(locks, planned, published, core.nameBy);
  setMsg(`loaded week ${week}`, true);
}

$("btnSaveCfg").onclick = () => {
  saveCfgFromInputs();
  setMsg("saved", true);
};

$("btnLoad").onclick = () => loadAll();

$("btnAddLock").onclick = async () => {
  saveCfgFromInputs();
  const core = await loadMembersFlat();
  const tbody = $("locksTbl").querySelector("tbody");
  tbody.insertAdjacentHTML("beforeend", lockRowHtml({date:"",shift:"AM",unit:"",seat:"",member_id:"",hours:12}, core.nameBy));
  tbody.querySelectorAll("button.del").forEach(b => b.onclick = () => b.closest("tr").remove());
};

$("btnLoadLocks").onclick = async () => {
  saveCfgFromInputs();
  const week = $("week").value;
  const core = await loadMembersFlat();
  const locks = await scGet("schedule", {week, version:"locks"}).catch(()=>({schema:"sc.locks.v1", week_start:week, locks:[]}));
  renderLocks(locks, core.nameBy);
  setMsg("locks loaded", true);
};

$("btnSaveLocks").onclick = async () => {
  saveCfgFromInputs();
  const week = $("week").value;
  const doc = readLocksTable();
  await scPut("schedule", doc, {week, version:"locks"});
  setMsg("locks saved", true);
  await loadAll();
};

$("btnCopyLocksToPlanned").onclick = async () => {
  saveCfgFromInputs();
  const week = $("week").value;
  const locks = readLocksTable();
  const planned = {
    schema:"sc.schedule.v1",
    week_start: week,
    items: (locks.locks||[]).map(lk => ({date:lk.date, shift:lk.shift, unit:lk.unit, seat:lk.seat, member_id:lk.member_id, hours:lk.hours}))
  };
  await scPut("schedule", planned, {week, version:"planned"});
  setMsg("planned saved (from locks)", true);
  await loadAll();
};

$("btnPublishPlanned").onclick = async () => {
  saveCfgFromInputs();
  const week = $("week").value;
  const planned = await scGet("schedule", {week, version:"planned"}).catch(()=>null);
  if(!planned) throw new Error("No planned schedule to publish.");
  await scPut("schedule", planned, {week, version:"published"});
  setMsg("published", true);
  await loadAll();
};

$("btnLoadPublished").onclick = async () => {
  saveCfgFromInputs();
  const week = $("week").value;
  const core = await loadMembersFlat();
  const locks = await scGet("schedule", {week, version:"locks"}).catch(()=>({schema:"sc.locks.v1", week_start:week, locks:[]}));
  const planned = await scGet("schedule", {week, version:"planned"}).catch(()=>({schema:"sc.schedule.v1", week_start:week, items:[]}));
  const published = await scGet("schedule", {week, version:"published"}).catch(()=>({schema:"sc.schedule.v1", week_start:week, items:[]}));
  renderCombined(locks, planned, published, core.nameBy);
  setMsg("published loaded", true);
};

$("btnRefreshCore").onclick = async () => {
  saveCfgFromInputs();
  const kinds=["members","units","seats","org_settings","qualifications"];
  const out=[];
  for(const k of kinds){
    const u = new URL(getStoreBase()+"/sc/refresh");
    u.searchParams.set("kind", k);
    const r = await fetch(u.toString(), {cache:"no-store"});
    const j = await r.json().catch(()=>null);
    out.push({kind:k, ok:r.ok && j && j.ok!==false, status:r.status, source:j?.source, error:j?.error||null});
  }
  $("diag").textContent = JSON.stringify(out, null, 2);
  setMsg("refreshed core", true);
};

(function init(){
  loadCfgToInputs();
  $("week").value = iso(nextSunday(new Date()));
})();
</script>

</body>
</html>
