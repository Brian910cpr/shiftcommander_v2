<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShiftCommander â€” Supervisor</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;margin:16px;}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button,textarea{font:inherit;padding:6px 8px}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px}
th{background:#f6f6f6;text-align:left}
.bad{color:#b00020;font-weight:600}
.small{font-size:12px;color:#666}
</style></head>
<body>
<h2>Supervisor</h2>

<div class="row">
  <label>Store URL <input id="store" size="80" placeholder="https://script.google.com/macros/s/DEPLOY/exec"></label>
  <label>Token <input id="token" size="30" placeholder="TOKEN"></label>
  <button id="saveCfg">Save</button>
  <span class="small">reads/writes Drive via Apps Script</span>
</div>

<hr>

<div class="row">
  <label>Week (Sun) <input id="week" type="date"></label>
  <button id="loadLocks">Load Locks</button>
  <button id="addLock">+ Add Lock</button>
  <button id="saveLocks">Save Locks</button>
  <button id="costPreview">Cost Preview</button>
</div>

<div id="capMsg" class="small"></div>

<table id="locksTbl">
  <thead>
    <tr>
      <th>Date</th><th>AM/PM</th><th>Unit</th><th>Seat</th><th>Member</th><th>Hours</th><th>Reason</th><th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<pre id="preview" style="white-space:pre-wrap;"></pre>

<script>
const qs = new URLSearchParams(location.search);
const LS_CFG = "sc_cfg_v2";

function loadCfg(){
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  document.getElementById("store").value = cfg.store || "";
  document.getElementById("token").value = cfg.token || "";
}
function saveCfg(){
  localStorage.setItem(LS_CFG, JSON.stringify({
    store: document.getElementById("store").value.trim(),
    token: document.getElementById("token").value.trim()
  }));
}
document.getElementById("saveCfg").onclick = () => saveCfg();

function store(){ 
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  return (document.getElementById("store").value.trim() || cfg.store || "").replace(/\/+$/,'');
}
function token(){
  const cfg = JSON.parse(localStorage.getItem(LS_CFG) || "{}");
  return (document.getElementById("token").value.trim() || cfg.token || "");
}
async function apiGet(kind, params={}){
  const u = new URL(store());
  u.searchParams.set("kind", kind);
  u.searchParams.set("token", token());
  for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
  const r = await fetch(u.toString(), {cache:"no-store"});
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j || j.ok===false) throw new Error((j&&j.error)?j.error:`GET ${kind} failed`);
  return j.payload;
}
async function apiPost(kind, body){
  body = body || {};
  body.kind = kind;
  body.token = token();
  const r = await fetch(store(), {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j || j.ok===false) {
    const msg = (j&&j.error)?j.error:`POST ${kind} failed`;
    const e = new Error(msg);
    e.details = j && (j.details || j._status);
    throw e;
  }
  return j.payload;
}

let MEMBERS = [];
async function loadMembers(){
  const doc = await apiGet("members");
  MEMBERS = Array.isArray(doc.members) ? doc.members : (Array.isArray(doc)?doc:[]);
}
function memberOptions(selected){
  return MEMBERS.map(m=>{
    const id = m.member_id;
    const n = (m.first_name||"") + " " + (m.last_name||"");
    return `<option value="${id}" ${id===selected?"selected":""}>${n.trim()} (${id})</option>`;
  }).join("");
}
function rowHtml(lock){
  return `<tr>
    <td><input type="date" value="${lock.date||""}"></td>
    <td>
      <select>
        <option value="AM" ${(lock.shift||"")==="AM"?"selected":""}>AM</option>
        <option value="PM" ${(lock.shift||"")==="PM"?"selected":""}>PM</option>
      </select>
    </td>
    <td><input value="${lock.unit||""}" size="6"></td>
    <td><input value="${lock.seat||""}" size="10"></td>
    <td><select>${memberOptions(lock.member_id||"")}</select></td>
    <td><input type="number" value="${lock.hours||12}" min="0" step="0.5" style="width:80px"></td>
    <td><input value="${(lock.reason||"")}" size="24"></td>
    <td><button class="del">X</button></td>
  </tr>`;
}
function tableToLocks(){
  const rows = [...document.querySelectorAll("#locksTbl tbody tr")];
  return rows.map(tr=>{
    const tds = tr.querySelectorAll("td");
    return {
      date: tds[0].querySelector("input").value,
      shift: tds[1].querySelector("select").value,
      unit: tds[2].querySelector("input").value.trim(),
      seat: tds[3].querySelector("input").value.trim(),
      member_id: tds[4].querySelector("select").value,
      hours: Number(tds[5].querySelector("input").value||0),
      reason: tds[6].querySelector("input").value.trim()
    };
  }).filter(x=>x.date && x.member_id);
}
function renderLocks(locks){
  const tb = document.querySelector("#locksTbl tbody");
  tb.innerHTML = (locks||[]).map(l=>rowHtml(l)).join("");
  tb.querySelectorAll("button.del").forEach(btn=>{
    btn.onclick = (e)=>{ e.preventDefault(); btn.closest("tr").remove(); };
  });
}

function todayISO(){ return new Date().toISOString().slice(0,10); }
function nextSundayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  const add=(7-d.getDay())%7; d.setDate(d.getDate()+add);
  return d.toISOString().slice(0,10);
}

document.getElementById("week").value = qs.get("week") || nextSundayISO();

document.getElementById("loadLocks").onclick = async ()=>{
  document.getElementById("preview").textContent = "";
  document.getElementById("capMsg").textContent = "";
  await loadMembers();
  const week = document.getElementById("week").value;
  const doc = await apiGet("locks", {week});
  renderLocks(doc.locks || []);
};

document.getElementById("addLock").onclick = async ()=>{
  if (!MEMBERS.length) await loadMembers();
  const tb = document.querySelector("#locksTbl tbody");
  const l = {date:document.getElementById("week").value, shift:"AM", unit:"120", seat:"BLS_DRIVER", member_id: MEMBERS[0]?.member_id || "", hours:12, reason:""};
  tb.insertAdjacentHTML("beforeend", rowHtml(l));
  tb.querySelectorAll("button.del").forEach(btn=>{
    btn.onclick = (e)=>{ e.preventDefault(); btn.closest("tr").remove(); };
  });
};

document.getElementById("saveLocks").onclick = async ()=>{
  document.getElementById("preview").textContent = "";
  document.getElementById("capMsg").textContent = "";
  const week = document.getElementById("week").value;
  const payload = { schema:"sc.locks.v1", week_start: week, locks: tableToLocks() };
  try{
    await apiPost("locks", {week, payload, allow_over_cap:false});
    document.getElementById("capMsg").textContent = "Saved.";
  }catch(e){
    document.getElementById("capMsg").innerHTML = `<span class="bad">${e.message}</span>` + (e.details?` <span class="small">${JSON.stringify(e.details)}</span>`:"");
  }
};

document.getElementById("costPreview").onclick = async ()=>{
  document.getElementById("capMsg").textContent = "";
  const week = document.getElementById("week").value;
  const p = await apiGet("cost_preview", {week});
  document.getElementById("preview").textContent = JSON.stringify(p, null, 2);
};

loadCfg();
</script>
</body></html>