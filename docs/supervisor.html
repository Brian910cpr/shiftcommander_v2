<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander — Supervisor</title>
<style>
:root{--bg:#0b1020;--card:#111a33;--line:rgba(255,255,255,.12);--text:#eaf1ff;--muted:rgba(234,241,255,.55)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
header{position:sticky;top:0;background:#050814cc;border-bottom:1px solid var(--line);padding:10px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
h2{margin:0 0 8px;font-size:14px}
small{color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:8px;text-align:left;vertical-align:top}
input,textarea,select,button{
  background:rgba(255,255,255,.04);color:var(--text);
  border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:7px 9px;font-size:13px
}
button{cursor:pointer;font-weight:800}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
textarea{width:100%;min-height:240px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<header>
  <div class="pill">Supervisor</div>
  <div class="pill" id="status">Status: …</div>
</header>

<main>
  <section class="panel">
    <h2>Roster (Drive)</h2>
    <small>Edits save to Drive as <b>kind=members</b>. Member.html will auto-load this list.</small>

    <div class="row">
      <button id="btnReload">Reload roster</button>
      <button id="btnSave">Save roster</button>
      <button id="btnAdd">Add member</button>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table id="tbl">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Meta</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <h2>Member Availability Viewer (read-only)</h2>
    <small>Loads <b>kind=member_availability</b> for a selected member.</small>

    <div class="row">
      <select id="memberSel"></select>
      <button id="btnLoadAvail">Load</button>
    </div>

    <textarea id="out" spellcheck="false" placeholder="Availability payload will appear here…"></textarea>
  </section>
</main>

<script>
const STORE = { url: "https://adr-fr.org/api/store" };
const K_MEMBERS = "members";
const K_AVAIL = "member_availability";

let roster = [];

function setStatus(t){ document.getElementById("status").textContent = "Status: " + t; }

async function storeGet(params){
  const u = new URL(STORE.url);
  for(const [k,v] of Object.entries(params)) u.searchParams.set(k, String(v));
  u.searchParams.set("_ts", String(Date.now()));
  const r = await fetch(u.toString(), { cache:"no-store" });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "GET failed");
  return j.payload;
}
async function storePost(body){
  const r = await fetch(STORE.url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "POST failed");
  return j;
}

function renderRoster(){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  for(const m of roster){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input data-k="id" value="${escapeHtml(m.id)}" style="width:120px"></td>
      <td><input data-k="name" value="${escapeHtml(m.name)}" style="width:100%"></td>
      <td><input data-k="meta" value="${escapeHtml(m.meta||"")}" style="width:100%"></td>
      <td><button data-act="del">Del</button></td>
    `;
    tr.querySelector('[data-act="del"]').onclick = ()=> {
      roster = roster.filter(x=> x !== m);
      renderRoster();
      renderMemberSel();
    };
    tb.appendChild(tr);
  }
}

function readRosterFromTable(){
  const rows = [...document.querySelectorAll("#tbl tbody tr")];
  const out = [];
  for(const tr of rows){
    const id = tr.querySelector('input[data-k="id"]').value.trim();
    const name = tr.querySelector('input[data-k="name"]').value.trim();
    const meta = tr.querySelector('input[data-k="meta"]').value.trim();
    if(!id || !name) continue;
    out.push({ id, name, meta });
  }
  return out;
}

function renderMemberSel(){
  const sel = document.getElementById("memberSel");
  sel.innerHTML = roster
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(m=> `<option value="${escapeHtml(m.id)}">${escapeHtml(m.name)}</option>`)
    .join("");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function reload(){
  setStatus("Loading roster…");
  roster = await storeGet({ kind: K_MEMBERS });
  if(!Array.isArray(roster)) throw new Error("Roster is not an array");
  roster = roster.map(m=>({ id:String(m.id), name:String(m.name||m.id), meta:String(m.meta||"") }));
  renderRoster();
  renderMemberSel();
  setStatus("Roster loaded");
}

async function save(){
  roster = readRosterFromTable();
  setStatus("Saving roster…");
  await storePost({ kind: K_MEMBERS, payload: roster });
  setStatus("Roster saved");
}

async function loadAvail(){
  const id = document.getElementById("memberSel").value;
  setStatus("Loading availability…");
  const payload = await storeGet({ kind: K_AVAIL, member_id: id });
  document.getElementById("out").value = JSON.stringify(payload, null, 2);
  setStatus("Availability loaded");
}

document.getElementById("btnReload").onclick = ()=> reload().catch(e=>alert(e.message||e));
document.getElementById("btnSave").onclick = ()=> save().catch(e=>alert(e.message||e));
document.getElementById("btnAdd").onclick = ()=>{
  roster.push({ id:"", name:"", meta:"" });
  renderRoster();
};
document.getElementById("btnLoadAvail").onclick = ()=> loadAvail().catch(e=>alert(e.message||e));

reload().catch(e=>{
  setStatus("Error");
  alert(e.message||e);
});
</script>
</body>
</html>
