<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander — Supervisor</title>
<style>
  :root {
    --bg:#0b1220;
    --panel:#0f1a33;
    --panel2:#111f3d;
    --text:#e9eefc;
    --muted:#aab7e6;
    --line:rgba(255,255,255,.12);
    --good:#48d597;
    --warn:#f7c948;
    --bad:#ff6b6b;
    --btn:#2a5bd7;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070b14,var(--bg));color:var(--text);}
  header{position:sticky;top:0;background:rgba(7,11,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20;}
  .wrap{max-width:1400px;margin:0 auto;padding:16px 18px;}
  .title{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
  h1{font-size:18px;margin:0;letter-spacing:.2px}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;align-items:start;}
  @media (max-width: 1100px){.grid{grid-template-columns:1fr;}}
  .card{border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),rgba(15,26,51,.65));border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.35);}
  .card h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600;}
  .card .inner{padding:14px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 10px;font-size:14px;outline:none;}
  input:focus,textarea:focus,select:focus{border-color:rgba(42,91,215,.7);box-shadow:0 0 0 3px rgba(42,91,215,.2)}
  .field{min-width:220px;flex:1;}
  .field.small{min-width:160px;flex:0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
  button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;color:white;background:var(--btn);cursor:pointer}
  button.secondary{background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text)}
  button.danger{background:#b7252a}
  button:disabled{opacity:.55;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--muted);cursor:pointer;font-size:12px;font-weight:700}
  .tab.active{background:rgba(42,91,215,.25);border-color:rgba(42,91,215,.55);color:#d8e4ff}
  .log{height:340px;overflow:auto;background:rgba(0,0,0,.25);border:1px solid var(--line);border-radius:12px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;line-height:1.35;white-space:pre;}
  .log .ok{color:var(--good)}
  .log .warn{color:var(--warn)}
  .log .bad{color:var(--bad)}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 10px;text-align:left;font-size:13px;vertical-align:top}
  th{color:var(--muted);font-weight:700;background:rgba(255,255,255,.04)}
  .tiny{font-size:12px;color:var(--muted)}
  .statusline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  a{color:#9dc1ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .pill{font-weight:700}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .box{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);padding:10px}
  .seatRow{display:grid;grid-template-columns: 130px 1fr 1fr auto;gap:8px;align-items:center;margin-bottom:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--muted);font-size:12px}
  .warnBadge{border-color:rgba(247,201,72,.5);background:rgba(247,201,72,.10);color:#ffe8a6}
</style>
</head>
<body>
<header>
  <div class="wrap title">
    <h1>ShiftCommander — Supervisor</h1>
    <div class="statusline">
      <span class="pill" id="netPill">offline</span>
      <span class="pill" id="storePill">store: —</span>
      <span class="pill" id="weekPill">week: —</span>
      <span class="pill" id="dataPill">data: —</span>
    </div>
  </div>
</header>

<div class="wrap grid">
  <section class="card">
    <div class="inner">
      <h2>Supervisor Tools</h2>

      <div class="row">
        <div class="field">
          <label>Store Base</label>
          <input id="storeBase" value="https://store.adr-fr.org" />
          <div class="hint">Reads: <code>/sc/get</code>. Writes: <code>/sc/put</code> (header <code>x-adr-write-key</code>). Refresh: <code>/sc/refresh?kind=…</code>.</div>
        </div>
        <div class="field">
          <label>Write Key</label>
          <input id="writeKey" placeholder="required to save schedule / ops plan" />
          <div class="hint">Saved as <code>localStorage.sc_write_key</code>.</div>
        </div>
        <div class="field small">
          <label>Week (Sunday)</label>
          <input id="weekStart" type="date" />
        </div>
      </div>

      <div class="actions">
        <button id="btnPing" class="secondary">Ping Store</button>
        <button id="btnRefresh" class="secondary">Refresh from Drive</button>
        <button id="btnLoad" class="secondary">Load Data</button>
        <button id="btnResolve">Resolve Week</button>
        <button id="btnSave" class="secondary">Save Planned</button>
        <button id="btnPublish" class="secondary">Publish</button>
        <a class="pill" href="./wallboard.html" target="_blank">Open Wallboard</a>
        <a class="pill" href="./member.html" target="_blank">Open Member</a>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="ops">Ops Plan (seats)</div>
        <div class="tab" data-tab="data">Data Inspector</div>
        <div class="tab" data-tab="log">Run Log</div>
      </div>

      <div id="tab_ops">
        <div class="hint">
          This brings back the Supervisor “tooling” you were missing: you can actually SEE and CONTROL what seats exist per unit per shift.
          Nothing is hard-coded. No keyed rules. You decide, then the resolver fills it.
        </div>

        <div class="box" style="margin-top:10px">
          <div class="tiny">Active units for this week</div>
          <input id="unitIds" class="mono" value="120,121,131,QRV1"/>
          <div class="hint">Operational IDs. Defaults to your current target fleet.</div>
        </div>

        <div class="box" style="margin-top:10px">
          <div class="tiny">Seat templates</div>
          <div class="hint">Each template has: <b>id</b> (saved), <b>label</b> (display), and <b>requires_any</b> (comma list). Examples: <code>ALS</code>, <code>DRIVER</code>, <code>EMT</code>. You can allow placeholders by including them (e.g. <code>__SAL_ALS_BACKFILL__</code>).</div>
          <div id="seatTemplates"></div>
          <div class="actions" style="margin-top:8px">
            <button id="btnAddSeat" class="secondary">+ Add Template</button>
            <button id="btnSaveOps" class="secondary">Save Ops Plan</button>
            <button id="btnLoadOps" class="secondary">Reload Ops Plan</button>
          </div>
          <div class="tiny" id="opsStatus"></div>
        </div>

        <div class="box" style="margin-top:10px">
          <div class="tiny">Per-shift seat selection (what runs)</div>
          <div class="hint">Check which templates run on each unit for AM vs PM. Default is Attendant + Driver.</div>
          <div id="opsMatrix"></div>
        </div>
      </div>

      <div id="tab_data" style="display:none">
        <div class="kpi" id="kpiRow"></div>
        <div class="box" style="margin-top:10px">
          <div class="tiny">Quick View</div>
          <div class="row" style="margin-top:8px">
            <div class="field small">
              <label>Kind</label>
              <select id="inspectKind">
                <option value="org_settings">org_settings</option>
                <option value="members">members</option>
                <option value="units">units</option>
                <option value="seats">seats</option>
                <option value="availability">availability</option>
                <option value="ops_plan">ops_plan (planned)</option>
                <option value="schedule">schedule (planned)</option>
              </select>
            </div>
            <button id="btnInspect" class="secondary">View JSON</button>
          </div>
          <textarea id="inspectOut" class="mono" style="width:100%;min-height:280px;margin-top:10px"></textarea>
        </div>
      </div>

      <div id="tab_log" style="display:none">
        <div class="tiny">Live log</div>
        <div class="log" id="log"></div>
      </div>

    </div>
  </section>

  <section class="card">
    <div class="inner">
      <h2>Schedule Preview (planned)</h2>
      <div class="tiny" id="schedMeta">No run yet.</div>
      <div style="margin-top:10px;overflow:auto;max-height:720px;border:1px solid var(--line);border-radius:12px">
        <table id="schedTable">
          <thead><tr><th>Date</th><th>AM</th><th>PM</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:10px">
        Units are shown inline so you can visually inspect coverage. If you still see “OPEN”, the inspector will show *why* (requirements vs quals vs availability).
      </div>
    </div>
  </section>
</div>

<script>
/* ---------------- Store client ---------------- */
const STORE_DEFAULT = "https://store.adr-fr.org";
const $ = (id) => document.getElementById(id);

const logEl = $("log");
const netPill = $("netPill");
const storePill = $("storePill");
const weekPill = $("weekPill");
const dataPill = $("dataPill");

function setPill(el, text, ok=true){
  el.textContent = text;
  el.style.borderColor = ok ? "rgba(72,213,151,.5)" : "rgba(255,107,107,.5)";
  el.style.background = ok ? "rgba(72,213,151,.10)" : "rgba(255,107,107,.10)";
  el.style.color = ok ? "#b7f7dd" : "#ffd0d0";
}
function fmtLine(type, msg){
  const cls = type === "ok" ? "ok" : (type === "warn" ? "warn" : (type === "bad" ? "bad" : ""));
  return `<span class="${cls}">${String(msg).replace(/</g,"&lt;")}</span>`;
}
function log(type, msg){
  const ts = new Date().toISOString().slice(11,19);
  logEl.innerHTML += fmtLine(type, `[${ts}] ${msg}`) + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function storeBase(){
  const v = $("storeBase").value.trim().replace(/\/$/, "");
  localStorage.setItem("sc_store_base", v);
  return v;
}
function writeKey(){
  const v = $("writeKey").value.trim();
  if (v) localStorage.setItem("sc_write_key", v);
  return v || localStorage.getItem("sc_write_key") || "";
}

function sundayOf(d){
  const x = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  const dow = x.getUTCDay(); // Sun=0
  x.setUTCDate(x.getUTCDate()-dow);
  return x;
}
function toISODate(d){ return d.toISOString().slice(0,10); }
function weekStartVal(){
  const v = $("weekStart").value;
  return v ? v : toISODate(sundayOf(new Date()));
}
function setWeekPill(){ weekPill.textContent = "week: " + weekStartVal(); }

async function apiGet(path){
  const r = await fetch(storeBase()+path, { cache:"no-store" });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `GET ${path} ${r.status}`);
  return j;
}
async function scGet(kind, params={}){
  const u = new URL(storeBase() + "/sc/get");
  u.searchParams.set("kind", kind);
  for (const [k,v] of Object.entries(params||{})) {
    if (v === undefined || v === null || v === "") continue;
    u.searchParams.set(k, String(v));
  }
  const r = await fetch(u.toString(), { cache:"no-store" });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `GET kind=${kind} ${r.status}`);
  return (j && j.value !== undefined) ? j.value : null;
}
async function scPut(body){
  const k = writeKey();
  if (!k) throw new Error("Missing write key (x-adr-write-key)");
  const r = await fetch(storeBase() + "/sc/put", {
    method:"POST",
    headers: {
      "content-type":"application/json",
      "x-adr-write-key": k
    },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `PUT ${body.kind} ${r.status}`);
  return j;
}

/* ---------------- Tabs ---------------- */
function setTab(name){
  for (const el of document.querySelectorAll(".tab")) {
    el.classList.toggle("active", el.dataset.tab === name);
  }
  $("tab_ops").style.display = (name==="ops") ? "" : "none";
  $("tab_data").style.display = (name==="data") ? "" : "none";
  $("tab_log").style.display = (name==="log") ? "" : "none";
}
document.addEventListener("click",(e)=>{
  const t = e.target.closest(".tab");
  if (!t) return;
  setTab(t.dataset.tab);
});

/* ---------------- Ops Plan ----------------
Stored:
  kind=ops_plan, week=YYYY-MM-DD, version=planned
*/
function defaultSeatTemplates(){
  return [
    { id:"attendant", label:"Attendant", requires_any:"ALS" },
    { id:"driver", label:"Driver", requires_any:"DRIVER" },
    { id:"rider3", label:"3rd Rider", requires_any:"" },
  ];
}
function splitCsv(v){
  return String(v||"").split(",").map(s=>s.trim()).filter(Boolean);
}
function defaultOpsPlan(){
  const units = splitCsv($("unitIds").value||"120,121,131,QRV1");
  const templates = defaultSeatTemplates();
  const per = {};
  for (const u of units){
    per[u] = { AM: ["attendant","driver"], PM: ["attendant","driver"] };
  }
  return {
    schema:"sc.ops_plan.v1",
    week_start: weekStartVal(),
    unit_ids: units,
    seat_templates: templates,
    per_unit_shift: per
  };
}

let opsPlan = null;

function renderSeatTemplates(){
  const host = $("seatTemplates");
  host.innerHTML = "";
  const list = opsPlan.seat_templates || [];
  for (const t of list){
    const row = document.createElement("div");
    row.className = "seatRow";
    row.innerHTML = `
      <input class="mono" data-k="id" value="${t.id||""}" placeholder="id" />
      <input data-k="label" value="${t.label||""}" placeholder="Label" />
      <input class="mono" data-k="requires_any" value="${t.requires_any||""}" placeholder="requires_any (comma list)" />
      <button class="secondary" style="padding:8px 10px">Delete</button>
    `;
    const delBtn = row.querySelector("button");
    delBtn.addEventListener("click", ()=>{
      const i = opsPlan.seat_templates.indexOf(t);
      if (i>=0){ opsPlan.seat_templates.splice(i,1); renderSeatTemplates(); renderOpsMatrix(); }
    });
    for (const inp of row.querySelectorAll("input")){
      inp.addEventListener("input", ()=>{
        t[inp.dataset.k] = inp.value;
        renderOpsMatrix();
      });
    }
    host.appendChild(row);
  }
}

function renderOpsMatrix(){
  const host = $("opsMatrix");
  host.innerHTML = "";
  const units = opsPlan.unit_ids || [];
  const tpl = opsPlan.seat_templates || [];
  const tplIds = tpl.map(x=>x.id).filter(Boolean);

  if (!units.length){
    host.innerHTML = `<div class="badge warnBadge">No unit IDs configured.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `<thead><tr><th>Unit</th><th>AM seats</th><th>PM seats</th></tr></thead>`;
  const tbody = document.createElement("tbody");

  for (const u of units){
    const row = document.createElement("tr");
    const am = (opsPlan.per_unit_shift?.[u]?.AM) || [];
    const pm = (opsPlan.per_unit_shift?.[u]?.PM) || [];
    const mkSel = (cur, onChange) => {
      const wrap = document.createElement("div");
      wrap.style.display="flex";
      wrap.style.gap="8px";
      wrap.style.flexWrap="wrap";
      for (const id of tplIds){
        const b = document.createElement("label");
        b.className="badge";
        const checked = cur.includes(id);
        b.innerHTML = `<input type="checkbox" ${checked?"checked":""} data-id="${id}" style="margin-right:6px"/> ${id}`;
        b.querySelector("input").addEventListener("change",(e)=>{
          const seatId = e.target.dataset.id;
          const has = cur.includes(seatId);
          if (e.target.checked && !has) cur.push(seatId);
          if (!e.target.checked && has) cur.splice(cur.indexOf(seatId),1);
          onChange();
        });
        wrap.appendChild(b);
      }
      return wrap;
    };
    row.appendChild(Object.assign(document.createElement("td"),{textContent:u}));
    const amTd = document.createElement("td");
    const pmTd = document.createElement("td");
    amTd.appendChild(mkSel(am, ()=>{ opsPlan.per_unit_shift[u].AM = am; }));
    pmTd.appendChild(mkSel(pm, ()=>{ opsPlan.per_unit_shift[u].PM = pm; }));
    row.appendChild(amTd);
    row.appendChild(pmTd);
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  host.appendChild(table);
}

async function loadOpsPlan(){
  const week = weekStartVal();
  try{
    const v = await scGet("ops_plan", { week, version:"planned" });
    if (v && v.schema === "sc.ops_plan.v1") {
      opsPlan = v;
      $("opsStatus").textContent = "Loaded ops_plan from store (planned).";
      log("ok","Loaded ops_plan planned from store.");
    } else {
      opsPlan = defaultOpsPlan();
      $("opsStatus").textContent = "No ops_plan found; created defaults (not saved yet).";
      log("warn","No ops_plan in store; using defaults.");
    }
  }catch(e){
    opsPlan = defaultOpsPlan();
    $("opsStatus").textContent = "Failed to load ops_plan; using defaults: " + e.message;
    log("warn","ops_plan load failed; using defaults: " + e.message);
  }
  opsPlan.unit_ids = opsPlan.unit_ids || splitCsv($("unitIds").value);
  opsPlan.seat_templates = opsPlan.seat_templates || defaultSeatTemplates();
  opsPlan.per_unit_shift = opsPlan.per_unit_shift || {};
  for (const u of (opsPlan.unit_ids||[])){
    opsPlan.per_unit_shift[u] = opsPlan.per_unit_shift[u] || { AM:["attendant","driver"], PM:["attendant","driver"] };
  }
  renderSeatTemplates();
  renderOpsMatrix();
}

async function saveOpsPlan(){
  if (!opsPlan) throw new Error("Ops plan not loaded.");
  opsPlan.week_start = weekStartVal();
  opsPlan.unit_ids = splitCsv($("unitIds").value);
  opsPlan.per_unit_shift = opsPlan.per_unit_shift || {};
  for (const u of opsPlan.unit_ids){
    if (!opsPlan.per_unit_shift[u]) opsPlan.per_unit_shift[u] = { AM:["attendant","driver"], PM:["attendant","driver"] };
  }
  await scPut({
    kind:"ops_plan",
    week: weekStartVal(),
    version:"planned",
    value: opsPlan
  });
  $("opsStatus").textContent = "Saved ops_plan planned for week " + weekStartVal();
  log("ok","Saved ops_plan planned.");
}

/* ---------------- Data loading / normalization ---------------- */
function normQual(q){
  const s = String(q||"").trim();
  if (!s) return "";
  const up = s.toUpperCase();
  // your directive: no separate Paramedic/AEMT categories; treat as ALS if they exist in legacy data
  if (up === "AEMT" || up === "PARAMEDIC" || up === "EMT-P") return "ALS";
  return up; // comparisons in upper
}
function memberId(m){ return String(m.member_id ?? m.id ?? "").trim(); }
function memberName(m){
  const fn = (m.first_name||"").trim();
  const ln = (m.last_name||"").trim();
  const nm = (m.name||"").trim();
  return (fn||ln) ? (fn + (ln?(" "+ln):"")) : (nm || memberId(m) || "UNKNOWN");
}

// HTML-safe name for schedule rendering + ADR change badge
function memberLabelHtml(member_id){
  const mid = String(member_id||"").trim();
  const meta = membersMetaById.get(mid);
  const name = (meta?.name || membersById.get(mid) || mid || "OPEN");
  const safeName = String(name).replace(/</g,"&lt;");
  const chg = meta?.adr_changed_on;
  if (chg && Array.isArray(DATA?.members) && (meta?.adr_no !== null && meta?.adr_no !== undefined)) {
    // Only show badge if there is actual history (length > 1). We infer this via adr_changed_on existing AND adr_no_history length > 1.
    return `${safeName} <span class="badge warnBadge" title="ADR # changed on ${chg}">ADR#chg ${chg}</span>`;
  }
  return safeName;
}

let DATA = {
  org_settings: null,
  members: [],
  availability: null,
  units: [],
  seats: [],
};
let membersById = new Map();
let membersMetaById = new Map(); // member_id -> {name, adr_no, adr_changed_on}
let adrNoDuplicates = new Map(); // adr_no -> [member_id,...]


async function refreshFromDrive(){
  log("info","Refreshing Drive→KV for members, units, seats, org_settings (forced)...");
  const kinds = ["members","units","seats","org_settings"];
  for (const k of kinds){
    try{
      await apiGet(`/sc/refresh?kind=${encodeURIComponent(k)}`);
      log("ok", `refresh ${k}: ok`);
    }catch(e){
      log("warn", `refresh ${k}: ${e.message}`);
    }
  }
  log("ok","Refresh complete.");
}

async function loadData(){
  log("info","Loading data from store…");
  const [org, members, availability, units, seats] = await Promise.all([
    scGet("org_settings").catch(()=>null),
    scGet("members").catch(()=>[]),
    scGet("availability").catch(()=>null),
    scGet("units").catch(()=>[]),
    scGet("seats").catch(()=>[]),
  ]);

  DATA.org_settings = org;
  DATA.members = Array.isArray(members) ? members : (members?.members || []);
  DATA.availability = availability;
  DATA.units = Array.isArray(units) ? units : (units?.units || []);
  DATA.seats = Array.isArray(seats) ? seats : (seats?.seats || []);

  membersById = new Map(DATA.members.map(m => [memberId(m), memberName(m)]));

// Build meta map + ADR duplicate guard
membersMetaById = new Map();
adrNoDuplicates = new Map();
for (const m of DATA.members){
  const mid = memberId(m);
  const meta = { name: memberName(m), adr_no: (m.adr_no ?? null), adr_changed_on: null };
  const hist = Array.isArray(m.adr_no_history) ? m.adr_no_history : [];
  if (hist.length > 1){
    // Determine current ADR entry (effective_to null wins; else latest effective_from)
    let cur = hist.find(h => h && (h.effective_to === null || h.effective_to === undefined));
    if (!cur){
      cur = hist.slice().sort((a,b)=>String(a?.effective_from||"").localeCompare(String(b?.effective_from||""))).pop();
    }
    if (cur && cur.effective_from) meta.adr_changed_on = String(cur.effective_from).slice(0,10);
  }
  membersMetaById.set(mid, meta);

  // Duplicate guard: only for active members with an adr_no
  if (m && m.active !== false && meta.adr_no){
    const key = String(meta.adr_no).trim();
    if (!adrNoDuplicates.has(key)) adrNoDuplicates.set(key, []);
    adrNoDuplicates.get(key).push(mid);
  }
}
// Reduce to only duplicates
for (const [k,v] of Array.from(adrNoDuplicates.entries())){
  if (!v || v.length < 2) adrNoDuplicates.delete(k);
}
if (adrNoDuplicates.size){
  const details = Array.from(adrNoDuplicates.entries()).map(([adr, ids])=>{
    const names = ids.map(id => membersMetaById.get(id)?.name || id).join(", ");
    return `${adr}: ${names}`;
  }).join(" | ");
  log("warn", `ADR duplicate numbers detected (${adrNoDuplicates.size}). ${details}`);
}

  const availCount = Array.isArray(DATA.availability) ? DATA.availability.length : (DATA.availability ? Object.keys(DATA.availability).length : 0);
  const dupCount = adrNoDuplicates ? adrNoDuplicates.size : 0;
  const dupPill = dupCount
    ? `<span class="pill" style="border-color:rgba(247,201,72,.55);background:rgba(247,201,72,.10);color:#ffe8a6">ADR dup#: ${dupCount}</span>`
    : `<span class="pill">ADR dup#: 0</span>`;
  $("kpiRow").innerHTML = `
    <span class="pill">members: ${DATA.members.length}</span>
    <span class="pill">units: ${DATA.units.length}</span>
    <span class="pill">seats: ${DATA.seats.length}</span>
    <span class="pill">availability: ${availCount}</span>
    ${dupPill}
  `;
  setPill(dataPill, `data: m${DATA.members.length} u${DATA.units.length} s${DATA.seats.length}`, true);
  log("ok", `Loaded members=${DATA.members.length}, units=${DATA.units.length}, seats=${DATA.seats.length}, availability=${availCount}`);
}

function getAvail(member_id, dateIso, shift){ // shift "AM"/"PM"
  const a = DATA.availability;
  if (!a) return {state:"unknown"};
  const mid = String(member_id);
  if (!Array.isArray(a)){
    const per = a[mid] || a[String(Number(mid))] || null;
    if (per && per.days && per.days[dateIso]){
      const st = per.days[dateIso][shift] || per.days[dateIso][shift.toLowerCase()] || "";
      return {state: String(st||"").toLowerCase() || "clear"};
    }
    if (per && per[dateIso]){
      const st = per[dateIso][shift] || per[dateIso][shift.toLowerCase()] || "";
      return {state: String(st||"").toLowerCase() || "clear"};
    }
  }
  return {state:"unknown"};
}

function isEligibleForSeat(m, seatTpl){
  const reqs = splitCsv(seatTpl.requires_any||"");
  if (!reqs.length) return true;
  const quals = (m.qualifications || []).map(normQual);
  for (const r of reqs){
    if (r.startsWith("__")) continue; // placeholder
    if (quals.includes(String(r).toUpperCase())) return true;
  }
  return false;
}

function bestPlaceholderForSeat(seatTpl){
  const reqs = splitCsv(seatTpl.requires_any||"");
  for (const r of reqs){
    if (r.startsWith("__")) return r;
  }
  const placeholders = (DATA.org_settings && Array.isArray(DATA.org_settings.placeholders)) ? DATA.org_settings.placeholders : [];
  const id = (seatTpl.id||"").toLowerCase();
  if (id.includes("att") || id.includes("als")){
    const x = placeholders.find(p=>p.id==="__SAL_ALS_BACKFILL__") || placeholders.find(p=>p.id==="__DUTY_CREW__");
    if (x) return x.id;
  }
  if (id.includes("driv")){
    const x = placeholders.find(p=>p.id==="__SAL_BLS_BACKFILL__") || placeholders.find(p=>p.id==="__DUTY_CREW__");
    if (x) return x.id;
  }
  return placeholders[0]?.id || "OPEN";
}

/* ---------------- Visual resolver ---------------- */
function isoAddDays(iso, days){
  const d = new Date(iso+"T00:00:00Z");
  d.setUTCDate(d.getUTCDate()+days);
  return d.toISOString().slice(0,10);
}
function makeEmptyWeekSchedule(week){
  const out = {};
  for (let i=0;i<7;i++){
    const dateIso = isoAddDays(week, i);
    out[dateIso] = { AM: {}, PM: {} };
  }
  return out;
}

function buildScheduleFromOpsPlan({week, ops, members}){
  const schedule = makeEmptyWeekSchedule(week);
  const used = new Set(); // date|shift|member
  const weekCount = new Map(); // member->count

  const seatTplById = new Map((ops.seat_templates||[]).map(t=>[t.id, t]));

  function bump(id){ weekCount.set(id, (weekCount.get(id)||0)+1); }

  function score(m, dateIso, shift){
    const av = getAvail(memberId(m), dateIso, shift).state;
    if (av === "avoid" || av === "no") return -999;
    let s = 0;
    if (av === "pref" || av === "preferred") s += 2;
    if (av === "clear" || av === "ok" || av === "yes") s += 1;
    if (av === "unknown") s += 0.5;
    s += Math.max(0, 2 - (weekCount.get(memberId(m))||0)) * 0.25; // gentle fairness
    return s;
  }

  for (let di=0; di<7; di++){
    const dateIso = isoAddDays(week, di);
    for (const shift of ["AM","PM"]){
      for (const unitId of (ops.unit_ids||[])){
        const seatIds = (ops.per_unit_shift?.[unitId]?.[shift]) || [];
        schedule[dateIso][shift][unitId] = {};
        for (const sid of seatIds){
          const tpl = seatTplById.get(sid);
          if (!tpl){ schedule[dateIso][shift][unitId][sid] = "OPEN"; continue; }

          const candidates = members
            .filter(m => m && m.active !== false)
            .filter(m => isEligibleForSeat(m, tpl))
            .sort((a,b)=>{
              const sa = score(a,dateIso,shift);
              const sb = score(b,dateIso,shift);
              if (sb !== sa) return sb - sa;
              return String(memberId(a)).localeCompare(String(memberId(b)));
            });

          let picked = null;
          for (const m of candidates){
            const mid = memberId(m);
            if (!mid) continue;
            const k = `${dateIso}|${shift}|${mid}`;
            if (used.has(k)) continue;
            const sc = score(m,dateIso,shift);
            if (sc < -100) continue;
            picked = mid;
            used.add(k);
            bump(mid);
            break;
          }
          schedule[dateIso][shift][unitId][sid] = picked || bestPlaceholderForSeat(tpl);
        }
      }
    }
  }
  return schedule;
}

function renderSchedule(schedule){
  const tbody = $("schedTable").querySelector("tbody");
  tbody.innerHTML = "";
  const week = weekStartVal();
  for (let i=0;i<7;i++){
    const dateIso = isoAddDays(week, i);
    const am = schedule?.[dateIso]?.AM || {};
    const pm = schedule?.[dateIso]?.PM || {};

    const fmtShift = (shiftObj)=>{
      const lines = [];
      for (const [unitId, seats] of Object.entries(shiftObj)){
        const parts = [];
        for (const [seatId, val] of Object.entries(seats)){
          const v = String(val||"OPEN");
          const nameHtml = membersMetaById.size ? memberLabelHtml(v) : (membersById.get(v) || String(v||"OPEN").replace(/</g,"&lt;"));
          parts.push(`${seatId}: ${nameHtml}`);
        }
        lines.push(`<div><span class="badge">${unitId}</span> ${parts.join(" • ")}</div>`);
      }
      return lines.join("");
    };

    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${dateIso}</td><td>${fmtShift(am)}</td><td>${fmtShift(pm)}</td>`;
    tbody.appendChild(tr);
  }
}

/* ---------------- Actions ---------------- */
let lastResult = null;

async function ping(){
  try {
    const j = await apiGet("/health");
    setPill(storePill, "store: ok", true);
    log("ok", `Store health: ${JSON.stringify(j)}`);
  } catch(e) {
    setPill(storePill, "store: error", false);
    log("bad", "Store ping failed: " + e.message);
  }
}

async function resolveWeek(){
  setWeekPill();
  if (!opsPlan) await loadOpsPlan();
  if (!DATA.members.length) await loadData();

  const week = weekStartVal();
  log("info", `Resolve start week=${week} units=${(opsPlan.unit_ids||[]).length}`);

  const sched = buildScheduleFromOpsPlan({
    week,
    ops: opsPlan,
    members: DATA.members
  });

  lastResult = {
    schedule: sched,
    meta: {
      schema:"sc.schedule.v2",
      generated_at: new Date().toISOString(),
      week_start: week,
      ops_plan: {
        schema: opsPlan.schema,
        unit_ids: opsPlan.unit_ids,
        seat_templates: (opsPlan.seat_templates||[]).map(t=>({id:t.id,label:t.label,requires_any:t.requires_any}))
      }
    },
    logs: []
  };
  $("schedMeta").textContent = `computed: ${new Date().toISOString()} • week=${week}`;
  renderSchedule(sched);
  log("ok", "Resolve complete.");
}

async function savePlanned(){
  if (!lastResult?.schedule) throw new Error("No computed schedule to save. Click Resolve Week first.");
  const week = weekStartVal();
  log("info", "Saving planned schedule…");
  await scPut({
    kind:"schedule",
    week,
    version:"planned",
    value: lastResult
  });
  log("ok", "Saved planned schedule for " + week);
}

async function publishPlanned(){
  const week = weekStartVal();
  log("info","Publishing planned → published…");
  const planned = await scGet("schedule", {week, version:"planned"});
  if (!planned) throw new Error("No planned schedule found for this week.");
  await scPut({
    kind:"schedule",
    week,
    version:"published",
    value: planned
  });
  log("ok","Published week " + week);
}

/* ---------------- Inspector ---------------- */
async function inspect(){
  const k = $("inspectKind").value;
  try{
    if (k === "schedule"){
      const v = await scGet("schedule", {week: weekStartVal(), version:"planned"});
      $("inspectOut").value = JSON.stringify(v, null, 2);
      return;
    }
    if (k === "ops_plan"){
      const v = await scGet("ops_plan", {week: weekStartVal(), version:"planned"});
      $("inspectOut").value = JSON.stringify(v, null, 2);
      return;
    }
    const v = await scGet(k);
    $("inspectOut").value = JSON.stringify(v, null, 2);
  }catch(e){
    $("inspectOut").value = "ERROR: " + e.message;
  }
}

/* ---------------- Init ---------------- */
function init(){
  function updateNet(){ setPill(netPill, navigator.onLine ? "online" : "offline", navigator.onLine); }
  window.addEventListener("online", updateNet);
  window.addEventListener("offline", updateNet);
  updateNet();

  $("storeBase").value = localStorage.getItem("sc_store_base") || $("storeBase").value || STORE_DEFAULT;
  $("writeKey").value = localStorage.getItem("sc_write_key") || localStorage.getItem("sc_token") || "";
  $("weekStart").value = toISODate(sundayOf(new Date()));
  setWeekPill();

  $("btnPing").addEventListener("click", ()=>ping());
  $("btnRefresh").addEventListener("click", ()=>refreshFromDrive().catch(e=>log("bad", e.message)));
  $("btnLoad").addEventListener("click", ()=>loadData().catch(e=>log("bad", e.message)));
  $("btnResolve").addEventListener("click", ()=>resolveWeek().catch(e=>log("bad", e.message)));
  $("btnSave").addEventListener("click", ()=>savePlanned().catch(e=>log("bad", e.message)));
  $("btnPublish").addEventListener("click", ()=>publishPlanned().catch(e=>log("bad", e.message)));
  $("btnInspect").addEventListener("click", ()=>inspect());

  $("btnAddSeat").addEventListener("click", ()=>{
    opsPlan.seat_templates.push({id:"seat_"+Math.random().toString(16).slice(2,6), label:"New Seat", requires_any:""});
    renderSeatTemplates(); renderOpsMatrix();
  });
  $("btnSaveOps").addEventListener("click", ()=>saveOpsPlan().catch(e=>log("bad", e.message)));
  $("btnLoadOps").addEventListener("click", ()=>loadOpsPlan().catch(e=>log("bad", e.message)));

  ping();
  loadOpsPlan();
  loadData().catch(()=>{});
}
init();
</script>
</body>
</html>
