<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShiftCommander — Supervisor</title>
<style>
  :root {
    --bg:#0b1220;
    --panel:#0f1a33;
    --panel2:#111f3d;
    --text:#e9eefc;
    --muted:#aab7e6;
    --line:rgba(255,255,255,.12);
    --good:#48d597;
    --warn:#f7c948;
    --bad:#ff6b6b;
    --btn:#2a5bd7;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070b14,var(--bg));color:var(--text);}
  header{position:sticky;top:0;background:rgba(7,11,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20;}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 18px;}
  .title{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
  h1{font-size:18px;margin:0;letter-spacing:.2px}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;}
  @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
  .card{border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),rgba(15,26,51,.65));border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.35);}
  .card h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600;}
  .card .inner{padding:14px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 10px;font-size:14px;outline:none;}
  input:focus,textarea:focus,select:focus{border-color:rgba(42,91,215,.7);box-shadow:0 0 0 3px rgba(42,91,215,.2)}
  .field{min-width:220px;flex:1;}
  .field.small{min-width:160px;flex:0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;color:white;background:var(--btn);cursor:pointer}
  button.secondary{background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text)}
  button.danger{background:#b7252a}
  button:disabled{opacity:.55;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
  .log{height:420px;overflow:auto;background:rgba(0,0,0,.25);border:1px solid var(--line);border-radius:12px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;line-height:1.35;white-space:pre;}
  .log .ok{color:var(--good)}
  .log .warn{color:var(--warn)}
  .log .bad{color:var(--bad)}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 10px;text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:700;background:rgba(255,255,255,.04)}
  .tiny{font-size:12px;color:var(--muted)}
  .right{text-align:right}
  .statusline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  a{color:#9dc1ff;text-decoration:none}
  a:hover{text-decoration:underline}
</style>
</head>
<body>
<header>
  <div class="wrap title">
    <h1>ShiftCommander — Supervisor</h1>
    <div class="statusline">
      <span class="pill" id="netPill">offline</span>
      <span class="pill" id="storePill">store: —</span>
      <span class="pill" id="weekPill">week: —</span>
    </div>
  </div>
</header>

<div class="wrap grid">
  <section class="card">
    <div class="inner">
      <h2>Resolver</h2>
      <div class="row">
        <div class="field">
          <label>Store Base</label>
          <input id="storeBase" value="https://store.adr-fr.org" />
          <div class="hint">Reads use <code>/sc/get</code>. Writes use <code>/sc/put</code> and require <code>x-adr-write-key</code>.</div>
        </div>
        <div class="field">
          <label>Write Key</label>
          <input id="writeKey" placeholder="(optional for reads; required to save)" />
          <div class="hint">Stored in <code>localStorage.sc_write_key</code>.</div>
        </div>
        <div class="field small">
          <label>Week (Sunday)</label>
          <input id="weekStart" type="date" />
        </div>
        <div class="field small">
          <label>Watchdog (ms)</label>
          <input id="watchdog" type="number" value="120000" />
        </div>
      </div>

      <div class="actions">
        <button id="btnPing" class="secondary">Ping Store</button>
        <button id="btnLoad" class="secondary">Load Inputs</button>
        <button id="btnResolve">Resolve Week</button>
        <button id="btnSave" class="secondary">Save Planned</button>
        <button id="btnPublish" class="secondary">Publish (copy planned → published)</button>
        <a class="pill" href="./wallboard.html" target="_blank">Open Wallboard</a>
      </div>

      <div class="hint">
        Inputs expected in store (kinds): <code>org_settings</code>, <code>members</code>, <code>availability</code>, <code>units</code>, <code>seat_types</code>.
        If <code>units</code>/<code>seat_types</code> are missing, the resolver can't meaningfully fill seats.
      </div>

      <div style="margin-top:12px">
        <div class="tiny">Live log (what it’s doing)</div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="inner">
      <h2>Preview Schedule (planned)</h2>
      <div class="tiny" id="schedMeta">No run yet.</div>
      <div style="margin-top:10px;overflow:auto;max-height:520px;border:1px solid var(--line);border-radius:12px">
        <table id="schedTable">
          <thead>
            <tr><th>Date</th><th>AM</th><th>PM</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:10px">
        Notes: schedule keys are <code>YYYY-MM-DD</code> for the selected week (Sunday → Saturday). Each shift is
        <code>{attendant, operator, third}</code>. Values are member IDs (your wallboard can map IDs → names).
      </div>
    </div>
  </section>
</div>

<script type="module">
import { buildPlannedSchedule, isoDateUTC, addDaysUTC } from "./js/sc_resolver_v2.js";

const $ = (id) => document.getElementById(id);
const logEl = $("log");
const netPill = $("netPill");
const storePill = $("storePill");
const weekPill = $("weekPill");

function setPill(el, text, ok=true){
  el.textContent = text;
  el.style.borderColor = ok ? "rgba(72,213,151,.5)" : "rgba(255,107,107,.5)";
  el.style.background = ok ? "rgba(72,213,151,.10)" : "rgba(255,107,107,.10)";
  el.style.color = ok ? "#b7f7dd" : "#ffd0d0";
}

function fmtLine(type, msg){
  const cls = type === "ok" ? "ok" : (type === "warn" ? "warn" : (type === "bad" ? "bad" : ""));
  return `<span class="${cls}">${msg.replace(/</g,"&lt;")}</span>`;
}

function log(type, msg){
  const ts = new Date().toISOString().slice(11,19);
  logEl.innerHTML += fmtLine(type, `[${ts}] ${msg}`) + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function storeBase(){
  const v = $("storeBase").value.trim().replace(/\/$/, "");
  localStorage.setItem("sc_store_base", v);
  return v;
}
function writeKey(){
  const v = $("writeKey").value.trim();
  if (v) localStorage.setItem("sc_write_key", v);
  return v || localStorage.getItem("sc_write_key") || "";
}

function q(kind, params = {}){
  const u = new URL(storeBase() + "/sc/get");
  u.searchParams.set("kind", kind);
  for (const [k,v] of Object.entries(params||{})) {
    if (v === undefined || v === null || v === "") continue;
    u.searchParams.set(k, String(v));
  }
  return u.toString();
}

async function scGet(kind, params){
  const r = await fetch(q(kind, params), { cache:"no-store" });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `GET ${kind} ${r.status}`);
  return j && j.value !== undefined ? j.value : null;
}

async function scPut(body){
  const k = writeKey();
  if (!k) throw new Error("Missing write key (x-adr-write-key)");
  const r = await fetch(storeBase() + "/sc/put", {
    method:"POST",
    headers: {
      "content-type":"application/json",
      "x-adr-write-key": k
    },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error((j && j.error) ? j.error : `PUT ${body.kind} ${r.status}`);
  return j;
}

function sundayOf(d){
  const x = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  const dow = x.getUTCDay(); // Sun=0
  x.setUTCDate(x.getUTCDate()-dow);
  return x;
}
function toISODate(d){
  return d.toISOString().slice(0,10);
}

function weekStartVal(){
  const v = $("weekStart").value;
  return v ? v : toISODate(sundayOf(new Date()));
}

function setWeekPill(){
  weekPill.textContent = "week: " + weekStartVal();
}

function renderSchedule(schedule, membersById){
  const tbody = $("schedTable").querySelector("tbody");
  tbody.innerHTML = "";
  const start = new Date(weekStartVal() + "T00:00:00Z");
  for (let i=0;i<7;i++) {
    const dateIso = isoDateUTC(addDaysUTC(start,i));
    const am = schedule?.[dateIso]?.AM || {attendant:"OPEN",operator:"OPEN",third:"OPEN"};
    const pm = schedule?.[dateIso]?.PM || {attendant:"OPEN",operator:"OPEN",third:"OPEN"};
    const fmt = (x) => {
      const id = String(x||"OPEN");
      const name = membersById.get(id) || id;
      return name;
    };
    const amTxt = [fmt(am.attendant), fmt(am.operator), fmt(am.third)].join(" / ");
    const pmTxt = [fmt(pm.attendant), fmt(pm.operator), fmt(pm.third)].join(" / ");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${dateIso}</td><td>${amTxt}</td><td>${pmTxt}</td>`;
    tbody.appendChild(tr);
  }
}

let lastInputs = null;
let lastResult = null;
let lastMembersById = new Map();

async function ping(){
  try {
    const r = await fetch(storeBase()+"/health", {cache:"no-store"});
    const j = await r.json().catch(()=>null);
    setPill(storePill, "store: ok", true);
    log("ok", `Store health: ${JSON.stringify(j)}`);
  } catch(e) {
    setPill(storePill, "store: error", false);
    log("bad", "Store ping failed: " + e.message);
  }
}

async function loadInputs(){
  log("info","Loading inputs from store…");
  const [org, members, availability, units, seatTypes] = await Promise.all([
    scGet("org_settings"),
    scGet("members"),
    scGet("availability"),
    scGet("units"),
    scGet("seat_types"),
  ]);
  lastInputs = {
    org_settings: org,
    members: Array.isArray(members)?members:[],
    availability: Array.isArray(availability)?availability:[],
    units: Array.isArray(units)?units:[],
    seatTypes: Array.isArray(seatTypes)?seatTypes:[]
  };
  lastMembersById = new Map(lastInputs.members.map(m=>[String(m.member_id??m.id??""), String(m.name||m.member_id||m.id||"")]));
  log("ok", `Loaded: members=${lastInputs.members.length}, availability=${lastInputs.availability.length}, units=${lastInputs.units.length}, seat_types=${lastInputs.seatTypes.length}`);
  if (!lastInputs.units.length || !lastInputs.seatTypes.length) {
    log("warn","Missing units and/or seat_types in store. Resolver can still run, but it can’t fill meaningful seats yet.");
  }
  return lastInputs;
}

async function resolveWeek(){
  setWeekPill();
  const inputs = lastInputs || await loadInputs();

  const watchdogMs = Number($("watchdog").value)||120000;
  log("info", `Resolver start for week=${weekStartVal()} watchdog=${watchdogMs}ms`);
  const result = buildPlannedSchedule({
    weekStartISO: weekStartVal(),
    units: inputs.units,
    seatTypes: inputs.seatTypes,
    members: inputs.members,
    availability: inputs.availability,
    seatKeyMode: "basic",
    watchdogMs
  });
  lastResult = result;

  // Stream the compute log in a readable way
  for (const entry of (result.logs||[])) {
    const t = entry.type === "ok" ? "ok" : (entry.type === "warn" ? "warn" : (entry.type === "bad" ? "bad" : "info"));
    log(t, entry.msg);
  }

  log(result.partial ? "warn" : "ok", `Resolver complete (partial=${result.partial})`);
  $("schedMeta").textContent = `computed: ${new Date().toISOString()} • partial=${result.partial} • reason=${result.reason||"—"}`;
  renderSchedule(result.schedule, lastMembersById);
}

async function savePlanned(){
  if (!lastResult?.schedule) throw new Error("No computed schedule to save. Click Resolve Week first.");
  const week = weekStartVal();
  log("info", "Saving planned schedule to store…");
  await scPut({
    kind:"schedule",
    week,
    version:"planned",
    value: {
      schedule: lastResult.schedule,
      meta: {
        schema:"sc.schedule.v1",
        generated_at: new Date().toISOString(),
        week_start: week,
        partial: !!lastResult.partial,
        reason: lastResult.reason || null
      },
      logs: lastResult.logs || []
    }
  });
  log("ok", "Saved: kind=schedule version=planned week=" + week);
}

async function publishPlanned(){
  const week = weekStartVal();
  log("info","Publishing: copy planned → published…");
  const planned = await scGet("schedule", {week, version:"planned"});
  if (!planned) throw new Error("No planned schedule found in store for this week.");
  await scPut({
    kind:"schedule",
    week,
    version:"published",
    value: planned
  });
  log("ok","Published week " + week);
}

function init(){
  // online/offline pill
  function updateNet(){
    const ok = navigator.onLine;
    setPill(netPill, ok ? "online" : "offline", ok);
  }
  window.addEventListener("online", updateNet);
  window.addEventListener("offline", updateNet);
  updateNet();

  $("storeBase").value = localStorage.getItem("sc_store_base") || $("storeBase").value;
  $("writeKey").value = localStorage.getItem("sc_write_key") || localStorage.getItem("sc_token") || "";
  $("weekStart").value = toISODate(sundayOf(new Date()));
  setWeekPill();

  $("btnPing").addEventListener("click", ()=>ping());
  $("btnLoad").addEventListener("click", ()=>loadInputs().catch(e=>log("bad", e.message)));
  $("btnResolve").addEventListener("click", ()=>resolveWeek().catch(e=>log("bad", e.message)));
  $("btnSave").addEventListener("click", ()=>savePlanned().catch(e=>log("bad", e.message)));
  $("btnPublish").addEventListener("click", ()=>publishPlanned().catch(e=>log("bad", e.message)));

  ping();
}
init();
</script>
</body>
</html>
