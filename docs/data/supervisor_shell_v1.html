<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander — Supervisor</title>
<style>

/* =========================
   THEME TOKENS (edit here)
   ========================= */
:root{
  --bg: #0b1220;
  --panel: rgba(255,255,255,.06);
  --panel2: rgba(255,255,255,.10);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.62);
  --border: rgba(255,255,255,.14);
  --accent: #5aa7ff;
  --good: #22c55e;
  --warn: #f59e0b;
  --bad: #ef4444;

  --radius: 16px;
  --radius2: 12px;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --sidebarW: 248px;
}

/* =========================
   APP SHELL LAYOUT
   ========================= */
.appShell{display:flex; min-height:100vh; background: var(--bg); color: var(--text);}
.sidebar{
  width: var(--sidebarW);
  padding: 14px 12px;
  border-right: 1px solid var(--border);
  background: rgba(7,18,37,.86);
  position: sticky;
  top: 0;
  height: 100vh;
}
.appMain{flex:1; min-width:0;}
.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(7,18,37,.92);
  backdrop-filter: blur(10px);
}
.brand{
  font-weight: 800;
  letter-spacing: .3px;
  text-decoration:none;
  color: var(--text);
  padding: 6px 10px;
  border-radius: 10px;
  background: rgba(255,255,255,.06);
}
.crumb{margin-left:10px; color: var(--muted); font-size: 13px;}
.modechip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.06);
  font-size: 12px;
  font-weight: 700;
}
.modechip[data-mode="view"]{color: var(--muted);}
.modechip[data-mode="edit"]{color: var(--accent);}
.modechip[data-mode="dirty"]{color: var(--warn);}
.modechip[data-mode="saved"]{color: var(--good);}

.side-section{margin-bottom: 14px;}
.side-title{
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  margin: 8px 10px;
}
.navbtn{
  width:100%;
  text-align:left;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text);
  cursor:pointer;
  font-weight: 700;
}
.navbtn:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08);}
.navbtn[aria-current="page"]{background: rgba(90,167,255,.18); border-color: rgba(90,167,255,.35);}
.navbtn:disabled{opacity:.45; cursor:not-allowed;}
.navlink{
  display:block;
  padding: 10px 10px;
  border-radius: 12px;
  text-decoration:none;
  color: var(--text);
  font-weight:700;
}
.navlink:hover{background: rgba(255,255,255,.06);}
.pill{
  display:inline-block;
  margin-left:8px;
  padding: 1px 7px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  font-size: 11px;
  color: var(--muted);
}
.side-footer{position:absolute; bottom: 12px; left: 12px; right: 12px;}
/* Ensure the existing page content has breathing room under the topbar */
main{padding-top: 10px;}
/* Hide the old in-page tab row (sidebar replaces it) */
#tabPopularity, #tabStaffing{display:none !important;}


  :root{
    --bg:#071225; --panel:#0b1730; --line:rgba(233,241,255,.14);
    --text:#eaf2ff; --muted:rgba(233,241,255,.72);
    --green:#26d07c; --red:#ff5d5d; --amber:#ffa836; --blue:#5c8dff;
  }
  body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 700px at 25% 10%, rgba(92,141,255,.12), transparent 55%), var(--bg); color:var(--text); }
  header{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; position:sticky; top:0; background:rgba(7,18,37,.92); backdrop-filter: blur(10px); z-index:5;}
  h1{ font-size:16px; margin:0; letter-spacing:.2px; }
  .pill{ margin-left:auto; display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); background:rgba(233,241,255,.05); border-radius:999px; font-size:12px; }
  .dot{ width:10px; height:10px; border-radius:99px; background:var(--green); box-shadow:0 0 0 4px rgba(38,208,124,.12); }
  .dot.warn{ background:var(--amber); box-shadow:0 0 0 4px rgba(255,168,54,.14); }
  main{ padding:16px; max-width:1100px; margin:0 auto; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  select, button{ background:rgba(233,241,255,.06); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:13px; }
  button{ cursor:pointer; }
  button:hover{ border-color:rgba(233,241,255,.24); }
  .card{ margin-top:14px; border:1px solid var(--line); border-radius:16px; background:rgba(11,23,48,.72); overflow:hidden; }
  .cardHead{ padding:12px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; }
  .muted{ color:var(--muted); font-size:12px; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ padding:10px 12px; border-bottom:1px solid rgba(233,241,255,.08); font-size:13px; }
  th{ text-align:left; font-size:12px; color:var(--muted); letter-spacing:.2px; text-transform:uppercase; }
  .heat{ display:inline-flex; align-items:center; gap:8px; }
  .bar{ width:12px; height:12px; border-radius:4px; border:2px solid rgba(233,241,255,.18); }
  .bar.need2{ border-color: rgba(38,208,124,.95); }
  .bar.need1{ border-color: rgba(38,208,124,.55); }
  .bar.neutral{ border-color: rgba(233,241,255,.18); }
  .bar.crowd1{ border-color: rgba(255,168,54,.55); }
  .bar.crowd2{ border-color: rgba(255,93,93,.92); }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .kpi .box{ padding:10px 12px; border:1px solid rgba(233,241,255,.10); border-radius:14px; background:rgba(233,241,255,.04); font-size:12px; }
  .kpi b{ font-size:14px; }

  .tabs{ display:flex; gap:8px; padding:12px 16px; align-items:center; border-bottom:1px solid var(--line); position:sticky; top:54px; background:rgba(7,18,37,.72); backdrop-filter: blur(10px); z-index:4;}
  .tab{ padding:8px 12<main>
  <div class="tabs">
    <button class="tab active" id="tabPopularity">Popularity</button>
    <button class="tab" id="tabStaffing">Staffing (1 Unit)</button>
    <span class="tabsSpacer"></span>
    <span class="muted" id="saveState"></span>
  </div>

  <!-- Popularity (existing) -->
  <section id="panelPopularity">
    <div class="row">
      <button id="btnRefresh">Refresh</button>
      <span class="muted">Eligibility filter (for popularity math):</span>
      <select id="qualFilter">
        <option value="ALL">All active</option>
        <option value="ALS">ALS only</option>
        <option value="EMT">EMT only</option>
        <option value="DRIVER">DRIVER only</option>
        <option value="EMT_DRIVER">EMT + DRIVER</option>
        <option value="ALS_DRIVER">ALS + DRIVER</option>
      </select>
      <span class="muted">Weeks shown:</span>
      <select id="weeks">
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="10">10</option>
        <option value="12">12</option>
      </select>
      <span class="muted">Start:</span>
      <input id="start" type="date"/>
    </div>

    <div class="card">
      <div class="cardHead">
        <b>Shift popularity (Preferred-only, Model A)</b>
        <span class="muted" id="subtitle"></span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:170px">Date</th>
              <th style="width:80px">Half</th>
              <th style="width:140px">Stage</th>
              <th>Popularity</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Staffing (new) -->
  <section id="panelStaffing" style="display:none">
    <div class="row" style="flex-wrap:wrap">
      <div class="pill" style="margin-left:0">
        <span class="muted">Date</span>
        <input id="staffDate" type="date"/>
      </div>
      <div class="pill">
        <span class="muted">Unit</span>
        <select id="unitPick"></select>
      </div>
      <button id="btnLoadStaff">Load</button>
      <button class="secondary" id="btnClearStaff">Clear</button>
      <span class="muted" id="staffHint">Saved locally by default. Publish tries the Store URL if it supports POST.</span>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="cardHead">
          <b>Available members</b>
          <span class="muted" id="poolCount"></span>
        </div>
        <div class="list" id="memberPool"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <b id="unitTitle">Unit</b>
          <span id="readyBadge" class="badge warn">NOT READY</span>
        </div>

        <div class="seatList" id="seatList"></div>

        <div class="row" style="margin-top:12px; justify-content:flex-end">
          <button class="secondary" id="btnSaveStaff">Save</button>
          <button id="btnPublishStaff">Publish</button>
        </div>
        <div class="muted" id="validateMsg" style="margin-top:10px"></div>
      </div>
    </div>
  </section>
</main>ine); background:rgba(233,241,255,.04); }
  .badge.ok{ border-color:rgba(38,208,124,.45); background:rgba(38,208,124,.12); }
  .badge.warn{ border-color:rgba(255,168,54,.45); background:rgba(255,168,54,.12); }
  .seatList{ display:flex; flex-direction:column; gap:10px; padding:10px; }
  .seatRow{ display:flex; gap:10px; align-items:center; border:1px solid var(--line); background:rgba(233,241,255,.03); border-radius:12px; padding:10px; }
  .seatRow .seatName{ width:140px; font-weight:700; }
  .seatRow select{ flex:1; }
  button.secondary{ background:rgba(233,241,255,.04); color:var(--text); border:1px solid var(--line); }


  /* Week resolve (press-and-hold) */
  .weekButtons{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .weekBtn{ padding:8px 10px; border-radius:12px; font-size:12px; user-select:none; }
  .weekBtn.resolving{ border-color: rgba(38,208,124,.55); background: rgba(38,208,124,.12); }
  tr.weekHi{ outline:1px solid rgba(38,208,124,.35); background: rgba(38,208,124,.06); }

</style>
</head>
<body>
<div class="appShell">
  <aside class="sidebar">
    <div class="side-section">
      <div class="side-title">Supervisor</div>
      <button class="navbtn" data-nav="dashboard" id="navDashboard">Dashboard</button>
      <button class="navbtn" data-nav="staffing" id="navStaffing">Staffing</button>
      <button class="navbtn" data-nav="inbox" id="navInbox">Inbox <span class="pill" id="inboxCount" style="display:none">0</span></button>
    </div>

    <div class="side-section">
      <div class="side-title">Configuration</div>
      <button class="navbtn" data-nav="members" id="navMembers" disabled title="Coming next">Members</button>
      <button class="navbtn" data-nav="units" id="navUnits" disabled title="Coming next">Units</button>
      <button class="navbtn" data-nav="settings" id="navSettings" disabled title="Coming next">Settings</button>
    </div>

    <div class="side-section">
      <div class="side-title">Tools</div>
      <a class="navlink" href="#/wallboard" id="navWallboard">Wallboard</a>
      <a class="navlink" href="#/member" id="navMemberPortal">Member Portal</a>
    </div>

    <div class="side-footer">
      <div class="muted" style="font-size:12px">v1 shell • View vs Edit mode</div>
    </div>
  </aside>

  <div class="appMain">

<header class="topbar">
  <div class="topbar-left">
    <a class="brand" href="#/dashboard" title="Back to Dashboard">ShiftCommander</a>
    <span class="crumb" id="crumb">Supervisor ▸ Dashboard</span>
  </div>
  <div class="topbar-right">
    <span class="modechip" id="modeChip" data-mode="view">Viewing</span>
  </div>
</header>

<main>
  <div class="row">
    <button id="btnRefresh">Refresh</button>
    <span class="muted">Eligibility filter (for popularity math):</span>
    <select id="qualFilter">
      <option value="ALL">All active</option>
      <option value="ALS">ALS only</option>
      <option value="EMT">EMT only</option>
      <option value="DRIVER">DRIVER only</option>
      <option value="EMT_DRIVER">EMT + DRIVER</option>
      <option value="ALS_DRIVER">ALS + DRIVER</option>
    </select>
    <span class="muted">Weeks shown:</span>
    <select id="weeks">
      <option value="6">6</option>
      <option value="8">8</option>
      <option value="12">12</option>
    </select>
  </div>

  <div class="kpi" id="kpi"></div>

  <div class="weekButtons" id="weekButtons" title="Press-and-hold to temporarily mark a week as resolved (visual only)"></div>

  <div class="card">
    <div class="cardHead">
      <b>Shift popularity (Preferred-only, Model A)</b>
      <span class="muted" id="subtitle"></span>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:170px">Date</th>
            <th style="width:80px">Half</th>
            <th style="width:140px">Stage</th>
            <th>Popularity</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
const MEMBERS_URL = "/data/members.json";
const STORE_URL = "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec";

const $ = (id)=>document.getElementById(id);

// --- Supervisor tabs ---
function showPanel(which){
  const pop=$("panelPopularity");
  const staff=$("panelStaffing");
  const tPop=$("tabPopularity");
  const tStaff=$("tabStaffing");
  if(which==="staff"){
    pop.style.display="none";
    staff.style.display="block";
    tPop.classList.remove("active");
    tStaff.classList.add("active");
  }else{
    pop.style.display="block";
    staff.style.display="none";
    tStaff.classList.remove("active");
    tPop.classList.add("active");
  }
}

// --- One-unit staffing (Release 1) ---
const DEFAULT_SEATS = {
  version: 1,
  seats: [
    { seat_id: "ALS", label: "ALS Medic", requires_any: ["ALS"] },
    { seat_id: "EMT", label: "EMT", requires_any: ["EMT","ALS"] },
    { seat_id: "DRIVER", label: "Driver (optional)", requires_any: ["DRIVER"] }
  ]
};
const DEFAULT_UNITS = {
  version: 1,
  units: [
    { unit_id: "AMB120", label: "Ambulance 120", status:"ACTIVE", min_required:["ALS","EMT"], optional:["DRIVER"] }
  ]
};

function memberLabel(m){
  return (m.first_name||"") + " " + (m.last_name||"");
}
function hasQual(m, q){
  const qs = m.qualifications || m.quals || [];
  return qs.includes(q);
}
function seatEligible(m, seat){
  const req = seat.requires_any || [];
  if(req.length===0) return true;
  for(const q of req){ if(hasQual(m,q)) return true; }
  return false;
}

// local-only persistence key
function lsKey(dateISO, unitId){ return `sc_assign_${dateISO}_${unitId}`; }

async function safeGet(kind){
  try{ return await storeGet(kind); }catch(_e){ return null; }
}
async function storeSet(kind, payload){
  const url=new URL(STORE_URL);
  url.searchParams.set("kind", kind);
  const r=await fetch(url.toString(), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error("store POST " + r.status);
  try{ return await r.json(); }catch(_e){ return {ok:true}; }
}

let seats = DEFAULT_SEATS;
let units = DEFAULT_UNITS;
let currentAssignments = {}; // seat_id -> member_id

function setSaveState(text){ $("saveState").textContent = text || ""; }

function getActiveMembers(){
  return (members||[]).filter(m=>m && m.active!==false);
}

function renderMemberPool(){
  const pool = $("memberPool");
  pool.innerHTML = "";
  const active = getActiveMembers();
  $("poolCount").textContent = `${active.length} active`;
  for(const m of active){
    const div=document.createElement("div");
    div.className="person";
    const name=document.createElement("b");
    name.textContent = memberLabel(m);
    const sub=document.createElement("div");
    sub.className="muted";
    sub.style.fontSize="12px";
    sub.textContent = m.rank ? m.rank : "";
    const left=document.createElement("div");
    left.style.display="flex";
    left.style.flexDirection="column";
    left.appendChild(name);
    left.appendChild(sub);

    const chips=document.createElement("div");
    chips.className="chips";
    for(const q of ["ALS","EMT","DRIVER"]){
      const c=document.createElement("span");
      c.className="chip " + (hasQual(m,q) ? "good":"");
      c.textContent=q;
      chips.appendChild(c);
    }
    div.appendChild(left);
    div.appendChild(chips);
    pool.appendChild(div);
  }
}

function renderSeatList(unit){
  $("unitTitle").textContent = `${unit.label} — Seat Assignments`;
  const list=$("seatList");
  list.innerHTML="";
  const seatIds=[...unit.min_required, ...unit.optional];
  for(const sid of seatIds){
    const seat = (seats.seats||[]).find(s=>s.seat_id===sid) || {seat_id:sid,label:sid,requires_any:[]};
    const row=document.createElement("div");
    row.className="seatRow";

    const name=document.createElement("div");
    name.className="seatName";
    name.textContent = seat.label || sid;

    const sel=document.createElement("select");
    sel.dataset.seat_id = sid;

    const opt0=document.createElement("option");
    opt0.value="";
    opt0.textContent = sid==="DRIVER" ? "— Optional —" : "— Select —";
    sel.appendChild(opt0);

    const active = getActiveMembers().slice().sort((a,b)=>memberLabel(a).localeCompare(memberLabel(b)));
    for(const m of active){
      const ok = seatEligible(m, seat);
      // For optional DRIVER, only show driver-qualified by default
      if(sid==="DRIVER" && !ok) continue;

      const o=document.createElement("option");
      o.value = m.member_id;
      o.textContent = memberLabel(m) + (m.rank ? ` (${m.rank})` : "");
      sel.appendChild(o);
    }

    sel.value = currentAssignments[sid] || "";
    sel.addEventListener("change", ()=>{
      currentAssignments[sid] = sel.value || "";
      validateUnit(unit);
      setSaveState("Unsaved changes");
    });

    const btn=document.createElement("button");
    btn.className="secondary";
    btn.textContent="Clear";
    btn.addEventListener("click", ()=>{
      sel.value="";
      currentAssignments[sid]="";
      validateUnit(unit);
      setSaveState("Unsaved changes");
    });

    row.appendChild(name);
    row.appendChild(sel);
    row.appendChild(btn);
    list.appendChild(row);
  }
}

function validateUnit(unit){
  const missing=[];
  // Required seats must be filled with eligible people
  for(const sid of unit.min_required){
    const seat = (seats.seats||[]).find(s=>s.seat_id===sid) || {seat_id:sid,requires_any:[]};
    const mid=currentAssignments[sid];
    if(!mid){ missing.push(`${sid} unassigned`); continue; }
    const m=getActiveMembers().find(x=>String(x.member_id)===String(mid));
    if(!m){ missing.push(`${sid} member not found`); continue; }
    if(!seatEligible(m, seat)){ missing.push(`${sid} not qualified`); }
  }

  const ready = missing.length===0;
  const badge=$("readyBadge");
  badge.textContent = ready ? "READY" : "NOT READY";
  badge.classList.toggle("ok", ready);
  badge.classList.toggle("warn", !ready);
  $("validateMsg").textContent = ready ? "Minimum crew satisfied. You can publish." : ("Missing: " + missing.join(" • "));
  return ready;
}

function loadAssignmentsLocal(dateISO, unitId){
  const raw=localStorage.getItem(lsKey(dateISO, unitId));
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(_e){ return null; }
}

function saveAssignmentsLocal(dateISO, unitId, payload){
  localStorage.setItem(lsKey(dateISO, unitId), JSON.stringify(payload));
}

async function loadStaffing(){
  const dateISO = $("staffDate").value || todayISO();
  const unitId = $("unitPick").value;

  const unit = (units.units||[]).find(u=>u.unit_id===unitId) || (units.units||[])[0];
  if(!unit) return;

  // Try store first, fallback to local
  let payload = null;
  const remote = await safeGet("assignments");
  if(remote && remote.items){
    // expected shape: {date, items:[{date,unit_id,seat_id,member_id}]}
    const found = (remote.items||[]).filter(it=>it && it.date===dateISO && it.unit_id===unitId);
    if(found.length){
      payload = { date: dateISO, unit_id: unitId, items: found };
    }
  }
  if(!payload){
    payload = loadAssignmentsLocal(dateISO, unitId);
  }
  currentAssignments = {};
  if(payload && Array.isArray(payload.items)){
    for(const it of payload.items){
      if(it && it.seat_id) currentAssignments[it.seat_id] = String(it.member_id||"");
    }
  }

  renderMemberPool();
  renderSeatList(unit);
  validateUnit(unit);
  setSaveState("Loaded");
}

function currentPayload(dateISO, unitId){
  const items=[];
  for(const [seat_id, member_id] of Object.entries(currentAssignments)){
    if(!member_id) continue;
    items.push({ date: dateISO, unit_id: unitId, seat_id, member_id });
  }
  return { version:1, date:dateISO, unit_id:unitId, items };
}

async function saveStaffing({publish=false}={}){
  const dateISO = $("staffDate").value || todayISO();
  const unitId = $("unitPick").value;
  const payload = currentPayload(dateISO, unitId);

  // always save local
  saveAssignmentsLocal(dateISO, unitId, payload);

  if(publish){
    try{
      await storeSet("assignments", payload);
      setSaveState("Published (store)");
    }catch(e){
      console.warn(e);
      setSaveState("Saved locally (store POST failed)");
      alert("Saved locally. Store publish failed (likely read-only endpoint).");
    }
  }else{
    setSaveState("Saved locally");
  }
}

function clearStaffing(){
  const dateISO = $("staffDate").value || todayISO();
  const unitId = $("unitPick").value;
  currentAssignments = {};
  renderSeatList((units.units||[]).find(u=>u.unit_id===unitId) || (units.units||[])[0]);
  validateUnit((units.units||[]).find(u=>u.unit_id===unitId) || (units.units||[])[0]);
  localStorage.removeItem(lsKey(dateISO, unitId));
  setSaveState("Cleared");
}

function todayISO(){ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),t.getDate()).toISOString().slice(0,10); }
function addDaysISO(iso,days){ const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function weekStartISO(iso){ const d=new Date(iso+"T00:00:00"); const dow=(d.getDay()+6)%7; d.setDate(d.getDate()-dow); return d.toISOString().slice(0,10); }
function daysBetweenISO(a,b){ return Math.round((new Date(b+"T00:00:00")-new Date(a+"T00:00:00"))/86400000); }
function weekTag(startISO){
  const t=todayISO();
  const managedStart=weekStartISO(t);
  const end=addDaysISO(startISO,6);
  if(end<t) return "Past";
  const w=Math.floor(daysBetweenISO(managedStart,startISO)/7);
  const MANAGED_WEEKS=3, PUBLISHED_WEEKS=3;
  if(w>=0 && w<MANAGED_WEEKS) return "Managed";
  if(w>=MANAGED_WEEKS && w<(MANAGED_WEEKS+PUBLISHED_WEEKS)) return "Published";
  return "Planning";
}
async function storeGet(kind){
  const url=new URL(STORE_URL);
  url.searchParams.set("kind", kind);
  const r=await fetch(url.toString(), {method:"GET", cache:"no-store"});
  if(!r.ok) throw new Error("store GET " + r.status);
  return await r.json();
}

let members=[];
function eligibleMembers(){
  const f=$("qualFilter").value;
  const act=members.filter(m=>m && m.active!==false);
  if(f==="ALL") return act;
  const has=(m,q)=> (m.qualifications||[]).includes(q);
  if(f==="ALS") return act.filter(m=>has(m,"ALS"));
  if(f==="EMT") return act.filter(m=>has(m,"EMT"));
  if(f==="DRIVER") return act.filter(m=>has(m,"DRIVER"));
  if(f==="EMT_DRIVER") return act.filter(m=>has(m,"EMT") && has(m,"DRIVER"));
  if(f==="ALS_DRIVER") return act.filter(m=>has(m,"ALS") && has(m,"DRIVER"));
  return act;
}
function classifyHeat(ratio,E,R){
  if(E<4){
    if(R<=0) return "need2";
    if(R==1) return "need1";
    if(R==2) return "neutral";
    return "crowd2";
  }
  if(ratio<0.10) return "need2";
  if(ratio<0.25) return "need1";
  if(ratio<0.50) return "neutral";
  if(ratio<0.75) return "crowd1";
  return "crowd2";
}
function fmtMD(iso){
  const d=new Date(iso+"T00:00:00");
  return d.toLocaleDateString(undefined,{month:"short",day:"numeric"});
}

async function refresh(){
  try{
    $("statusText").textContent="Loading…";
    $("dot").classList.remove("warn");
    $("statusPill").title="";

    const memR=await fetch(MEMBERS_URL,{cache:"no-store"});
    const memJ=await memR.json();
    members=memJ.members || memJ || [];
    const elig=eligibleMembers();
    const E=elig.length;

    const all=await storeGet("member");
    const payloads=[];
    if(Array.isArray(all)){ for(const it of all){ if(it&&it.payload) payloads.push(it.payload);} }
    else if(all && Array.isArray(all.items)){ for(const it of all.items){ if(it&&it.payload) payloads.push(it.payload);} }
    else if(all && typeof all==="object"){ for(const k of Object.keys(all)){ const it=all[k]; if(it&&it.payload) payloads.push(it.payload);} }

    // count preferred per date|half
    const counts={};
    for(const st of payloads){
      if(!st||typeof st!=="object") continue;
      for(const dateISO of Object.keys(st)){
        const day=st[dateISO];
        if(!day||typeof day!=="object") continue;
        for(const half of Object.keys(day)){
          if(day[half]==="preferred"){
            const k=`${dateISO}|${half}`;
            counts[k]=(counts[k]||0)+1;
          }
        }
      }
    }

    // Build rows for upcoming weeks
    const weeks=parseInt($("weeks").value,10);
    const start=weekStartISO(todayISO());
    const shifts=[];
    for(let w=0; w<weeks; w++){
      const ws=addDaysISO(start,w*7);
      for(let i=0;i<7;i++){
        const date=addDaysISO(ws,i);
        if(new Date(date+"T00:00:00") < new Date(todayISO()+"T00:00:00") && weekTag(ws)!=="Managed") continue;
        shifts.push({date, half:"AM"});
        shifts.push({date, half:"PM"});
      }
    }
    // Week "resolve" buttons (press-and-hold, visual only)
    const weekStarts = Array.from(new Set(shifts.map(x=>weekStartISO(x.date))))
      .sort((a,b)=>a.localeCompare(b));
    const wb = $("weekButtons");
    if(wb){
      wb.innerHTML = "";
      const setWeekHighlight = (ws, on)=>{
        for(const row of document.querySelectorAll('#rows tr')){
          if((row.dataset.week||"")===ws){
            row.classList.toggle('weekHi', !!on);
          }
        }
      };
      for(const ws of weekStarts){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'weekBtn';
        const tag = weekTag(ws);
        btn.textContent = `Week of ${fmtMD(ws)}${tag?` • ${tag}`:''}`;

        const startResolve = ()=>{
          btn.classList.add('resolving');
          setWeekHighlight(ws,true);
        };
        const endResolve = ()=>{
          btn.classList.remove('resolving');
          setWeekHighlight(ws,false);
        };

        btn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startResolve(); });
        btn.addEventListener('pointerup', endResolve);
        btn.addEventListener('pointercancel', endResolve);
        btn.addEventListener('pointerleave', endResolve);
        wb.appendChild(btn);
      }
    }


const tbody=$("rows"); tbody.innerHTML="";
    let need=0, crowd=0;
    for(const sh of shifts){
      const k=`${sh.date}|${sh.half}`;
      const R=counts[k]||0;
      const ratio=E? (R/E):0;
      const level=classifyHeat(ratio,E,R);
      if(level.startsWith("need")) need++;
      if(level.startsWith("crowd")) crowd++;

      const tr=document.createElement("tr");
      const ws = weekStartISO(sh.date);
      tr.dataset.week = ws;
      tr.innerHTML = `
        <td>${fmtMD(sh.date)} <span class="muted">(${sh.date})</span></td>
        <td>${sh.half}</td>
        <td>${weekTag(weekStartISO(sh.date))}</td>
        <td>
          <span class="heat" title="Preferred-only popularity among eligible members">
            <span class="bar ${level}"></span>
            <span>${R}/${E} prefer (${E?Math.round(ratio*100):0}%)</span>
          </span>
        </td>
      `;
      tbody.appendChild(tr);
    }

    $("subtitle").textContent = `• Eligible: ${E} • Filter: ${$("qualFilter").value}`;
    $("kpi").innerHTML = `
      <div class="box"><b>${E}</b><div class="muted">Eligible members</div></div>
      <div class="box"><b>${need}</b><div class="muted">Need (green)</div></div>
      <div class="box"><b>${crowd}</b><div class="muted">Crowded (red)</div></div>
      <div class="box"><b>${shifts.length}</b><div class="muted">Shifts shown</div></div>
    `;

    $("statusText").textContent="Connected";
    $("statusPill").title="Loaded from Drive store.";
  }catch(e){
    console.error(e);
    $("statusText").textContent="Offline / no Drive";
    $("dot").classList.add("warn");
    $("statusPill").title=String(e?.message||e);
  }
}


// Tabs
$("tabPopularity").addEventListener("click", ()=>showPanel("pop"));
$("tabStaffing").addEventListener("click", ()=>showPanel("staff"));

// Staffing controls
(function initStaffing(){
  // Default date
  $("staffDate").value = todayISO();

  // Load members for staffing uses the same members[] already loaded in refresh(); but we also want to load members even if you open Staffing first.
  // We'll populate units/seats from store if available; fallback to defaults.
  (async ()=>{
    const memR=await fetch(MEMBERS_URL,{cache:"no-store"});
    const memJ=await memR.json();
    members=memJ.members || memJ || [];

    const s = await safeGet("seats");
    if(s && s.seats) seats = s;

    const u = await safeGet("units");
    if(u && u.units) units = u;

    const pick=$("unitPick");
    pick.innerHTML="";
    for(const unit of (units.units||[])){
      const o=document.createElement("option");
      o.value=unit.unit_id;
      o.textContent=unit.label;
      pick.appendChild(o);
    }
    if((units.units||[]).length) pick.value=(units.units||[])[0].unit_id;

    $("btnLoadStaff").addEventListener("click", loadStaffing);
    $("unitPick").addEventListener("change", loadStaffing);
    $("staffDate").addEventListener("change", loadStaffing);
    $("btnSaveStaff").addEventListener("click", ()=>saveStaffing({publish:false}));
    $("btnPublishStaff").addEventListener("click", ()=>saveStaffing({publish:true}));
    $("btnClearStaff").addEventListener("click", clearStaffing);

    // Initial render
    await loadStaffing();
  })().catch(e=>{
    console.error(e);
    setSaveState("Staffing init failed");
  });
})();

$("btnRefresh").addEventListener("click", refresh);
$("qualFilter").addEventListener("change", refresh);
$("weeks").addEventListener("change", refresh);
refresh();
</script>
  </div>
</div>

<script>
/* =========================
   Shell routing + mode state
   ========================= */
(function(){
  const nav = {
    dashboard: document.getElementById('navDashboard'),
    staffing: document.getElementById('navStaffing'),
    inbox: document.getElementById('navInbox'),
    members: document.getElementById('navMembers'),
    units: document.getElementById('navUnits'),
    settings: document.getElementById('navSettings'),
  };
  const crumb = document.getElementById('crumb');
  const modeChip = document.getElementById('modeChip');

  // Existing panels from your page
  const panelPopularity = document.getElementById('panelPopularity');
  const panelStaffing = document.getElementById('panelStaffing');

  // Lightweight edit-state flags (we’ll wire “real” dirty tracking into staffing editors next)
  let editMode = false;
  let dirty = false;

  function setMode(mode){
    modeChip.dataset.mode = mode;
    modeChip.textContent =
      mode === 'view' ? 'Viewing' :
      mode === 'edit' ? 'Editing' :
      mode === 'dirty' ? 'Unsaved' :
      mode === 'saved' ? 'Saved' : mode;
  }

  // Expose helpers for later modules
  window.SC_SHELL = {
    enterEdit(){ editMode = true; dirty = false; setMode('edit'); },
    markDirty(){ if(editMode){ dirty = true; setMode('dirty'); } },
    markSaved(){ if(editMode){ dirty = false; setMode('saved'); setTimeout(()=>setMode('edit'), 800); } },
    exitEdit(){ editMode = false; dirty = false; setMode('view'); }
  };

  function show(route){
    // Default: hide everything "view-like"
    if(panelPopularity) panelPopularity.style.display = 'none';
    if(panelStaffing) panelStaffing.style.display = 'none';

    // Nav highlighting
    Object.entries(nav).forEach(([k, el])=>{
      if(!el) return;
      if(k===route) el.setAttribute('aria-current','page');
      else el.removeAttribute('aria-current');
    });

    // Breadcrumb + panel mapping
    if(route === 'dashboard'){
      crumb.textContent = 'Supervisor ▸ Dashboard';
      if(panelPopularity) panelPopularity.style.display = '';
    } else if(route === 'staffing'){
      crumb.textContent = 'Supervisor ▸ Staffing ▸ AMB120';
      if(panelStaffing) panelStaffing.style.display = '';
    } else if(route === 'inbox'){
      crumb.textContent = 'Supervisor ▸ Inbox';
      alert('Inbox is the next module. For now, use Dashboard + Staffing.');
      location.hash = '#/dashboard';
      return;
    } else {
      crumb.textContent = 'Supervisor';
      alert('This section is coming next.');
      location.hash = '#/dashboard';
      return;
    }
  }

  function routeFromHash(){
    const h = (location.hash || '#/dashboard').replace('#/','');
    return h || 'dashboard';
  }

  // Click handlers
  Object.entries(nav).forEach(([k, el])=>{
    if(!el) return;
    el.addEventListener('click', ()=>{
      // Prevent accidental nav while dirty (simple guard)
      if(editMode && dirty){
        const ok = confirm('You have unsaved changes. Leave this page and lose them?');
        if(!ok) return;
        window.SC_SHELL.exitEdit();
      }
      location.hash = '#/' + k;
    });
  });

  window.addEventListener('hashchange', ()=>show(routeFromHash()));

  // Initial
  setMode('view');
  show(routeFromHash());
})();
</script>

</body>
</html>
