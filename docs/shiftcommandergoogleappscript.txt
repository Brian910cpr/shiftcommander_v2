/**
 * ShiftCommander JSON Store (Drive Folder)
 *
 * Script Properties REQUIRED:
 *   SC_FOLDER_ID = Drive folder ID (e.g., 11Q0lLHt...)
 *   SC_TOKEN     = shared secret token (any long string)
 *
 * GET:
 *   ?kind=ping&token=XYZ
 *   ?kind=<thing>&token=XYZ
 *   ?kind=<thing>&member_id=123&token=XYZ
 *
 * POST (JSON):
 *   { token:"XYZ", kind:"member_availability", member_id:"123", payload:{...} }
 *   { token:"XYZ", kind:"supervisor_patch", payload:{...} }
 *
 * Files written:
 *   - if member_id present:  <kind>_<member_id>.json
 *   - else:                  <kind>.json
 *
 * Notes:
 * - CORS is handled by Cloudflare Worker, not here.
 * - Uses Advanced Service: Drive API (v2) => Drive.Files.*
 */

function testDrive() {
  Logger.log(typeof Drive);
}

function doGet(e) {
  try {
    const p = (e && e.parameter) ? e.parameter : {};
    enforceToken_(String(p.token || ""));

    const kind = normKind_(p.kind);
    if (!kind) return jsonOut_({ ok: false, error: "Missing kind" }, 400);

    if (kind === "ping") {
      return jsonOut_({ ok: true, kind: "ping", ts: new Date().toISOString() }, 200);
    }

    const memberId = String(p.member_id || "").trim();
    const filename = buildFilename_(kind, memberId);

    const payload = readJsonFile_(filename);
    return jsonOut_({ ok: true, kind, member_id: memberId || null, payload: payload ?? null }, 200);

  } catch (err) {
    return jsonOut_({ ok: false, error: String(err && err.message ? err.message : err) }, 500);
  }
}

function doPost(e) {
  try {
    const raw = (e && e.postData && e.postData.contents) ? e.postData.contents : "{}";
    const body = JSON.parse(raw);

    enforceToken_(String(body.token || ""));

    const kind = normKind_(body.kind);
    if (!kind) return jsonOut_({ ok: false, error: "Missing kind" }, 400);

    if (kind === "ping") {
      return jsonOut_({ ok: true, kind: "ping", ts: new Date().toISOString() }, 200);
    }

    const memberId = String(body.member_id || "").trim();
    const filename = buildFilename_(kind, memberId);

    const payload = (body.payload === undefined) ? null : body.payload;
    writeJsonFile_(filename, payload);

    return jsonOut_({ ok: true, kind, member_id: memberId || null, saved: true }, 200);

  } catch (err) {
    return jsonOut_({ ok: false, error: String(err && err.message ? err.message : err) }, 500);
  }
}

/* ---------------- Security ---------------- */

function enforceToken_(token) {
  const expected = PropertiesService.getScriptProperties().getProperty("SC_TOKEN");
  if (!expected) throw new Error("Missing Script Property: SC_TOKEN");
  if (!token || token !== expected) throw new Error("Unauthorized (bad token)");
}

/* ---------------- Kind + filename ---------------- */

function normKind_(k) {
  return String(k || "")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9_]/g, ""); // keep it filename-safe
}

function buildFilename_(kind, memberId) {
  if (memberId) return `${kind}_${memberId}.json`;
  return `${kind}.json`;
}

/* ---------------- Drive (Shared Drive safe) ----------------
   Requires Advanced Google Service: Drive API (v2)
   This provides Drive.Files.list / get / insert / update
*/

function getFolderId_() {
  const folderId = PropertiesService.getScriptProperties().getProperty("SC_FOLDER_ID");
  if (!folderId) throw new Error("Missing Script Property: SC_FOLDER_ID");
  return folderId;
}

function findFileIdByName_(folderId, filename) {
  const safeName = filename.replace(/'/g, "\\'");
  const q = `'${folderId}' in parents and title = '${safeName}' and trashed = false`;

  // Drive API v2 advanced service:
  const resp = Drive.Files.list({
    q: q,
    maxResults: 1,
    fields: "items(id,title)",
    supportsAllDrives: true,
    includeItemsFromAllDrives: true
  });

  if (resp.items && resp.items.length) return resp.items[0].id;
  return null;
}

function readJsonFile_(filename) {
  const folderId = getFolderId_();
  const fileId = findFileIdByName_(folderId, filename);
  if (!fileId) return null;

  const token = ScriptApp.getOAuthToken();
  const url = `https://www.googleapis.com/drive/v2/files/${fileId}?alt=media`;

  const res = UrlFetchApp.fetch(url, {
    method: "get",
    headers: { Authorization: `Bearer ${token}` },
    muteHttpExceptions: true
  });

  const code = res.getResponseCode();
  if (code < 200 || code >= 300) {
    throw new Error(`Drive read failed (${code}) for ${filename}`);
  }

  const txt = res.getContentText("utf-8");
  if (!txt) return {};
  return JSON.parse(txt);
}

function writeJsonFile_(filename, obj) {
  const folderId = getFolderId_();
  const content = JSON.stringify(obj ?? {}, null, 2);

  const fileId = findFileIdByName_(folderId, filename);
  const token = ScriptApp.getOAuthToken();

  // Update existing
  if (fileId) {
    const url = `https://www.googleapis.com/upload/drive/v2/files/${fileId}?uploadType=media&supportsAllDrives=true`;
    const res = UrlFetchApp.fetch(url, {
      method: "put",
      contentType: "application/json",
      payload: content,
      headers: { Authorization: `Bearer ${token}` },
      muteHttpExceptions: true
    });

    const code = res.getResponseCode();
    if (code < 200 || code >= 300) {
      throw new Error(`Drive update failed (${code}) for ${filename}: ${res.getContentText()}`);
    }
    return;
  }

  // Create new (multipart)
  const boundary = "sc_boundary_" + Date.now();
  const delimiter = `\r\n--${boundary}\r\n`;
  const closeDelim = `\r\n--${boundary}--`;

  const metadata = {
    title: filename,
    mimeType: "application/json",
    parents: [{ id: folderId }]
  };

  const multipartBody =
    delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(metadata) +
    delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    content +
    closeDelim;

  const url = "https://www.googleapis.com/upload/drive/v2/files?uploadType=multipart&supportsAllDrives=true";
  const res = UrlFetchApp.fetch(url, {
    method: "post",
    contentType: `multipart/related; boundary=${boundary}`,
    payload: multipartBody,
    headers: { Authorization: `Bearer ${token}` },
    muteHttpExceptions: true
  });

  const code = res.getResponseCode();
  if (code < 200 || code >= 300) {
    throw new Error(`Drive create failed (${code}) for ${filename}: ${res.getContentText()}`);
  }
}

/* ---------------- Response ---------------- */

function jsonOut_(obj, status) {
  const payload = Object.assign({ _status: Number(status) }, obj || {});
  return ContentService
    .createTextOutput(JSON.stringify(payload))
    .setMimeType(ContentService.MimeType.JSON);
}
