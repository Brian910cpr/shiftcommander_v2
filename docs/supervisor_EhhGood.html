<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander — Supervisor</title>
<style>
  :root{
    --bg:#071225; --panel:#0b1730; --line:rgba(233,241,255,.14);
    --text:#eaf2ff; --muted:rgba(233,241,255,.72);
    --green:#26d07c; --red:#ff5d5d; --amber:#ffa836; --blue:#5c8dff;
  }
  body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 700px at 25% 10%, rgba(92,141,255,.12), transparent 55%), var(--bg); color:var(--text); }
  header{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; position:sticky; top:0; background:rgba(7,18,37,.92); backdrop-filter: blur(10px); z-index:5;}
  h1{ font-size:16px; margin:0; letter-spacing:.2px; }
  .pill{ margin-left:auto; display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); background:rgba(233,241,255,.05); border-radius:999px; font-size:12px; }
  .dot{ width:10px; height:10px; border-radius:99px; background:var(--green); box-shadow:0 0 0 4px rgba(38,208,124,.12); }
  .dot.warn{ background:var(--amber); box-shadow:0 0 0 4px rgba(255,168,54,.14); }
  main{ padding:16px; max-width:1100px; margin:0 auto; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  select, button{ background:rgba(233,241,255,.06); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:13px; }
  button{ cursor:pointer; }
  button:hover{ border-color:rgba(233,241,255,.24); }
  .card{ margin-top:14px; border:1px solid var(--line); border-radius:16px; background:rgba(11,23,48,.72); overflow:hidden; }
  .cardHead{ padding:12px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; }
  .muted{ color:var(--muted); font-size:12px; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ padding:10px 12px; border-bottom:1px solid rgba(233,241,255,.08); font-size:13px; }
  th{ text-align:left; font-size:12px; color:var(--muted); letter-spacing:.2px; text-transform:uppercase; }
  .heat{ display:inline-flex; align-items:center; gap:8px; }
  .bar{ width:12px; height:12px; border-radius:4px; border:2px solid rgba(233,241,255,.18); }
  .bar.need2{ border-color: rgba(38,208,124,.95); }
  .bar.need1{ border-color: rgba(38,208,124,.55); }
  .bar.neutral{ border-color: rgba(233,241,255,.18); }
  .bar.crowd1{ border-color: rgba(255,168,54,.55); }
  .bar.crowd2{ border-color: rgba(255,93,93,.92); }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .kpi .box{ padding:10px 12px; border:1px solid rgba(233,241,255,.10); border-radius:14px; background:rgba(233,241,255,.04); font-size:12px; }
  .kpi b{ font-size:14px; }
</style>
</head>
<body>
<header>
  <h1>Supervisor — Forecast / Popularity</h1>
  <div class="pill" id="statusPill" title="">
    <span class="dot" id="dot"></span>
    <span id="statusText">Connecting…</span>
  </div>
</header>

<main>
  <div class="row">
    <button id="btnRefresh">Refresh</button>
    <span class="muted">Eligibility filter (for popularity math):</span>
    <select id="qualFilter">
      <option value="ALL">All active</option>
      <option value="ALS">ALS only</option>
      <option value="EMT">EMT only</option>
      <option value="DRIVER">DRIVER only</option>
      <option value="EMT_DRIVER">EMT + DRIVER</option>
      <option value="ALS_DRIVER">ALS + DRIVER</option>
    </select>
    <span class="muted">Weeks shown:</span>
    <select id="weeks">
      <option value="6">6</option>
      <option value="8">8</option>
      <option value="12">12</option>
    </select>
  </div>

  <div class="kpi" id="kpi"></div>

  <div class="card">
    <div class="cardHead">
      <b>Shift popularity (Preferred-only, Model A)</b>
      <span class="muted" id="subtitle"></span>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:170px">Date</th>
            <th style="width:80px">Half</th>
            <th style="width:140px">Stage</th>
            <th>Popularity</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
const MEMBERS_URL = "/data/members.json";
const STORE_URL = "/api/store";

const $ = (id)=>document.getElementById(id);
function todayISO(){ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),t.getDate()).toISOString().slice(0,10); }
function addDaysISO(iso,days){ const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function weekStartISO(iso){ const d=new Date(iso+"T00:00:00"); const dow=(d.getDay()+6)%7; d.setDate(d.getDate()-dow); return d.toISOString().slice(0,10); }
function daysBetweenISO(a,b){ return Math.round((new Date(b+"T00:00:00")-new Date(a+"T00:00:00"))/86400000); }
function weekTag(startISO){
  const t=todayISO();
  const managedStart=weekStartISO(t);
  const end=addDaysISO(startISO,6);
  if(end<t) return "Past";
  const w=Math.floor(daysBetweenISO(managedStart,startISO)/7);
  const MANAGED_WEEKS=3, PUBLISHED_WEEKS=3;
  if(w>=0 && w<MANAGED_WEEKS) return "Managed";
  if(w>=MANAGED_WEEKS && w<(MANAGED_WEEKS+PUBLISHED_WEEKS)) return "Published";
  return "Planning";
}
async function storeGet(kind){
  const url=new URL(STORE_URL);
  url.searchParams.set("kind", kind);
  const r=await fetch(url.toString(), {method:"GET", cache:"no-store"});
  if(!r.ok) throw new Error("store GET " + r.status);
  return await r.json();
}

let members=[];
function eligibleMembers(){
  const f=$("qualFilter").value;
  const act=members.filter(m=>m && m.active!==false);
  if(f==="ALL") return act;
  const has=(m,q)=> (m.qualifications||[]).includes(q);
  if(f==="ALS") return act.filter(m=>has(m,"ALS"));
  if(f==="EMT") return act.filter(m=>has(m,"EMT"));
  if(f==="DRIVER") return act.filter(m=>has(m,"DRIVER"));
  if(f==="EMT_DRIVER") return act.filter(m=>has(m,"EMT") && has(m,"DRIVER"));
  if(f==="ALS_DRIVER") return act.filter(m=>has(m,"ALS") && has(m,"DRIVER"));
  return act;
}
function classifyHeat(ratio,E,R){
  if(E<4){
    if(R<=0) return "need2";
    if(R==1) return "need1";
    if(R==2) return "neutral";
    return "crowd2";
  }
  if(ratio<0.10) return "need2";
  if(ratio<0.25) return "need1";
  if(ratio<0.50) return "neutral";
  if(ratio<0.75) return "crowd1";
  return "crowd2";
}
function fmtMD(iso){
  const d=new Date(iso+"T00:00:00");
  return d.toLocaleDateString(undefined,{month:"short",day:"numeric"});
}

async function refresh(){
  try{
    $("statusText").textContent="Loading…";
    $("dot").classList.remove("warn");
    $("statusPill").title="";

    const memR=await fetch(MEMBERS_URL,{cache:"no-store"});
    const memJ=await memR.json();
    members=memJ.members || memJ || [];
    const elig=eligibleMembers();
    const E=elig.length;

    const all=await storeGet("member");
    const payloads=[];
    if(Array.isArray(all)){ for(const it of all){ if(it&&it.payload) payloads.push(it.payload);} }
    else if(all && Array.isArray(all.items)){ for(const it of all.items){ if(it&&it.payload) payloads.push(it.payload);} }
    else if(all && typeof all==="object"){ for(const k of Object.keys(all)){ const it=all[k]; if(it&&it.payload) payloads.push(it.payload);} }

    // count preferred per date|half
    const counts={};
    for(const st of payloads){
      if(!st||typeof st!=="object") continue;
      for(const dateISO of Object.keys(st)){
        const day=st[dateISO];
        if(!day||typeof day!=="object") continue;
        for(const half of Object.keys(day)){
          if(day[half]==="preferred"){
            const k=`${dateISO}|${half}`;
            counts[k]=(counts[k]||0)+1;
          }
        }
      }
    }

    // Build rows for upcoming weeks
    const weeks=parseInt($("weeks").value,10);
    const start=weekStartISO(todayISO());
    const shifts=[];
    for(let w=0; w<weeks; w++){
      const ws=addDaysISO(start,w*7);
      for(let i=0;i<7;i++){
        const date=addDaysISO(ws,i);
        if(new Date(date+"T00:00:00") < new Date(todayISO()+"T00:00:00") && weekTag(ws)!=="Managed") continue;
        shifts.push({date, half:"AM"});
        shifts.push({date, half:"PM"});
      }
    }

    const tbody=$("rows"); tbody.innerHTML="";
    let need=0, crowd=0;
    for(const sh of shifts){
      const k=`${sh.date}|${sh.half}`;
      const R=counts[k]||0;
      const ratio=E? (R/E):0;
      const level=classifyHeat(ratio,E,R);
      if(level.startsWith("need")) need++;
      if(level.startsWith("crowd")) crowd++;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtMD(sh.date)} <span class="muted">(${sh.date})</span></td>
        <td>${sh.half}</td>
        <td>${weekTag(weekStartISO(sh.date))}</td>
        <td>
          <span class="heat" title="Preferred-only popularity among eligible members">
            <span class="bar ${level}"></span>
            <span>${R}/${E} prefer (${E?Math.round(ratio*100):0}%)</span>
          </span>
        </td>
      `;
      tbody.appendChild(tr);
    }

    $("subtitle").textContent = `• Eligible: ${E} • Filter: ${$("qualFilter").value}`;
    $("kpi").innerHTML = `
      <div class="box"><b>${E}</b><div class="muted">Eligible members</div></div>
      <div class="box"><b>${need}</b><div class="muted">Need (green)</div></div>
      <div class="box"><b>${crowd}</b><div class="muted">Crowded (red)</div></div>
      <div class="box"><b>${shifts.length}</b><div class="muted">Shifts shown</div></div>
    `;

    $("statusText").textContent="Connected";
    $("statusPill").title="Loaded from Drive store.";
  }catch(e){
    console.error(e);
    $("statusText").textContent="Offline / no Drive";
    $("dot").classList.add("warn");
    $("statusPill").title=String(e?.message||e);
  }
}

$("btnRefresh").addEventListener("click", refresh);
$("qualFilter").addEventListener("change", refresh);
$("weeks").addEventListener("change", refresh);
refresh();
</script>
</body>
</html>
