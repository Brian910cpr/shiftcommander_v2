<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander — Member Availability</title>

<style>
:root{
  --bg:#0b1020;
  --card:#111a33;
  --line:rgba(255,255,255,.12);
  --text:#eaf1ff;
  --muted:rgba(234,241,255,.55);

  --pref:#2bd27e;
  --avail:#5c8dff;
  --no:#ff5d5d;
  --clear: rgba(255,255,255,.18); /* visible neutral */
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}

/* Header */
header{
  position:sticky;top:0;z-index:10;
  background:linear-gradient(180deg,#050814,#050814cc);
  border-bottom:1px solid var(--line);
  padding:10px 14px;
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}

header .pill{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:13px;
  white-space:nowrap;
  flex-shrink:0;
}

header select{
  min-width:220px;
  font-size:14px;
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:6px 8px;
}

/* Drive save pill (consistent pattern) */
.savePill{
  display:flex; align-items:center; gap:10px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  border-radius:999px;
  padding:6px 10px;
  min-height:34px;
  cursor: default;
  margin-left:auto;
}
.savePill .tiny{ font-size:12px; color: rgba(234,241,255,.70); min-width:0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

.dot{
  width:10px; height:10px; border-radius:999px;
  background: rgba(233,241,255,.26);
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.dot.ok{
  background:#2bd27e;
  box-shadow: 0 0 0 3px rgba(43,210,126,.16);
}
.dot.warn{
  background:#f4c542;
  box-shadow: 0 0 0 3px rgba(244,197,66,.16);
}

main{ padding:12px; }

/* MONTH LAYOUT */
.monthRow{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:12px;
  margin-bottom:12px;
}

.month{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px;
}

.month h3{
  margin:2px 0 6px;
  font-size:14px;
  font-weight:800;
  text-align:center;
}

.dow{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  font-size:10px;
  color:var(--muted);
  text-align:center;
  margin-bottom:4px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  align-content:start;
}

/* DAY CELLS — HARD LOCKED, NUMBER BESIDE PILLS */
.day{
  height:30px;                 /* smaller cell */
  border:1px solid var(--line);
  border-radius:10px;
  padding:3px 4px;
  display:flex;
  flex-direction:row;          /* number beside pills */
  align-items:center;
  gap:6px;
}

.day.blank{border:none;background:none}
.day.past{opacity:.35;pointer-events:none}

/* day number */
.dayNum{
  width:16px;
  text-align:right;
  font-size:11px;
  font-weight:900;
  line-height:1;
  cursor:pointer;
}

/* pill stack */
.bars{
  margin-top:0;
  display:flex;
  flex-direction:column;
  gap:3px;
  align-items:flex-start;
}

/* pills: thicker + half-length look */
.bar{
  position:relative;
  width:34px;                 /* gives real “pill” body */
  height:10px;                /* 150% bigger vibe */
  border-radius:999px;
  cursor:pointer;

  background: var(--clear);   /* visible neutral */
  border: 1px solid rgba(255,255,255,.25);

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:9px;
  font-weight:900;
  line-height:1;
  letter-spacing:0.2px;
  color: rgba(255,255,255,.80);
  user-select:none;
}
.bar::after{ content: attr(data-label); }

/* Explicit states */
.bar.pref{ background:var(--pref); border-color:var(--pref); }
.bar.avail{ background:var(--avail); border-color:var(--avail); }
.bar.no{ background:var(--no); border-color:var(--no); }

/* Make the text on colored fills readable */
.bar.pref, .bar.avail, .bar.no{ color: rgba(0,0,0,.70); }

/* Make clear state slightly quieter but still visible */
.bar:not(.pref):not(.avail):not(.no){ opacity:.75; }
</style>
</head>

<body>

<header>
  <div class="pill">Availability</div>

  <div class="pill">
    Member:
    <!-- IMPORTANT: option values should be stable member IDs -->
    <select id="member">
      <option value="203">Lynnsey Benson</option>
      <option value="brian">Brian Ennis</option>
    </select>
  </div>

  <div class="savePill" id="savepill" title="Checking…">
    <span class="dot warn" id="driveDot"></span>
    <span class="tiny" id="driveTip">Checking…</span>
  </div>
</header>

<main id="months"></main>

<script>
/* ===================== DRIVE STORE CONFIG (PUT IT HERE) ===================== */
const STORE = {
  url: "https://script.google.com/macros/s/AKfycbyHus2_cZOds7sCMxNlGzcJq0nEEtdZwS7JwKdlV-h0o_hctGCz1OpwANZ3nHLgOIa-ug/exec",
  token: "BC3BD023C58CB9B909CCDC6C8D4EDCE3EFFD1EC2BC2571F8A0D2B0F6974E6741"
};

/* ===================== CALENDAR CONFIG ===================== */
const MONTHS_AHEAD = 6;
const STATES = ["clear","pref","avail","no"];
const today = new Date();

/* In-memory state: dateISO -> { am, pm } */
const state = {}; // { "YYYY-MM-DD": {am:"clear|pref|avail|no", pm:"..."} }

/* Helpers */
const iso = d => d.toISOString().slice(0,10);
const cycle = s => STATES[(STATES.indexOf(s)+1)%STATES.length];
const isPast = isoDate => isoDate < iso(new Date());

function getActiveMemberId(){
  const sel = document.getElementById("member");
  return sel ? String(sel.value || "").trim() : "default";
}

/* ===================== STORE HELPERS (same style as your wallboard) ===================== */
async function storeGet(params){
  const u = new URL(STORE.url);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, String(v)));
  u.searchParams.set("token", STORE.token);
  const r = await fetch(u.toString(), { cache:"no-store" });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store GET failed");
  return j.payload;
}

async function storePut(body){
  const r = await fetch(STORE.url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ token: STORE.token, ...body })
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Store PUT failed");
  return j.payload;
}

/* ===================== SAVE PILL ===================== */
function setDrivePill({state, label, tooltip}){
  const dot = document.getElementById("driveDot");
  const tip = document.getElementById("driveTip");
  const pill = document.getElementById("savepill");
  if(!dot || !tip || !pill) return;

  dot.classList.remove("ok","warn");
  dot.classList.add(state === "ok" ? "ok" : "warn");

  tip.textContent = label;
  pill.title = tooltip || label;
}

/* ===================== AVAILABILITY PERSISTENCE (Local + Drive) ===================== */
const AV_KIND = "member_availability";
const LS_PREFIX = "sc:avail:";          // sc:avail:<memberId>
const LS_META_PREFIX = "sc:availmeta:"; // sc:availmeta:<memberId>

function nowISO(){ return new Date().toISOString(); }
function lsKey(memberId){ return LS_PREFIX + memberId; }
function lsMetaKey(memberId){ return LS_META_PREFIX + memberId; }

function getLocalPayload(memberId){
  try{
    const raw = localStorage.getItem(lsKey(memberId));
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function setLocalPayload(memberId, payload){
  localStorage.setItem(lsKey(memberId), JSON.stringify(payload));
}
function getMeta(memberId){
  try{
    const raw = localStorage.getItem(lsMetaKey(memberId));
    return raw ? JSON.parse(raw) : { dirty:false, lastPushISO:null, lastError:null };
  }catch(e){
    return { dirty:false, lastPushISO:null, lastError:null };
  }
}
function setMeta(memberId, meta){
  localStorage.setItem(lsMetaKey(memberId), JSON.stringify(meta));
}

function applyPayloadToState(payload){
  if(!payload || !payload.days) return;
  for(const [dateISO, v] of Object.entries(payload.days)){
    state[dateISO] ||= { am:"clear", pm:"clear" };
    if(v && typeof v === "object"){
      if(v.am) state[dateISO].am = v.am;
      if(v.pm) state[dateISO].pm = v.pm;
    }
  }
}

let syncTimer = null;

function markDirty(memberId){
  const meta = getMeta(memberId);
  meta.dirty = true;
  meta.lastError = null;
  setMeta(memberId, meta);

  setDrivePill({
    state:"warn",
    label:"Saving…",
    tooltip:"Changes saved locally. Syncing to Drive…"
  });
}

function scheduleSync(memberId){
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(()=> trySync(memberId), 600);
}

async function trySync(memberId){
  const meta = getMeta(memberId);
  if(!meta.dirty) return;

  // Always keep local current
  const payload = { updated_at: nowISO(), days: state };
  setLocalPayload(memberId, payload);

  if(!navigator.onLine){
    setDrivePill({
      state:"warn",
      label:"Saved locally",
      tooltip:"Offline. Your changes are saved on this device and will sync when you’re back online."
    });
    return;
  }

  try{
    await storePut({ kind: AV_KIND, member_id: memberId, payload });

    meta.dirty = false;
    meta.lastPushISO = nowISO();
    meta.lastError = null;
    setMeta(memberId, meta);

    setDrivePill({
      state:"ok",
      label:"Saved",
      tooltip:`Synced to Drive.\nLast sync: ${meta.lastPushISO}`
    });
  }catch(err){
    meta.lastError = String(err.message || err);
    setMeta(memberId, meta);
    setDrivePill({
      state:"warn",
      label:"Saved locally",
      tooltip:`Drive sync failed.\n${meta.lastError}\nYour changes are still saved on this device.`
    });
  }
}

function onAvailabilityChanged(){
  const memberId = getActiveMemberId();
  markDirty(memberId);
  scheduleSync(memberId);
}

async function loadAvailability(memberId){
  // 1) local first (instant)
  const local = getLocalPayload(memberId);
  if(local){
    applyPayloadToState(local);
    setDrivePill({ state:"warn", label:"Loaded", tooltip:"Loaded locally. Checking Drive…" });
  }else{
    setDrivePill({ state:"warn", label:"Checking…", tooltip:"Checking Drive for saved availability…" });
  }

  // 2) Drive (authoritative)
  try{
    const remote = await storeGet({ kind: AV_KIND, member_id: memberId });
    if(remote){
      applyPayloadToState(remote);
      setLocalPayload(memberId, remote);
      const meta = getMeta(memberId);
      meta.dirty = false;
      meta.lastPushISO = nowISO();
      meta.lastError = null;
      setMeta(memberId, meta);

      setDrivePill({ state:"ok", label:"Saved", tooltip:"Loaded from Drive and ready." });
    }else{
      setDrivePill({ state:"ok", label:"Saved", tooltip:"No Drive record yet — starting fresh." });
    }
  }catch(err){
    setDrivePill({
      state:"warn",
      label:"Local only",
      tooltip:`Couldn’t reach Drive.\n${err.message || err}\nWorking locally.`
    });
  }
}

window.addEventListener("online", ()=> trySync(getActiveMemberId()));

/* ===================== UI BUILD ===================== */
function build(){
  const wrap = document.getElementById("months");
  wrap.innerHTML="";

  let row;
  for(let i=0;i<MONTHS_AHEAD;i++){
    if(i%2===0){
      row=document.createElement("div");
      row.className="monthRow";
      wrap.appendChild(row);
    }
    row.appendChild(buildMonth(i));
  }
}

function buildMonth(offset){
  const d = new Date(today.getFullYear(), today.getMonth()+offset,1);
  const m = d.getMonth(), y=d.getFullYear();
  const month = document.createElement("div");
  month.className="month";

  month.innerHTML = `
    <h3>${d.toLocaleString(undefined,{month:"long",year:"numeric"})}</h3>
    <div class="dow">${["S","M","T","W","T","F","S"].map(x=>`<div>${x}</div>`).join("")}</div>
    <div class="grid"></div>
  `;

  const grid = month.querySelector(".grid");
  const start = new Date(y,m,1).getDay();
  const days = new Date(y,m+1,0).getDate();

  for(let i=0;i<start;i++) grid.appendChild(blank());

  for(let day=1;day<=days;day++){
    const dateISO = iso(new Date(y,m,day));
    grid.appendChild(dayCell(dateISO,day));
  }

  return month;
}

function blank(){
  const d=document.createElement("div");
  d.className="day blank";
  return d;
}

function dayCell(dateISO,day){
  state[dateISO] ||= {am:"clear",pm:"clear"};

  const d=document.createElement("div");
  d.className="day";
  if(isPast(dateISO)) d.classList.add("past");

  const num=document.createElement("div");
  num.className="dayNum";
  num.textContent=day;

  // Clicking the number sets BOTH AM and PM (your "24" shortcut)
  num.onclick=()=>{
    const next = cycle(state[dateISO].am);
    state[dateISO].am = next;
    state[dateISO].pm = next;
    render();
    onAvailabilityChanged();
  };

  const bars=document.createElement("div");
  bars.className="bars";

  const am=bar(()=>{
    state[dateISO].am=cycle(state[dateISO].am);
    render();
    onAvailabilityChanged();
  },"AM");

  const pm=bar(()=>{
    state[dateISO].pm=cycle(state[dateISO].pm);
    render();
    onAvailabilityChanged();
  },"PM");

  bars.append(am,pm);
  d.append(num,bars);

  function render(){
    am.className=`bar ${state[dateISO].am}`;
    pm.className=`bar ${state[dateISO].pm}`;
  }
  render();
  return d;
}

function bar(fn, label){
  const b=document.createElement("div");
  b.className="bar";
  b.dataset.label = label; // AM / PM
  b.onclick=fn;
  return b;
}

/* ===================== STARTUP ===================== */
build();
loadAvailability(getActiveMemberId());

document.getElementById("member")?.addEventListener("change", async ()=>{
  // wipe current in-memory state, rebuild, then load for new member
  for(const k of Object.keys(state)) delete state[k];
  build();
  await loadAvailability(getActiveMemberId());
});
</script>

</body>
</html>
