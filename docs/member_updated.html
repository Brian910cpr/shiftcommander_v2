<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Member - Seat-Aware (Beta)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
  h1 { margin-bottom: 8px; }
  .muted { color:#666; }
  .panel { border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:12px; }
  .row { display:flex; gap:8px; align-items:center; }
  .seat { padding:8px 10px; border-radius:6px; border:1px solid #ccc; margin:6px 0; }
  .seat.ok { background:#e8f6ee; border-color:#9bd0b0; }
  .seat.blocked { background:#f3f3f3; color:#888; }
  .seat.warn { background:#fff7e6; border-color:#f0c36d; }
  .badge { display:inline-block; padding:2px 6px; border-radius:10px; font-size:12px; margin-left:6px; }
  .b-ok { background:#c7ead7; }
  .b-warn { background:#ffe0a3; }
  .b-no { background:#ddd; }
  select, button { padding:6px 8px; }
</style>
</head>
<body>

<h1>Member</h1>
<p class="muted">Seat-aware member view (Beta). Greyed seats exist but you are not eligible for them.</p>

<div class="panel">
  <div class="row">
    <strong>Shift:</strong>
    <select id="shiftSel">
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
    <strong>Unit:</strong>
    <select id="unitSel"></select>
  </div>
</div>

<div class="panel">
  <strong>Available Seats</strong>
  <div id="seats"></div>
</div>

<script>
async function loadUnits(){
  return window.UNITS || [
    { id:"A120", label:"Ambulance 120", seat_plan_id:"plan_ambulance_standard", operator_qual_key:"qual_driver_120" },
    { id:"T128", label:"Tanker 128", seat_plan_id:"plan_tanker_standard", operator_qual_key:"qual_driver_128" }
  ];
}
async function loadSeatPlans(){
  return window.SEAT_PLANS || {
    plan_ambulance_standard: [
      { id:"op", label:"Operator", require_all:["EMT","UNIT_OPERATOR_QUAL"], required:true },
      { id:"att", label:"Attendant", require_any:["AEMT","MEDIC","EMT"], required:true },
      { id:"r3", label:"3rd Rider", require_any:["STUDENT_BLS","STUDENT_ALS"], depends_on:["FTO_BLS","FTO_ALS"], required:false }
    ],
    plan_tanker_standard: [
      { id:"op", label:"Operator", require_all:["EMT","UNIT_OPERATOR_QUAL"], required:true },
      { id:"off", label:"Officer", require_all:["qual_officer"], required:false },
      { id:"ff", label:"Firefighter", require_any:["EMT","EMR"], required:false }
    ]
  };
}
async function loadMember(){
  return window.MEMBER || { name:"Member", quals:["EMT","qual_driver_120"] };
}
function expandReq(req, unit){ return req === "UNIT_OPERATOR_QUAL" ? unit.operator_qual_key : req; }
function hasAll(member, arr){ return arr.every(k => member.quals.includes(k)); }
function hasAny(member, arr){ return arr.some(k => member.quals.includes(k)); }

(async function init(){
  const units = await loadUnits();
  const plans = await loadSeatPlans();
  const member = await loadMember();
  const unitSel = document.getElementById('unitSel');
  units.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.label; unitSel.appendChild(o); });

  function render(){
    const unit = units.find(u=>u.id===unitSel.value) || units[0];
    const seatsDiv = document.getElementById('seats'); seatsDiv.innerHTML='';
    const seats = plans[unit.seat_plan_id] || [];
    seats.forEach(seat=>{
      let ok=true, warn=false, why=[];
      if(seat.require_all){
        const reqs = seat.require_all.map(r=>expandReq(r,unit));
        if(!hasAll(member, reqs)){ ok=false; why.push("Missing: "+reqs.filter(r=>!member.quals.includes(r)).join(", ")); }
      }
      if(seat.require_any && !hasAny(member, seat.require_any)){
        ok=false; why.push("Needs one of: "+seat.require_any.join(", "));
      }
      if(seat.depends_on){ warn=true; why.push("Requires FTO present ("+seat.depends_on.join(" or ")+")"); }
      const div=document.createElement('div');
      div.className='seat '+(ok?'ok':'blocked')+(warn?' warn':'');
      div.innerHTML = '<strong>'+seat.label+'</strong>'
        +(seat.required?'<span class="badge b-ok">Required</span>':'')
        +(warn?'<span class="badge b-warn">Dependency</span>':'')
        +(!ok?'<span class="badge b-no">Not eligible</span>':'')
        +'<div class="muted">'+why.join(' Â· ')+'</div>';
      seatsDiv.appendChild(div);
    });
  }
  unitSel.addEventListener('change', render);
  render();
})();
</script>

</body>
</html>
