<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftCommander ‚Äî My Availability</title>
  <style>
    :root{
      --bg:#08131d;
      --card:#0d1b28;
      --ink:#e9f1ff;
      --muted:#a7b6cc;
      --line:rgba(255,255,255,.12);
      --good:#28d17c;
      --warn:#f2c94c;
      --need:#5dade2;
      --bad:#ff5a67;
      --tab:#0b1622;
      --tabOn:#12304a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 600px at 25% 10%, rgba(58,160,255,.12), transparent 55%),
                  radial-gradient(900px 600px at 75% 20%, rgba(40,209,124,.10), transparent 60%),
                  linear-gradient(180deg, #070f17, var(--bg));
      color:var(--ink);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0 0 6px;font-size:18px;letter-spacing:.02em}
    .sub{color:var(--muted);margin:0 0 14px}

    .bar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      padding:12px;border:1px solid var(--line);border-radius:16px;
      background: rgba(255,255,255,.04);
      margin-bottom:12px;
    }
    input{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--ink);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-weight:800;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.good{border-color: rgba(40,209,124,.45)}
    .btn.bad{border-color: rgba(255,90,103,.45)}
    .tiny{font-size:12px;color:var(--muted)}
    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .tag{border:1px solid rgba(255,255,255,.14);background: rgba(0,0,0,.18);padding:6px 10px;border-radius:999px;font-weight:900}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      margin: 0 0 10px;
    }
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      font-weight:1000;
    }
    .tab.on{
      background: rgba(18,48,74,.55);
      border-color: rgba(58,160,255,.40);
    }

    /* Calendar grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(150px, 1fr));
      gap:8px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(2, minmax(160px, 1fr));} }
    @media (max-width:680px){ .grid{grid-template-columns: 1fr;} }

    .day{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px;
      min-height:120px;
    }
    .day .hdr{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px}
    .dow{font-size:12px;letter-spacing:.12em;color:var(--muted);text-transform:uppercase;font-weight:900}
    .date{font-weight:1100}
    .icons{display:flex;gap:6px;color:var(--muted)}
    .slots{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .slotRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .slotLbl{color:var(--muted);font-weight:1000;width:28px}
    .pill{
      flex:1;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding:8px 10px;border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .pill .state{display:flex;align-items:center;gap:8px}
    .pill .emoji{font-size:16px}
    .pill .txt{font-size:12px;color:var(--muted);font-weight:900}
    .pill.preferred{border-color: rgba(40,209,124,.50)}
    .pill.available{border-color: rgba(242,201,76,.55)}
    .pill.ifneeded{border-color: rgba(93,173,226,.55)}
    .pill.notavail{border-color: rgba(255,90,103,.55)}
    .pill.locked{opacity:.55; cursor:not-allowed}
    .mutedDay{opacity:.35}

    /* Template grid */
    .tmplWrap{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
    }
    .tmplGrid{
      display:grid;
      grid-template-columns: 80px repeat(7, minmax(120px, 1fr));
      gap:8px;
      align-items:stretch;
    }
    @media (max-width:1100px){
      .tmplGrid{grid-template-columns: 80px repeat(2, minmax(160px, 1fr));}
    }
    @media (max-width:680px){
      .tmplGrid{grid-template-columns: 1fr;}
    }
    .cellHdr{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:12px;
      padding:10px;
      font-weight:1100;
      color: var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
    }
    .rowHdr{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:12px;
      padding:10px;
      font-weight:1100;
      color: var(--muted);
      display:flex;align-items:center;justify-content:center;
    }
    .tmplCell{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      font-weight:1100;
    }
    .tmplCell .left{display:flex;align-items:center;gap:10px}
    .tmplCell .emoji{font-size:16px}
    .tmplCell .label{color:var(--muted);font-size:12px;font-weight:900}
    .tmplCell.preferred{border-color: rgba(40,209,124,.50)}
    .tmplCell.available{border-color: rgba(242,201,76,.55)}
    .tmplCell.ifneeded{border-color: rgba(93,173,226,.55)}
    .tmplCell.notavail{border-color: rgba(255,90,103,.55)}
    .split{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px
    }
    .panel{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
      flex:1;
      min-width:280px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ShiftCommander ‚Äî My Availability</h1>
  <div class="sub">Use the template for your routine. Use the calendar for exceptions. Pills cycle: ‚≠ê ‚Üí ‚úÖ ‚Üí üü¶ ‚Üí ‚ùå ‚Üí ‚¨ú.</div>

  <div class="bar">
    <div>
      <div class="tiny">Member</div>
      <input id="member" type="text" placeholder="First Last (or First)" style="min-width:260px" />
    </div>

    <div>
      <div class="tiny">Month</div>
      <input id="month" type="month" />
    </div>

    <label class="tag" style="display:flex;align-items:center;gap:8px;">
      <input id="prefer24" type="checkbox" />
      Prefer 24s (‚≠ê sets both AM+PM)
    </label>

    <button class="btn good" id="btnSave">Save</button>
    <button class="btn" id="btnExport">Export JSON</button>
    <button class="btn bad" id="btnClearMonth">Clear Month</button>

    <div class="legend tiny" style="margin-left:auto">
      <span class="tag">‚≠ê Preferred</span>
      <span class="tag">‚úÖ Available</span>
      <span class="tag">üü¶ If Needed</span>
      <span class="tag">‚ùå Not Avail</span>
      <span class="tag">‚¨ú Unset</span>
      <span class="tag">üîí Locked</span>
      <span class="tag">üóÑÔ∏è Archived</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab on" id="tabCalendar">Calendar (Overrides)</div>
    <div class="tab" id="tabTemplate">Weekly Template (Routine)</div>
  </div>

  <!-- Calendar View -->
  <div id="viewCalendar">
    <div id="grid" class="grid"></div>
    <div class="tiny" style="margin-top:10px;">
      Locks/archives are placeholders right now ‚Äî supervisor ops will control them.
    </div>
  </div>

  <!-- Template View -->
  <div id="viewTemplate" style="display:none;">
    <div class="tmplWrap">
      <div class="tiny" style="margin-bottom:10px;">
        Set your routine pattern here. Then ‚ÄúApply template to month‚Äù to stamp it into the calendar (future weeks).
      </div>

      <div id="tmplGrid" class="tmplGrid"></div>

      <div class="split">
        <div class="panel">
          <div style="font-weight:1100;margin-bottom:6px;">Apply Template to Month</div>
          <div class="tiny" style="margin-bottom:10px;">
            Choose whether to only fill blanks (recommended) or overwrite existing month entries.
          </div>

          <label class="tag" style="display:inline-flex;align-items:center;gap:8px;margin-bottom:10px;">
            <input id="applyOverwrite" type="checkbox" />
            Overwrite existing month entries
          </label>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn good" id="btnApplyTemplate">Apply template to month</button>
            <button class="btn bad" id="btnClearTemplate">Clear template</button>
          </div>

          <div class="tiny" style="margin-top:10px;">
            Tip: leave overwrite OFF. Use calendar view for exceptions.
          </div>
        </div>

        <div class="panel">
          <div style="font-weight:1100;margin-bottom:6px;">What this means</div>
          <div class="tiny">
            Template = your ‚Äúdefault week.‚Äù Calendar = date-specific overrides.
            When the solver runs for far-future weeks, it can start from template defaults and then honor overrides.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/**
 * Storage model (local for now):
 * - Month availability (per member+month): sc_avail_v1::<memberId>::YYYY-MM
 * - Weekly template (per member):          sc_template_v1::<memberId>
 *
 * Later: move both to API storage (Cloudflare Worker/D1) so it works on phones & tablets.
 */

const STATES = ["", "preferred", "available", "ifneeded", "notavail"];
const META = {
  "":         { emoji:"‚¨ú", label:"Unset" },
  preferred:  { emoji:"‚≠ê", label:"Preferred" },
  available:  { emoji:"‚úÖ", label:"Available" },
  ifneeded:   { emoji:"üü¶", label:"If Needed" },
  notavail:   { emoji:"‚ùå", label:"Not Avail" },
};

const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

function pad(n){ return String(n).padStart(2,"0"); }
function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function monthKey(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; }
function uidFromName(name){
  return name.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"").slice(0,40) || ("m_" + Date.now());
}
function storageKeyAvail(memberId, ym){ return `sc_avail_v1::${memberId}::${ym}`; }
function storageKeyTemplate(memberId){ return `sc_template_v1::${memberId}`; }

function loadJSON(key){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }catch{ return null; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj, null, 2));
}
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function cycleState(current){
  const i = STATES.indexOf(current || "");
  return STATES[(i+1) % STATES.length];
}

function getMonthDates(ym){
  const [Y,M] = ym.split("-").map(Number);
  const first = new Date(Y, M-1, 1);
  const last = new Date(Y, M, 0);
  const days = [];
  for(let d = new Date(first); d <= last; d.setDate(d.getDate()+1)){
    days.push(new Date(d));
  }
  return days;
}

// Placeholder lock/archive maps (later from API)
const LOCKED = new Set();   // e.g., "2025-12-16|AM"
const UI = {
  member: document.getElementById("member"),
  month: document.getElementById("month"),
  prefer24: document.getElementById("prefer24"),

  tabCalendar: document.getElementById("tabCalendar"),
  tabTemplate: document.getElementById("tabTemplate"),
  viewCalendar: document.getElementById("viewCalendar"),
  viewTemplate: document.getElementById("viewTemplate"),

  grid: document.getElementById("grid"),

  tmplGrid: document.getElementById("tmplGrid"),
  applyOverwrite: document.getElementById("applyOverwrite"),
  btnApplyTemplate: document.getElementById("btnApplyTemplate"),
  btnClearTemplate: document.getElementById("btnClearTemplate"),

  btnSave: document.getElementById("btnSave"),
  btnExport: document.getElementById("btnExport"),
  btnClearMonth: document.getElementById("btnClearMonth"),
};

function getOrInitAvail(memberName, ym){
  const memberId = uidFromName(memberName);
  const key = storageKeyAvail(memberId, ym);
  let doc = loadJSON(key);
  if(!doc){
    doc = { schema:"ShiftCommander.Availability.v1", month: ym, member:{id:memberId, name:memberName}, days:{} };
  }else{
    doc.member = doc.member || {id:memberId, name:memberName};
    doc.member.name = memberName;
  }
  return { memberId, key, doc };
}

function getOrInitTemplate(memberName){
  const memberId = uidFromName(memberName);
  const key = storageKeyTemplate(memberId);
  let doc = loadJSON(key);
  if(!doc){
    doc = {
      schema:"ShiftCommander.WeeklyTemplate.v1",
      member:{id:memberId, name:memberName},
      // keys: Sun..Sat -> { AM, PM }
      week: {
        Sun:{AM:"",PM:""}, Mon:{AM:"",PM:""}, Tue:{AM:"",PM:""}, Wed:{AM:"",PM:""},
        Thu:{AM:"",PM:""}, Fri:{AM:"",PM:""}, Sat:{AM:"",PM:""}
      }
    };
  }else{
    doc.member = doc.member || {id:memberId, name:memberName};
    doc.member.name = memberName;
  }
  return { memberId, key, doc };
}

function setTab(which){
  const onCal = (which === "calendar");
  UI.tabCalendar.classList.toggle("on", onCal);
  UI.tabTemplate.classList.toggle("on", !onCal);
  UI.viewCalendar.style.display = onCal ? "" : "none";
  UI.viewTemplate.style.display = onCal ? "none" : "";
  renderAll();
}

function renderAll(){
  renderCalendar();
  renderTemplate();
}

function renderCalendar(){
  const memberName = UI.member.value.trim();
  const ym = UI.month.value;
  UI.grid.innerHTML = "";

  if(!memberName || !ym){
    UI.grid.innerHTML = `<div class="tiny">Enter your name and pick a month.</div>`;
    return;
  }

  const { memberId, key, doc } = getOrInitAvail(memberName, ym);

  const days = getMonthDates(ym);
  const todayISO = toISODate(new Date());

  // calendar-ish blanks until first weekday
  const firstDow = days[0].getDay();
  for(let i=0;i<firstDow;i++){
    const blank = document.createElement("div");
    blank.className = "day mutedDay";
    blank.innerHTML = `<div class="hdr"><div><div class="dow">‚Äî</div><div class="date"> </div></div></div>`;
    UI.grid.appendChild(blank);
  }

  for(const d of days){
    const iso = toISODate(d);
    if(!doc.days[iso]) doc.days[iso] = { AM:"", PM:"" };

    const amState = doc.days[iso].AM || "";
    const pmState = doc.days[iso].PM || "";

    const card = document.createElement("div");
    card.className = "day";

    const isPast = iso < todayISO;

    card.innerHTML = `
      <div class="hdr">
        <div>
          <div class="dow">${DOW[d.getDay()]}</div>
          <div class="date">${iso}</div>
        </div>
        <div class="icons">
          ${isPast ? "üóÑÔ∏è" : ""}
        </div>
      </div>

      <div class="slots">
        ${slotRowHtml(iso, "AM", amState)}
        ${slotRowHtml(iso, "PM", pmState)}
      </div>
    `;

    card.querySelectorAll(".pill[data-date]").forEach(pill => {
      pill.addEventListener("click", () => {
        const date = pill.getAttribute("data-date");
        const slot = pill.getAttribute("data-slot");
        const lockKey = `${date}|${slot}`;
        if(LOCKED.has(lockKey)) return;

        const { memberId, key, doc } = getOrInitAvail(UI.member.value.trim(), UI.month.value);
        const current = doc.days?.[date]?.[slot] || "";
        const next = cycleState(current);

        doc.days[date][slot] = next;

        // Prefer 24s convenience: ‚≠ê on one sets both
        if(UI.prefer24.checked && next === "preferred"){
          const other = (slot === "AM") ? "PM" : "AM";
          if(!LOCKED.has(`${date}|${other}`)) doc.days[date][other] = "preferred";
        }

        saveJSON(key, doc);
        renderCalendar();
      });
    });

    UI.grid.appendChild(card);
  }

  // persist initialized days
  saveJSON(key, doc);
}

function slotRowHtml(dateISO, slot, state){
  const meta = META[state || ""];
  const locked = LOCKED.has(`${dateISO}|${slot}`);
  const cls = ["pill", state || "", locked ? "locked" : ""].filter(Boolean).join(" ");
  const lockIcon = locked ? "üîí" : "";
  return `
    <div class="slotRow">
      <div class="slotLbl">${slot}</div>
      <div class="${cls}" data-date="${dateISO}" data-slot="${slot}">
        <div class="state"><span class="emoji">${meta.emoji}</span><span>${meta.label}</span></div>
        <div class="txt">${lockIcon}</div>
      </div>
    </div>
  `;
}

function renderTemplate(){
  const memberName = UI.member.value.trim();
  UI.tmplGrid.innerHTML = "";

  if(!memberName){
    UI.tmplGrid.innerHTML = `<div class="tiny">Enter your name first.</div>`;
    return;
  }

  const { key, doc } = getOrInitTemplate(memberName);
  const week = doc.week;

  // Header row: blank + Sun..Sat
  const headBlank = document.createElement("div");
  headBlank.className = "cellHdr";
  headBlank.textContent = " ";
  UI.tmplGrid.appendChild(headBlank);

  for(const day of ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]){
    const h = document.createElement("div");
    h.className = "cellHdr";
    h.textContent = day;
    UI.tmplGrid.appendChild(h);
  }

  // Rows AM / PM
  for(const slot of ["AM","PM"]){
    const r = document.createElement("div");
    r.className = "rowHdr";
    r.textContent = slot;
    UI.tmplGrid.appendChild(r);

    for(const day of ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]){
      const state = week?.[day]?.[slot] || "";
      const meta = META[state];
      const cell = document.createElement("div");
      cell.className = ["tmplCell", state || ""].filter(Boolean).join(" ");
      cell.innerHTML = `
        <div class="left">
          <span class="emoji">${meta.emoji}</span>
          <span>${meta.label}</span>
        </div>
        <div class="label">${day} ${slot}</div>
      `;
      cell.addEventListener("click", () => {
        const { key, doc } = getOrInitTemplate(UI.member.value.trim());
        const cur = doc.week?.[day]?.[slot] || "";
        const next = cycleState(cur);
        doc.week[day][slot] = next;

        // Prefer 24s convenience: if ‚≠ê in template, set both AM+PM that day
        if(UI.prefer24.checked && next === "preferred"){
          const other = (slot === "AM") ? "PM" : "AM";
          doc.week[day][other] = "preferred";
        }

        saveJSON(key, doc);
        renderTemplate();
      });

      UI.tmplGrid.appendChild(cell);
    }
  }

  saveJSON(key, doc);
}

function applyTemplateToMonth(){
  const memberName = UI.member.value.trim();
  const ym = UI.month.value;
  if(!memberName || !ym){
    alert("Enter your name and pick a month first.");
    return;
  }

  const overwrite = UI.applyOverwrite.checked;

  const tmpl = getOrInitTemplate(memberName);
  const avail = getOrInitAvail(memberName, ym);

  const week = tmpl.doc.week;
  const days = getMonthDates(ym);

  for(const d of days){
    const iso = toISODate(d);
    const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];

    if(!avail.doc.days[iso]) avail.doc.days[iso] = { AM:"", PM:"" };

    for(const slot of ["AM","PM"]){
      const templState = week?.[dow]?.[slot] || "";
      if(!templState) continue; // only apply non-empty template entries

      const current = avail.doc.days[iso][slot] || "";

      if(overwrite || !current){
        // don‚Äôt apply into locked entries (future supervisor policy)
        if(LOCKED.has(`${iso}|${slot}`)) continue;
        avail.doc.days[iso][slot] = templState;
      }
    }
  }

  saveJSON(avail.key, avail.doc);
  alert(overwrite ? "Template applied (overwrote month)." : "Template applied (filled blanks only).");
  setTab("calendar");
}

function clearTemplate(){
  const memberName = UI.member.value.trim();
  if(!memberName){ alert("Enter your name first."); return; }
  if(!confirm("Clear weekly template (routine) for this member?")) return;

  const { memberId } = getOrInitTemplate(memberName);
  localStorage.removeItem(storageKeyTemplate(memberId));
  renderTemplate();
}

UI.btnSave.addEventListener("click", () => {
  const name = UI.member.value.trim();
  const ym = UI.month.value;
  if(!name || !ym){ alert("Enter name and pick month."); return; }
  const avail = getOrInitAvail(name, ym);
  saveJSON(avail.key, avail.doc);

  const tmpl = getOrInitTemplate(name);
  saveJSON(tmpl.key, tmpl.doc);

  alert("Saved.");
});

UI.btnExport.addEventListener("click", () => {
  const name = UI.member.value.trim();
  const ym = UI.month.value;
  if(!name || !ym){ alert("Enter name and pick month."); return; }
  const avail = getOrInitAvail(name, ym);
  const tmpl = getOrInitTemplate(name);

  downloadJson(`availability_${avail.memberId}_${ym}.json`, avail.doc);
  downloadJson(`template_${tmpl.memberId}.json`, tmpl.doc);
});

UI.btnClearMonth.addEventListener("click", () => {
  const name = UI.member.value.trim();
  const ym = UI.month.value;
  if(!name || !ym) return;
  const memberId = uidFromName(name);
  if(!confirm(`Clear all month entries for ${name} in ${ym}?`)) return;
  localStorage.removeItem(storageKeyAvail(memberId, ym));
  renderCalendar();
});

UI.btnApplyTemplate.addEventListener("click", applyTemplateToMonth);
UI.btnClearTemplate.addEventListener("click", clearTemplate);

UI.tabCalendar.addEventListener("click", () => setTab("calendar"));
UI.tabTemplate.addEventListener("click", () => setTab("template"));

(function init(){
  const now = new Date();
  UI.month.value = monthKey(now);
  UI.member.addEventListener("input", renderAll);
  UI.month.addEventListener("change", renderAll);
  UI.prefer24.addEventListener("change", renderAll);
  renderAll();
})();
</script>
</body>
</html>
